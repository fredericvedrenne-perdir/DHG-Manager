<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DHG Manager V8</title>
    	    <link rel="icon" type="image/png" href="data:image/png;base64,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">

    <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>

    <style>
        :root { 
            --primary: #2c3e50; --secondary: #3498db; --accent: #e67e22; 
            --success: #27ae60; --danger: #c0392b; --light: #ecf0f1; --dark: #34495e;
            --hp-color: #3498db; --hsa-color: #e67e22; --weight: #8e44ad;
            --supp-bg: #e8f8f5; --supp-border: #1abc9c;
        }
        body { font-family: 'Segoe UI', system-ui, sans-serif; margin: 0; background-color: #f4f6f9; height: 100vh; display: flex; overflow: hidden; color: #333; }
        
        /* SIDEBAR */
        .sidebar { width: 260px; background-color: var(--primary); color: white; display: flex; flex-direction: column; padding-top: 20px; flex-shrink: 0; box-shadow: 2px 0 10px rgba(0,0,0,0.1); }
        .sidebar h2 { text-align: center; margin: 0 0 5px 0; font-size: 1.5rem; font-weight: 700; letter-spacing: 0.5px; }
        .sidebar-subtitle { text-align: center; font-size: 0.85rem; color: #bdc3c7; margin-bottom: 30px; font-style: italic; opacity: 0.8; }
        .menu-item { background: none; border: none; width: 100%; text-align: left; padding: 15px 25px; color: #bdc3c7; cursor: pointer; transition: 0.2s; border-left: 4px solid transparent; font-size: 0.95rem; font-weight: 500; }
        .menu-item:hover { color: white; background: rgba(255,255,255,0.05); }
        .menu-item.active { background-color: var(--secondary); color: white; border-left: 4px solid white; }
        
        /* CONTENT */
        .content { flex-grow: 1; padding: 30px; overflow-y: auto; background-color: #f8f9fa; position: relative; }
        .section { display: none; animation: fadeIn 0.3s ease-out; }
        .section.active { display: block; }
        
        /* SETUP MODAL */
        #setup-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(44, 62, 80, 0.95); z-index: 9999;
            display: flex; justify-content: center; align-items: center;
        }
        .setup-box {
            background: white; padding: 40px; border-radius: 10px; text-align: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2); max-width: 650px; width: 90%;
        }
        .setup-options { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top: 30px; }
        .setup-btn {
            padding: 20px 10px; border: 2px solid #eee; border-radius: 8px; background: #f8f9fa;
            cursor: pointer; transition: 0.2s; font-weight: bold; color: var(--primary); display:flex; flex-direction:column; align-items:center;
        }
        .setup-btn:hover { border-color: var(--secondary); background: #ebf5fb; transform: translateY(-3px); }
        .setup-icon { font-size: 2.5rem; display: block; margin-bottom: 10px; }

        /* CARDS */
        .card { background: white; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.04); padding: 25px; margin-bottom: 25px; border: 1px solid #e9ecef; }
        .card-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #f1f2f6; padding-bottom: 15px; margin-bottom: 20px; flex-wrap: wrap; gap: 10px; }
        .card h3 { margin: 0; color: var(--primary); font-size: 1.2rem; font-weight: 600; }
        
        /* BUTTONS */
        .btn { padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 0.9rem; display: inline-flex; align-items: center; gap: 6px; color: white; transition: 0.2s; }
        .btn-primary { background-color: var(--secondary); }
        .btn-success { background-color: var(--success); }
        .btn-danger { background-color: var(--danger); }
        .btn-warning { background-color: var(--accent); }
        .btn-purple { background-color: var(--weight); }
        .btn-dark { background-color: var(--dark); }
        .btn-sm { padding: 4px 10px; font-size: 0.8rem; }
        .export-group { display: flex; gap: 5px; }
        .btn-exp { background: #95a5a6; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 0.8rem; font-weight: bold; display: flex; align-items: center; gap: 5px; }
        .btn-exp:hover { background: #7f8c8d; }
        .btn-outline { background:transparent; border:1px solid #bdc3c7; color:#7f8c8d; }
        .btn-outline:hover, .btn-outline.active { background:#bdc3c7; color:white; }

        /* TABLES */
        table { width: 100%; border-collapse: separate; border-spacing: 0; font-size: 0.9rem; margin-top: 10px; }
        th, td { padding: 8px; border-bottom: 1px solid #eee; text-align: center; vertical-align: middle; }
        th { background: #f8f9fa; font-weight: 600; color: #636e72; position: sticky; top: 0; z-index: 5; border-top: 1px solid #eee; }
        td { border-left: 1px solid #eee; }
        td:last-child { border-right: 1px solid #eee; }
        tr:hover td { background-color: #fafafa; }
        .structure-total-row td { background-color: var(--primary) !important; color: white; font-weight: bold; font-size: 1rem; border-top: 2px solid var(--secondary); }
        
        /* LIGNE MOYENS SUPPLEMENTAIRES */
        .row-supp { background-color: var(--supp-bg); border-top: 2px solid var(--supp-border); border-bottom: 2px solid var(--supp-border); }
        .row-supp td { color: #16a085; font-weight: 600; vertical-align: middle; border-color: #d1f2eb; }
        .input-supp { width: 80px !important; text-align: center; font-weight: bold; border: 2px solid #1abc9c; color: #16a085; background: white; padding: 6px; border-radius: 4px; font-size: 1rem; }
        .supp-label-group { display: flex; align-items: center; justify-content: center; gap: 5px; font-size: 0.85rem; }

        /* GRILLE TABLEUR VERTICAL */
        .grid-wrapper { overflow-x: auto; background: white; border: 1px solid #dfe6e9; padding: 0; box-shadow: 0 4px 6px rgba(0,0,0,0.02); margin-bottom: 30px; }
        .th-class { width: 60px; min-width: 60px; text-align: center; font-weight: bold; }
        .th-vertical { height: 190px; vertical-align: bottom; padding: 0; width: 45px; position: relative; }
        
        .th-text-wrapper { 
            writing-mode: vertical-rl; 
            transform: rotate(180deg); 
            white-space: nowrap; 
            text-align: center;
            margin: 0 auto; 
            padding-top: 10px; 
            height: 140px; 
            display: flex; 
            align-items: center; 
            justify-content: center;
            width: 100%;
            font-weight: 700; 
            color: #2c3e50; 
        }
        .th-code { font-size:0.7rem; color:#7f8c8d; display:block; height:20px; margin-top:5px; font-weight:normal; }
        .class-name-btn { background:none; border:none; border-bottom:1px dashed #3498db; color:#2c3e50; font-weight:bold; cursor:pointer; font-size:0.95rem; }
        .class-name-btn:hover { color:var(--secondary); border-bottom-style:solid; }
        
        /* RH HIERARCHIE */
        .row-master { background-color: #ecf0f1; font-weight: bold; }
        .row-master td { border-top: 2px solid #bdc3c7; color: #2c3e50; }
        .row-sub-master { background-color: #f4f6f7; font-weight: 600; }
        .row-detail { background-color: white; }
        .input-inline { width: 60px !important; padding: 4px !important; text-align: center; border: 1px solid #dfe6e9; background: white; font-weight: bold; }
        .btn-add-subject-teacher { background: var(--success); color: white; border: none; border-radius: 50%; width: 24px; height: 24px; font-size: 14px; font-weight: bold; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; margin-left: 10px; transition: 0.2s; }
        .sub-info { font-size: 0.8rem; color: #7f8c8d; font-weight: normal; margin-left: 10px; font-style: italic; }
        .col-code { background-color: #f8f9fa; font-family: monospace; font-size: 0.85rem; color: #555; }

        /* KPI */
        .kpi-container { display: grid; grid-template-columns: repeat(5, 1fr); gap: 15px; margin-bottom: 25px; }
        .kpi-box { background: white; padding: 20px 10px; border-radius: 8px; border-left: 5px solid #ccc; box-shadow: 0 2px 5px rgba(0,0,0,0.05); position:relative; overflow: hidden; }
        .kpi-title { font-size: 0.9rem; color: #7f8c8d; font-weight: bold; text-transform: uppercase; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .kpi-value { font-size: 1.6rem; font-weight: 700; color: #2c3e50; margin-top: 8px; }
        .dotation-display { font-size: 1.8rem; font-weight: bold; color: var(--primary); margin-bottom: 15px; padding: 5px 0; border-bottom: 2px solid #eee; display: block; }

        /* TOGGLE */
        .toggle-container { display: flex; background-color: #e0e0e0; border-radius: 30px; padding: 4px; width: fit-content; box-shadow: inset 0 2px 4px rgba(0,0,0,0.1); }
        .toggle-btn { border: none; background: transparent; padding: 8px 24px; border-radius: 25px; cursor: pointer; font-weight: 600; color: #7f8c8d; transition: all 0.3s; display: flex; align-items: center; gap: 8px; }
        .toggle-btn.active { background-color: var(--secondary); color: white; box-shadow: 0 4px 6px rgba(52, 152, 219, 0.3); }

        /* TABS */
        .tab-container { display: flex; gap: 5px; border-bottom: 2px solid #dfe6e9; }
        .tab { padding: 10px 20px; background: #e9ecef; border-radius: 6px 6px 0 0; cursor: pointer; font-weight: bold; color: #636e72; border: 1px solid #dfe6e9; border-bottom: none; }
        .tab.active { background: white; color: var(--secondary); border-top: 3px solid var(--secondary); margin-bottom: -2px; padding-bottom: 12px; z-index: 10; }
        .tab.global-tab { color: #8e44ad; } 
        .tab.global-tab.active { border-top-color: #8e44ad; color: #8e44ad; }

        /* INPUTS */
        input[type="number"], input[type="text"], select { width: 100%; padding: 6px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .inp-hours, .inp-marge, .inp-coef { width: 38px !important; text-align: center; font-weight: bold; padding: 3px; height: 22px; border-radius: 2px; font-size: 0.85rem; }
        .inp-hours { border: 1px solid #bdc3c7; }
        .inp-marge { border: 1px solid #f1c40f; background-color: #fffcf5; color: #d35400; }
        .inp-coef { border: 1px solid #9b59b6; background-color: #fbf6ff; color: #8e44ad; }
        .vertical-stack { display: flex; flex-direction: column; gap: 3px; align-items: center; }

        .text-success { color: var(--success); font-weight: bold; }
        .text-danger { color: var(--danger); font-weight: bold; }
        .percent-display { color: #c0392b; font-weight: bold; font-size: 1.1rem; margin-top: 5px; display: block; text-align: center; border: 2px solid #c0392b; padding: 5px; border-radius: 8px; background: #fff5f5; width: fit-content; margin-left: auto; margin-right: auto; }
        
        .lvl-check-container { display:flex; flex-wrap:wrap; gap:8px; align-items:center; }
        .lvl-check-item { display:flex; align-items:center; gap:3px; background:#f8f9fa; border:1px solid #eee; padding:2px 6px; border-radius:4px; font-size:0.8rem; }
        .lvl-input-item { display:flex; align-items:center; gap:5px; margin-bottom:2px; }
        .lvl-input-item span { font-size:0.8rem; font-weight:bold; }
		/* FEN√äTRE VENTILATION (SPLIT MODAL) */
#split-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0, 0, 0, 0.5); z-index: 10000;
    display: none; justify-content: center; align-items: center;
    backdrop-filter: blur(2px);
}
.split-box {
    background: white; padding: 25px; border-radius: 8px; 
    width: 400px; max-width: 90%;
    box-shadow: 0 10px 25px rgba(0,0,0,0.2);
}
.split-header { 
    border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 15px; 
    display: flex; justify-content: space-between; align-items: center; 
}
.split-header h3 { margin: 0; color: var(--primary); }
.split-row {
    display: flex; justify-content: space-between; align-items: center;
    margin-bottom: 12px; padding: 8px; background: #f8f9fa; border-radius: 6px; border: 1px solid #eee;
}
.split-row label { font-weight: bold; color: #555; }
.split-row input { width: 80px !important; text-align: center; font-weight: bold; color: var(--secondary); }
.split-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; border-top: 1px solid #eee; padding-top: 15px; }
.info-dispo { background: #e8f8f5; color: #16a085; padding: 10px; border-radius: 5px; margin-bottom: 15px; font-weight: bold; text-align: center; font-size: 0.9rem; }
		
		/* --- AJOUT POUR √âQUIPES P√âDAGOGIQUES --- */
        .team-table { font-size: 0.8rem; width: 100%; border-collapse: collapse; }
        .team-table th { background: #2c3e50; color: white; font-weight: bold; border: 1px solid #34495e; padding: 10px 5px; position: sticky; top: 0; z-index: 10; }
        .team-table td { border: 1px solid #bdc3c7; padding: 0; height: 35px; min-width: 40px; text-align: center; vertical-align: middle; }
        
        .team-subject-row { background-color: #ecf0f1; font-weight: bold; text-align: left; padding-left: 10px !important; color: #2c3e50; border-top: 2px solid #7f8c8d !important; }
        .team-teacher-label { text-align: left; padding-left: 10px !important; font-size: 0.85rem; color: #333; background: #fff; width: 220px; max-width: 220px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-weight: 500; }
        
        .cell-assign { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.1s; font-size: 1.2rem; user-select: none; }
        .cell-assign:hover { background-color: #f0f0f0; }
        
        /* Couleurs des √©tats */
        .mode-class { background-color: #27ae60 !important; color: white; } /* Vert : Classe Enti√®re */
        .mode-group { background-color: #3498db !important; color: white; } /* Bleu : Groupe */
        .missing-teacher { background-color: #fadbd8 !important; box-shadow: inset 0 0 0 2px #c0392b; } /* Rouge : Alerte */
        
        /* Indicateur Prof Principal (Couronne) */
        .is-pp { position: relative; border: 3px solid #f1c40f !important; z-index: 5; }
        .is-pp::after { 
            content: 'üëë'; position: absolute; top: -14px; right: -8px; 
            background: white; border-radius: 50%; padding: 1px; 
            font-size: 14px; box-shadow: 0 1px 3px rgba(0,0,0,0.3); border:1px solid #f1c40f;
        }
		/* Case d√©sactiv√©e (0h dans la mati√®re) */
        .cell-disabled {
            background-color: #e0e0e0 !important; /* Gris */
            cursor: not-allowed !important;
            opacity: 0.6;
            pointer-events: none; /* Bloque le clic */
            box-shadow: none !important;
            border-color: #d0d3d4 !important;
        }

/* --- MODAL EXPORT MODERNE (V2) --- */
.export-section-title {
    font-size: 0.9rem;
    font-weight: 700;
    color: #7f8c8d;
    margin-bottom: 10px;
    margin-top: 20px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.export-tiles-row {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 15px;
}

.export-tile {
    background: white;
    border: 2px solid #ecf0f1;
    border-radius: 10px;
    padding: 15px;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
    color: #2c3e50;
    position: relative;
    height: 100px; /* Hauteur fixe pour uniformit√© */
}

.export-tile:hover {
    border-color: #3498db;
    background: #ebf5fb;
    transform: translateY(-2px);
}

.export-tile.selected {
    border-color: #27ae60;
    background: #e8f8f5;
    color: #27ae60;
    box-shadow: 0 4px 10px rgba(39, 174, 96, 0.2);
}

.export-tile.selected::after {
    content: '‚úî';
    position: absolute;
    top: 5px; right: 5px;
    font-size: 1rem;
    color: #27ae60;
}

.tile-label { font-weight: bold; font-size: 0.95rem; margin-top: 8px; }

/* --- ICONES CSS PURE (Pour √™tre s√ªr du visuel) --- */
.icon-paper {
    border: 2px solid currentColor;
    border-radius: 2px;
    position: relative;
    background: rgba(0,0,0,0.05);
}
/* Lignes de texte simul√©es √† l'int√©rieur */
.icon-paper::before {
    content: ''; position: absolute;
    background: currentColor; opacity: 0.3;
}

/* Portrait : Haut et √©troit */
.icon-portrait { width: 24px; height: 34px; }
.icon-portrait::before { top: 6px; left: 4px; right: 4px; height: 2px; box-shadow: 0 4px 0 currentColor, 0 8px 0 currentColor; }

/* Paysage : Large et bas */
.icon-landscape { width: 34px; height: 24px; }
.icon-landscape::before { top: 6px; left: 4px; right: 4px; height: 2px; box-shadow: 0 4px 0 currentColor, 0 8px 0 currentColor; }

/* Formats (Juste du texte stylis√©) */
.icon-format { font-size: 1.5rem; font-weight: 900; font-family: sans-serif; }

.export-options-row {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
    margin-top: 25px;
    border: 1px solid #eee;
}
.switch-label { display: flex; align-items: center; gap: 10px; cursor: pointer; color: #34495e; }

/* WIDGET KPI DOUBLE */
.kpi-widget {
    background: white;
    border: 1px solid #bdc3c7;
    border-radius: 6px;
    padding: 4px 10px;
    display: flex;
    flex-direction: column;
    gap: 4px;
    margin-right: auto; margin-left: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.03);
    min-width: 200px;
}

.kpi-row {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.85rem;
    line-height: 1.2;
}

.level-row {
    border-top: 1px solid #f1f2f6;
    padding-top: 4px;
}

.kpi-icon { font-size: 0.9rem; }
.kpi-label { font-weight: bold; color: #7f8c8d; font-size: 0.75rem; width: 40px; }
.kpi-val { font-weight: 800; color: #2c3e50; flex-grow: 1; text-align: right; margin-right: 8px; }

.kpi-tag {
    font-size: 0.75rem;
    font-weight: bold;
    padding: 1px 6px;
    border-radius: 4px;
    color: white;
    min-width: 35px;
    text-align: center;
}

/* Couleurs des deltas */
.bg-pos { background-color: #27ae60; } /* Vert (Reste) */
.bg-neg { background-color: #c0392b; } /* Rouge (D√©passement) */
.bg-nul { background-color: #95a5a6; } /* Gris (Pile poil) */

/* --- NOUVEAU STYLE DES EN-T√äTES (P√¥les & Mati√®res Solos) --- */
/* --- NOUVEAU STYLE DES EN-T√äTES (Gris Anthracite) --- */
.row-header {
    background-color: #455a64 !important; /* Gris fonc√© neutre */
    color: white !important;
    font-weight: bold;
    border-top: 2px solid #607d8b;
}

/* On force la couleur √† rester la m√™me au survol */
.row-header:hover td {
    background-color: #455a64 !important; 
    color: white !important;
}

.row-header button {
    border: 1px solid white !important;
    box-shadow: none !important;
}

.menu-item.disabled {
    opacity: 0.4;
    cursor: not-allowed;
    filter: grayscale(1);
}
.menu-item.disabled:hover {
    background: transparent;
    color: #bdc3c7;
}

/* Style du Pop-up EDS */
#eds-selector-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(44, 62, 80, 0.8); z-index: 20000;
    display: none; justify-content: center; align-items: center;
    backdrop-filter: blur(4px);
}
.eds-selector-box {
    background: white; padding: 30px; border-radius: 12px;
    width: 800px; max-width: 95%; max-height: 90vh;
    box-shadow: 0 20px 40px rgba(0,0,0,0.3);
    display: flex; flex-direction: column;
}
.eds-grid {
    display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 12px; overflow-y: auto; padding: 10px; margin: 20px 0;
}
.eds-tile {
    border: 2px solid #eee; border-radius: 8px; padding: 15px 10px;
    text-align: center; cursor: pointer; transition: all 0.2s;
    font-size: 0.85rem; font-weight: 600; color: var(--primary);
    background: #f8f9fa; position: relative;
    display: flex; align-items: center; justify-content: center; min-height: 60px;
}
.eds-tile:hover { border-color: var(--secondary); background: #ebf5fb; transform: translateY(-2px); }
.eds-tile.selected {
    border-color: var(--success); background: #e8f8f5; color: var(--success);
    box-shadow: 0 4px 8px rgba(39, 174, 96, 0.2);
}
.eds-tile.selected::after {
    content: '‚úì'; position: absolute; top: 5px; right: 5px;
    background: var(--success); color: white; width: 18px; height: 18px;
    border-radius: 50%; font-size: 12px; display: flex; align-items: center; justify-content: center;
}

/* --- STYLE TABLEAU EDS V4 --- */
.table-eds { 
    width: 100%; border-collapse: collapse; margin-bottom: 20px; 
    background: white; border-radius: 8px; overflow: hidden;
}
.table-eds th { 
    background: #f8f9fa; color: #7f8c8d; font-size: 0.75rem; 
    text-transform: uppercase; padding: 12px 10px; border-bottom: 2px solid #eee; 
    text-align: center;
}
.table-eds td { padding: 10px; border-bottom: 1px solid #f1f1f1; text-align: center; vertical-align: middle; }
.cost-badge { 
    font-size: 0.8rem; font-weight: 800; background: #ebf5fb; 
    color: #2980b9; padding: 4px 8px; border-radius: 6px; border: 1px solid #aed6f1; 
}
.eds-cat-header {
    background: #455a64 !important; color: white !important; 
    text-align: left !important; padding-left: 15px !important;
    font-size: 0.85rem; font-weight: bold; letter-spacing: 1px;
}
.input-inline-eds { 
    width: 60px !important; 
    padding: 6px 4px !important; 
    text-align: center; 
    border: 1px solid #dfe6e9; 
    border-radius: 4px;
    font-weight: bold;
    background: white;
}
/* Style pour les petits badges de cat√©gorie */
.badge-cat {
    font-size: 0.65rem;
    padding: 2px 5px;
    border-radius: 3px;
    background: #eee;
    margin-right: 8px;
    vertical-align: middle;
}

    </style>
</head>
<body>

<div id="setup-overlay">
    <div class="setup-box">
        <h1>üëã Bienvenue sur DHG Manager V8</h1>
        <p>Veuillez s√©lectionner le type d'√©tablissement pour configurer la structure initiale.</p>
        <div class="setup-options">
            <div class="setup-btn" onclick="initData('college')">
                <span class="setup-icon">üè´</span>
                <span>Coll√®ge</span>
                <small style="color:#777; font-weight:normal; margin-top:5px;">6√®me √† 3√®me</small>
            </div>
            <div class="setup-btn" onclick="initData('lgt')">
                <span class="setup-icon">üèõÔ∏è</span>
                <span>Lyc√©e GT</span>
                <small style="color:#777; font-weight:normal; margin-top:5px;">2nde √† Terminale</small>
            </div>
            <div class="setup-btn" onclick="initData('lp')">
                <span class="setup-icon">üîß</span>
                <span>Lyc√©e Pro</span>
                <small style="color:#777; font-weight:normal; margin-top:5px;">Structure libre</small>
            </div>
        </div>
        <p style="margin-top:25px; font-size:0.9rem; color:#777; border-top:1px solid #eee; padding-top:15px;">
            Vous avez d√©j√† un fichier ?<br>
            <button class="btn btn-dark btn-sm" style="margin-top:10px;" onclick="document.getElementById('load-file-input-overlay').click()">üìÇ Charger une sauvegarde</button>
            <input type="file" id="load-file-input-overlay" style="display:none;" onchange="loadSaveFile(this)" accept=".data,.json">
        </p>
    </div>
</div>

<div class="sidebar">
    <h2>DHG Manager V8</h2>
    <div class="sidebar-subtitle">By Fred Vedrenne</div>
    
    <button class="menu-item active" onclick="nav('dashboard', this)">üìä Tableau de Bord</button>
    <button class="menu-item" onclick="nav('structure', this)">üèóÔ∏è Structure (Niveaux)</button>
    <button class="menu-item" onclick="nav('matieres', this)">üîó Mati√®res & Modalit√©s</button>
	<button id="menu-eds" class="menu-item" onclick="nav('eds', this)">üéì Sp√©cialit√©s & EDS</button>
    <button class="menu-item" onclick="nav('professeurs', this)">üë• Professeurs</button>
	<button class="menu-item" onclick="nav('ventilation', this)">‚è±Ô∏è Grille Horaire</button>
	<button class="menu-item" onclick="nav('pilotage', this)">‚öñÔ∏è Ventilation</button>
	<button class="menu-item" onclick="nav('equipes', this)">üéì √âquipes P√©dagogiques</button>
	<button class="menu-item" onclick="nav('repartition', this)">üìã R√©partition de Services</button>
    <button class="menu-item" onclick="nav('recap', this)">üìë Bilan & Export</button>
	
    
    <div style="margin-top:auto; padding:20px;">
        <button class="btn btn-primary" style="width:100%; margin-bottom:10px;" onclick="downloadSaveFile()">üíæ Sauvegarder (.data)</button>
        <input type="file" id="load-file-input" style="display:none;" onchange="loadSaveFile(this)" accept=".data,.json">
        <button class="btn btn-dark" style="width:100%; font-size:0.85rem;" onclick="document.getElementById('load-file-input').click()">üìÇ Charger une sauvegarde</button>
        
        <hr style="border:0; border-top:1px solid rgba(255,255,255,0.2); margin:15px 0;">
        
        <button class="btn btn-warning" style="width:100%; font-size:0.85rem;" onclick="changeEpleType()">‚öôÔ∏è Changer Type √âtablissement</button>
    </div>
</div>

<div class="content">

    <div id="dashboard" class="section active">
        <div class="card">
            <div class="card-header">
                <h3>Pilotage Global</h3>
                <div class="export-group">
                    <button class="btn-exp" onclick="exportCurrentPage('excel')">üìä Excel</button>
                    <button class="btn-exp" onclick="exportCurrentPage('pdf')">üìÑ PDF</button>
                </div>
                <div style="display:flex; align-items:center; gap:10px;">
                    <label style="margin:0; font-weight:normal;">Rentr√©e :</label>
                    <select id="dash-year" style="width:100px; font-weight:bold;" onchange="updateYear(this.value)"></select>
                </div>
            </div>
            
            <div class="kpi-container">
                <div class="kpi-box" style="border-color: var(--primary);">
                    <div class="kpi-title">Dotation Rectorat</div>
                    <div class="kpi-value"><span id="dash-total-dhg">0</span> h</div>
                    <small style="color:#777; font-size:0.7rem; font-style:italic;">(Via Structure)</small>
                </div>
                
                <div class="kpi-box" style="border-color: var(--success);">
                    <div class="kpi-title">Consommation</div>
                    <div class="kpi-value"><span id="dash-conso">0</span> h</div>
                </div>

                <div class="kpi-box" style="border-color: var(--hp-color);">
                    <div class="kpi-title">HP Utilis√©es</div>
                    <div class="kpi-value"><span id="dash-hp-used">0</span> h</div>
                </div>

                <div class="kpi-box" style="border-color: var(--hsa-color);">
                    <div class="kpi-title">HSA Utilis√©es</div>
                    <div class="kpi-value"><span id="dash-hsa">0</span> h</div>
                </div>
                
                <div class="kpi-box" style="border-color: #95a5a6;">
                    <div class="kpi-title">Marge</div>
                    <div class="kpi-value" id="dash-solde">0</div>
                </div>
            </div>

            <div style="display:flex; gap:25px; flex-wrap:wrap;">
                <div style="flex:1; min-width:300px; background:#f8f9fa; padding:20px; border-radius:8px; border:1px solid #eee;">
                    <h4 style="margin-top:0;">R√©partition</h4>
                    <div style="height:250px; position:relative; width:100%;">
                        <canvas id="dhgChart"></canvas>
                    </div>
                </div>
                <div style="flex:1; min-width:300px; background:#f8f9fa; padding:20px; border-radius:8px; border:1px solid #eee;">
                    <h4 style="margin-top:0;">Param√®tres Dotation</h4>
                    
                    <label>Dotation Globale (Donn√©e issue du menu Structure)</label>
                    <span id="global-dhg-display" class="dotation-display">0</span>
                    
                    <div style="display:flex; gap:15px; margin-bottom:15px;">
                        <div style="flex:1"><label>Dont HP</label><input type="number" id="global-hp" value="0" onchange="updateGlobalDHG()"></div>
                        <div style="flex:1"><label>Dont HSA</label><input type="number" id="global-hsa" value="0" onchange="updateGlobalDHG()"></div>
                    </div>
                    
                    <div class="percent-display">
                        <span id="global-hsa-percent-display">0%</span> HSA
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="structure" class="section">
        <div class="card">
            <div class="card-header">
                <h3>Structure P√©dagogique (Niveaux)</h3>
                <div class="export-group">
                    <button class="btn-exp" onclick="exportCurrentPage('excel')">üìä Excel</button>
                    <button class="btn-exp" onclick="exportCurrentPage('pdf')">üìÑ PDF</button>
                </div>
                <div>
                    <button class="btn btn-success btn-sm" onclick="addNewLevel()">‚ûï Ajouter Niveau</button>
                    <button class="btn btn-primary btn-sm" onclick="generateClasses(true)">üîÑ R√©g√©n√©rer</button>
                </div>
            </div>
            <table id="structure-table">
                <thead>
                    <tr>
                        <th>Niveau</th><th>Effectif</th><th>Divisions</th><th>Moy./Div</th>
                        <th style="background:#fff3cd; color:#d35400;">Moyens Horaires par Division</th><th>Total Moyens</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="structure-body"></tbody>
            </table>
        </div>
        <div class="card">
            <h3>Classes</h3>
            <div id="class-list-container" style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px;"></div>
        </div>
    </div>

   <div id="ventilation" class="section">
        <div class="card">
            <div class="card-header">
                <h3>Grille Horaire</h3>
                
                <div id="grid-kpi" class="kpi-widget">
                    <div class="kpi-row">
                        <span class="kpi-icon">üåç</span>
                        <span class="kpi-label">√âTAB :</span>
                        <span id="kpi-etab-val" class="kpi-val">0 / 0 h</span>
                        <span id="kpi-etab-diff" class="kpi-tag">0</span>
                    </div>
                    <div id="kpi-level-row" class="kpi-row level-row">
                        <span class="kpi-icon">üèóÔ∏è</span>
                        <span class="kpi-label">NIV :</span>
                        <span id="kpi-lvl-val" class="kpi-val">0 / 0 h</span>
                        <span id="kpi-lvl-diff" class="kpi-tag">0</span>
                    </div>
                </div>
                <div class="export-group">
                    <button class="btn-exp" onclick="exportCurrentPage('excel')">üìä Excel</button>
                    <button class="btn-exp" onclick="exportCurrentPage('pdf')">üìÑ PDF</button>
                </div>
                <div>
                    <button class="btn btn-purple btn-sm" onclick="openWeightingMenu()">‚öñÔ∏è Pond√©ration</button>
                    <button class="btn btn-warning btn-sm" onclick="resetToOfficial()">‚ö†Ô∏è Reset Officiel</button>
                </div>
            </div>
            <div class="tab-container" id="grid-tabs"></div>
            <div id="grid-container"></div>
        </div>
    </div>

<div id="equipes" class="section">
        <div class="card">
            <div class="card-header">
                <h3>R√©partition & √âquipes P√©dagogiques</h3>
                <div class="export-group">
                    <button class="btn-exp" onclick="exportCurrentPage('excel')">üìä Excel (Grille)</button>
                    <button class="btn-exp" onclick="exportCurrentPage('pdf')">üìÑ PDF (Grille)</button>
                    <button class="btn-exp" style="background:#8e44ad;" onclick="exportTeamsListsPDF()">üìÑ PDF (Listes/Classe)</button>
                </div>
                <div style="font-size:0.8rem; color:#666; font-style:italic; display:flex; align-items:center; gap:10px;">
                    <span style="display:flex; align-items:center;"><span style="width:12px; height:12px; background:#27ae60; margin-right:4px;"></span>Classe</span>
                    <span style="display:flex; align-items:center;"><span style="width:12px; height:12px; background:#3498db; margin-right:4px;"></span>Groupe</span>
                    <span>üëë Clic Droit = Prof Principal</span>
                    <span style="color:#c0392b; font-weight:bold;">Rouge = Prof manquant</span>
                </div>
            </div>
            <div class="grid-wrapper" style="max-height: 75vh; overflow:auto;">
                <table class="team-table" id="teams-table">
                    </table>
            </div>
        </div>
    </div>

<div id="repartition" class="section">
    <div class="card">
        <div class="card-header">
            <h3>R√©partition & Ventilation des Services</h3>
            <div class="toggle-container">
    <button class="toggle-btn" id="btn-view-repart-prof" onclick="switchRepartitionView('profs')">üë§ Par Enseignant</button>
    <button class="toggle-btn active" id="btn-view-repart-mat" onclick="switchRepartitionView('matieres')">üìö Par Mati√®re</button>
</div>
            <div class="export-group">
                <button class="btn-exp" onclick="exportCurrentPage('excel')">üìä Excel</button>
                <button class="btn-exp" onclick="exportCurrentPage('pdf')">üìÑ PDF</button>
            </div>
        </div>
        <div id="repartition-content">
            </div>
    </div>
</div>

    <div id="pilotage" class="section">
    <div class="card">
        <div class="card-header">
            <h3>Ventilation & Besoins</h3>
            <div class="export-group">
                <button class="btn-exp" onclick="exportCurrentPage('excel')">üìä Excel</button>
                <button class="btn-exp" onclick="exportCurrentPage('pdf')">üìÑ PDF</button>
				            </div>
            </div>
        <div class="table-container">
            <table class="table" id="rh-table-disc">
                <thead>
                    <tr>
                        <th style="width:20%;">Discipline / Enseignant</th>
                        <th style="width:10%;">Besoin</th>
                        <th style="width:10%;">Apport</th>
                        <th style="width:10%;">HP</th>
                        <th style="width:10%;">HSA</th>
                        <th style="width:10%;">Solde</th>
                    </tr>
                </thead>
                <tbody id="rh-disc-body"></tbody>
                <tfoot id="rh-disc-total" style="font-weight:bold; background:#ecf0f1;"></tfoot>
            </table>
        </div>
    </div>
</div>

<div id="professeurs" class="section">
    <div class="card">
        <div class="card-header">
    <h3>Liste des Professeurs</h3>
    
    <div class="export-group">
        <button class="btn-exp" onclick="exportCurrentPage('excel')">üìä Excel</button>
        <button class="btn-exp" onclick="exportCurrentPage('pdf')">üìÑ PDF</button>
    </div>

    <div style="display:flex; gap:8px; align-items:center;">
        <button class="btn btn-sm btn-outline" id="btn-toggle-codes" onclick="toggleRhCodes()" title="Afficher/Masquer les codes mati√®res">üëÅÔ∏è Codes</button>
        
        <div style="width:1px; height:20px; background:#ddd; margin:0 2px;"></div>
        
        <input type="file" id="import-rh-input-v4" accept=".csv, .xlsx, .xls" style="display:none;" onchange="importRH(this)">
        <button class="btn btn-dark btn-sm" onclick="document.getElementById('import-rh-input-v4').click()" title="Importer depuis Excel">üìÇ Import</button>
        
        <button class="btn btn-danger btn-sm" onclick="clearTeachers()" title="Supprimer tous les professeurs">üóëÔ∏è Vider</button>
        
        <button class="btn btn-success btn-sm" onclick="promptAddTeacher()">‚ûï Ajouter</button>
    </div>
</div>
        <div class="table-container">
            <table class="table" id="rh-table-list">
                <thead>
                    <tr>
                        <th style="width:20%;">Nom</th>
                        <th class="col-code-header" style="width:5%; display:none;">Code</th>
                        <th style="width:20%;">Discipline</th>
                        <th style="width:10%;">Statut</th>
                        <th style="width:10%;">ORS</th>
                        <th style="width:10%;">HSA</th>
                        <th style="width:10%;">Total</th>
                        <th style="width:15%;">Actions</th>
                    </tr>
                </thead>
                <tbody id="rh-body"></tbody>
            </table>
        </div>
    </div>
</div>

<div id="eds" class="section">
    <div class="card">
        <div class="card-header">
            <h3>Pilotage des Sp√©cialit√©s (EDS)</h3>
            <div class="export-group">
                <button class="btn btn-purple btn-sm" onclick="transferEDS('premiere', 'terminale')">üöÄ Basculer 1√®re ‚ûî Term</button>
                <button class="btn btn-dark btn-sm" onclick="transferEDS('terminale', 'premiere')">‚Ü©Ô∏è Basculer Term ‚ûî 1√®re</button>
            </div>
        </div>
        
        <div class="card" style="border-top: 5px solid var(--secondary); background: #fdfefe; margin-bottom: 30px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h4 style="margin:0; color:var(--secondary);">Niveau PREMI√àRE</h4>
                <div style="background:var(--secondary); color:white; padding:5px 15px; border-radius:20px; font-weight:bold;">
                    Total Niveau : <span id="total-eds-1ere">0</span> h
                </div>
            </div>
            
            <table class="table-eds">
                <thead>
                    <tr>
                        <th style="text-align:left; width:30%;">Sp√©cialit√©</th>
                        <th style="width:12%;">Effectif</th>
                        <th style="width:12%;">Groupes</th>
                        <th style="width:12%;">H / Gr.</th>
                        <th style="width:12%;">√âl√®ves / Gr.</th>
                        <th style="width:17%;">Co√ªt H / √âl√®ve</th>
                        <th style="width:5%;"></th>
                    </tr>
                </thead>
                <tbody id="eds-full-1ere"></tbody>
            </table>
            <button class="btn btn-primary" style="width:100%;" onclick="addEDS('premiere')">‚ûï Configurer les EDS de Premi√®re</button>
        </div>

        <div class="card" style="border-top: 5px solid var(--accent); background: #fdfefe;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h4 style="margin:0; color:var(--accent);">Niveau TERMINALE</h4>
                <div style="background:var(--accent); color:white; padding:5px 15px; border-radius:20px; font-weight:bold;">
                    Total Niveau : <span id="total-eds-term">0</span> h
                </div>
            </div>
            
            <table class="table-eds">
                <thead>
                    <tr>
                        <th style="text-align:left; width:30%;">Sp√©cialit√©</th>
                        <th style="width:12%;">Effectif</th>
                        <th style="width:12%;">Groupes</th>
                        <th style="width:12%;">H / Gr.</th>
                        <th style="width:12%;">√âl√®ves / Gr.</th>
                        <th style="width:17%;">Co√ªt H / √âl√®ve</th>
                        <th style="width:5%;"></th>
                    </tr>
                </thead>
                <tbody id="eds-full-term"></tbody>
            </table>
            <button class="btn btn-warning" style="width:100%;" onclick="addEDS('terminale')">‚ûï Configurer les EDS de Terminale</button>
        </div>
    </div>
</div>

    <div id="matieres" class="section">
        <div class="card">
            <div class="card-header">
                <h3>Mati√®res & Modalit√©s</h3>
                <div class="export-group">
                    <button class="btn-exp" onclick="exportCurrentPage('excel')">üìä Excel</button>
                    <button class="btn-exp" onclick="exportCurrentPage('pdf')">üìÑ PDF</button>
                </div>
                <button class="btn btn-primary btn-sm" onclick="addSubject()">‚ûï Nouvelle Mati√®re</button>
            </div>
            <table id="subjects-table">
                <thead><tr>
    <th style="width:80px;">Code</th>
    <th style="text-align:left;">Mati√®re (√âditable)</th>
    <th style="width:180px;">Rattach√© √† (Parent)</th>
<th style="width:200px;">Disciplines Associ√©es<br><small>(Co-intervention)</small></th>
	<th style="width:160px;">Modalit√©s</th>
    <th style="text-align:left;">Param√®tres (Niveaux / Volumes)</th>
    <th>Actions</th>
</tr></thead>
                <tbody id="subjects-body"></tbody>
            </table>
        </div>
    </div>

    <div id="recap" class="section">
        <div class="card">
            <div class="card-header">
                <h3>Bilan & Export</h3>
                <div class="export-group">
                    <button class="btn-exp" onclick="exportCurrentPage('excel')">üìä Excel</button>
                    <button class="btn-exp" onclick="exportCurrentPage('pdf')">üìÑ PDF</button>
					<button class="btn-exp" style="background:#e67e22;" onclick="generateCAPres()">üìΩÔ∏è Diaporama CA (.pptx)</button>
                </div>
            </div>
          <table id="recap-table" style="width:100%; table-layout: fixed;">
    <thead>
        <tr>
            <th style="text-align:left; width: 250px;">Discipline</th>
            
            <th style="background:#fdedec; color:#c0392b; width:70px;">Besoin</th>
            <th style="background:#e8f6f3; color:#16a085; width:70px;">Apport</th>
            <th style="width:70px;">Dont HP</th>
            <th style="width:70px;">Dont HSA</th>
            <th style="width:70px;">√âcart</th>
            
            <th>Commentaires</th>
        </tr>
    </thead>
    <tbody id="recap-body"></tbody>
    <tfoot id="recap-total" style="background:#ecf0f1; font-weight:bold;"></tfoot>
</table>
        </div>
    </div>

</div>
<div id="split-overlay">
    <div class="split-box">
        <div class="split-header">
            <h3>‚úÇÔ∏è Ventilation de service</h3>
            <button onclick="closeSplitModal()" style="background:none; border:none; font-size:1.2rem; cursor:pointer;">√ó</button>
        </div>
        
        <div id="split-info" class="info-dispo"></div>
        
        <div id="split-container">
            </div>

        <div class="split-actions">
            <button class="btn btn-dark" onclick="closeSplitModal()">Annuler</button>
            <button class="btn btn-success" onclick="confirmVentilation()">Valider la ventilation</button>
        </div>
    </div>
</div>
<div id="export-overlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:10000; justify-content:center; align-items:center; backdrop-filter:blur(3px);">
    <div style="background:white; padding:30px; border-radius:15px; width:450px; max-width:90%; box-shadow:0 15px 35px rgba(0,0,0,0.2);">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2 style="margin:0; color:#2c3e50;">üñ®Ô∏è Configuration PDF</h2>
            <button onclick="document.getElementById('export-overlay').style.display='none'" style="border:none; background:none; font-size:1.5rem; cursor:pointer; color:#95a5a6;">√ó</button>
        </div>

        <div class="export-section-title">1. Orientation</div>
        <div class="export-tiles-row">
            <div class="export-tile" id="tile-orient-portrait" onclick="setExportParam('orientation', 'portrait')">
                <div class="icon-paper icon-portrait"></div>
                <div class="tile-label">Portrait</div>
            </div>
            <div class="export-tile" id="tile-orient-landscape" onclick="setExportParam('orientation', 'landscape')">
                <div class="icon-paper icon-landscape"></div>
                <div class="tile-label">Paysage</div>
            </div>
        </div>

        <div class="export-section-title">2. Format Papier</div>
        <div class="export-tiles-row">
            <div class="export-tile" id="tile-format-a4" onclick="setExportParam('format', 'a4')">
                <span class="icon-format">A4</span>
                <div class="tile-label">Standard</div>
            </div>
            <div class="export-tile" id="tile-format-a3" onclick="setExportParam('format', 'a3')">
                <span class="icon-format">A3</span>
                <div class="tile-label">Grand Format</div>
            </div>
        </div>

        <div class="export-options-row">
            <label class="switch-label">
                <input type="checkbox" id="chk-force-one-page" checked style="width:20px; height:20px; accent-color:#27ae60;">
                <div>
                    <div style="font-weight:bold;">Forcer sur une seule page</div>
                    <small style="color:#7f8c8d;">R√©duit automatiquement la police</small>
                </div>
            </label>
        </div>

        <button class="btn btn-success" style="width:100%; padding:15px; margin-top:20px; font-size:1.1rem; justify-content:center;" onclick="confirmGlobalExport()">
    T√©l√©charger le PDF
</button>
    </div>
</div>
<div id="dech-overlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:10000; justify-content:center; align-items:center; backdrop-filter:blur(2px);">
    <div style="background:white; padding:25px; border-radius:10px; width:400px; max-width:90%; box-shadow:0 10px 25px rgba(0,0,0,0.2);">
        <h3 style="margin-top:0; color:#2c3e50; border-bottom:1px solid #eee; padding-bottom:10px;">Gestion des D√©charges</h3>
        <p id="dech-teacher-name" style="font-weight:bold; color:#3498db; margin-bottom:20px;"></p>

        <div style="background:#f9f9f9; padding:15px; border-radius:8px; border:1px solid #eee; margin-bottom:15px;">
            <label style="display:block; font-weight:bold; color:#e67e22; margin-bottom:5px;">1. D√©charge DGH (Interne)</label>
            <small style="color:#777; display:block; margin-bottom:8px;">Heure de Labo, Cabinet, Vaisselle...<br>üëâ <strong>Co√ªte</strong> √† l'√©tablissement.</small>
            <div style="display:flex; align-items:center; gap:10px;">
                <input type="number" id="input-dech-int" step="0.5" min="0" style="width:80px; text-align:center; font-weight:bold; color:#e67e22;" placeholder="0">
                <span>heure(s)</span>
            </div>
        </div>

        <div style="background:#f9f9f9; padding:15px; border-radius:8px; border:1px solid #eee; margin-bottom:20px;">
            <label style="display:block; font-weight:bold; color:#27ae60; margin-bottom:5px;">2. D√©charge Rectorat (Externe)</label>
            <small style="color:#777; display:block; margin-bottom:8px;">Syndicale, All√®gement m√©dical, IMP Rectorat...<br>üëâ <strong>Ne co√ªte pas</strong> (r√©duit l'ORS pay√©).</small>
            <div style="display:flex; align-items:center; gap:10px;">
                <input type="number" id="input-dech-ext" step="0.5" min="0" style="width:80px; text-align:center; font-weight:bold; color:#27ae60;" placeholder="0">
                <span>heure(s)</span>
            </div>
        </div>

        <div style="text-align:right; display:flex; gap:10px; justify-content:flex-end;">
            <button class="btn btn-dark" onclick="currentDechIdx = -1; document.getElementById('dech-overlay').style.display='none'">Annuler</button>
            <button class="btn btn-success" onclick="saveDechargeDetails()">Valider</button>
        </div>
    </div>
</div>

<div id="eds-selector-overlay">
    <div class="eds-selector-box">
        <div class="split-header">
            <h3 id="eds-selector-title">S√©lectionner les Sp√©cialit√©s</h3>
            <button onclick="closeEdsSelector()" style="background:none; border:none; font-size:1.5rem; cursor:pointer;">√ó</button>
        </div>
        <p style="color: #7f8c8d; font-size: 0.9rem;">Cliquez sur les tuiles pour s√©lectionner les enseignements ouverts dans votre √©tablissement.</p>
        
        <div class="eds-grid" id="eds-tiles-container">
            </div>

        <div class="split-actions">
            <button class="btn btn-dark" onclick="closeEdsSelector()">Annuler</button>
            <button class="btn btn-success" id="btn-validate-eds" style="padding: 10px 30px;">Valider la s√©lection</button>
        </div>
    </div>
</div>
<div id="linked-subjects-overlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:10000; justify-content:center; align-items:center; backdrop-filter:blur(2px);">
    <div style="background:white; padding:25px; border-radius:10px; width:500px; max-width:90%; box-shadow:0 10px 25px rgba(0,0,0,0.2); display:flex; flex-direction:column; max-height:85vh;">
        <div style="border-bottom:1px solid #eee; padding-bottom:15px; margin-bottom:15px; display:flex; justify-content:space-between; align-items:center;">
            <h3 style="margin:0; color:#2c3e50;">üîó Disciplines Associ√©es</h3>
            <button onclick="closeLinkedSubjectsModal()" style="background:none; border:none; font-size:1.5rem; cursor:pointer; color:#7f8c8d;">√ó</button>
        </div>
        
        <p style="color:#7f8c8d; font-size:0.9rem; margin-top:0;">
            S√©lectionnez les mati√®res dont les professeurs pourront intervenir sur <strong id="linked-modal-target-name" style="color:#2c3e50;"></strong>.
        </p>

        <div id="linked-subjects-list" style="overflow-y:auto; flex-grow:1; border:1px solid #eee; padding:10px; border-radius:6px; background:#f9f9f9; display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
            </div>

        <div style="margin-top:20px; text-align:right; border-top:1px solid #eee; padding-top:15px;">
            <button class="btn btn-success" onclick="closeLinkedSubjectsModal()">Valider & Fermer</button>
        </div>
    </div>
</div>

<script>
/**
 * DHG MANAGER V2 - Version Finale
 */

const PRESETS = {
    'college': {
        levels: [
            { level: "6√®me", students: 0, div: 0, target: 28.0 },
            { level: "5√®me", students: 0, div: 0, target: 29.0 },
            { level: "4√®me", students: 0, div: 0, target: 29.0 },
            { level: "3√®me", students: 0, div: 0, target: 29.0 }
        ],
        subjects: {
            "Fran√ßais": {"6√®me":4.5,"5√®me":4.5,"4√®me":4.5,"3√®me":4}, "Maths": {"6√®me":4.5,"5√®me":3.5,"4√®me":3.5,"3√®me":3.5},
            "Hist-G√©o": {"6√®me":3,"5√®me":3,"4√®me":3,"3√®me":3.5}, "LV1 Anglais": {"6√®me":4,"5√®me":3,"4√®me":3,"3√®me":3},
            "LV2 Espagnol": {"6√®me":0,"5√®me":2.5,"4√®me":2.5,"3√®me":2.5}, "SVT": {"6√®me":2,"5√®me":1.5,"4√®me":1.5,"3√®me":1.5},
            "Phys-Chi": {"6√®me":2,"5√®me":1.5,"4√®me":1.5,"3√®me":1.5}, "Techno": {"6√®me":0,"5√®me":1.5,"4√®me":1.5,"3√®me":1.5},
            "EPS": {"6√®me":4,"5√®me":3,"4√®me":3,"3√®me":3}, "Arts Plast.": {"6√®me":1,"5√®me":1,"4√®me":1,"3√®me":1},
            "Education Musicale": {"6√®me":1,"5√®me":1,"4√®me":1,"3√®me":1}, 
            "Autonomie EPLE": { "6√®me": 0, "5√®me": 0, "4√®me": 0, "3√®me": 0 },
            "UNSS": { "6√®me": 0, "5√®me": 0, "4√®me": 0, "3√®me": 0 }
        }
    },
    'lgt': {
        levels: [
            { level: "2nde", students: 0, div: 0, target: 29.0 },
            { level: "1√®re", students: 0, div: 0, target: 28.0 },
            { level: "Terminale", students: 0, div: 0, target: 28.0 }
        ],
        subjects: {
            "Fran√ßais": {"2nde":4, "1√®re":4, "Terminale":0}, "Philosophie": {"2nde":0, "1√®re":0, "Terminale":4},
            "Hist-G√©o": {"2nde":3, "1√®re":3, "Terminale":3}, "LVA": {"2nde":3, "1√®re":2.5, "Terminale":2},
            "LVB": {"2nde":2.5, "1√®re":2, "Terminale":2}, "SES": {"2nde":1.5, "1√®re":0, "Terminale":0},
            "Maths (TC)": {"2nde":4, "1√®re":0, "Terminale":0}, "Phys-Chi (TC)": {"2nde":3, "1√®re":0, "Terminale":0},
            "SVT (TC)": {"2nde":1.5, "1√®re":0, "Terminale":0}, "EPS": {"2nde":2, "1√®re":2, "Terminale":2},
            "Ens. Scientifique": {"2nde":0, "1√®re":2, "Terminale":2}, "EMC": {"2nde":0.5, "1√®re":0.5, "Terminale":0.5},
            "Autonomie EPLE": { "2nde": 0, "1√®re": 0, "Terminale": 0 },
            "UNSS": { "2nde": 0, "1√®re": 0, "Terminale": 0 }
        }
    },
    'lp': {
        levels: [{ level: "2nde BacPro", students: 0, div: 0, target: 30.0 }],
        subjects: { 
            "Lettres-Hist": {"2nde BacPro": 4}, "Maths-Sciences": {"2nde BacPro": 4}, "EPS": {"2nde BacPro": 2}, 
            "Autonomie EPLE": { "2nde BacPro": 0 }, "UNSS": { "2nde BacPro": 0 }
        }
    }
};

const SUBJECT_MAPPING = {
    // Lettres & Langues
    "LET MODERN": "Fran√ßais", "LET CLASS": "Fran√ßais", "FRANCAIS": "Fran√ßais", "LETTRES MODERNES": "Fran√ßais",
    "LITT.  MODERNES": "Fran√ßais", "LITT. CLASSIQUES": "Fran√ßais",
    "ANGLAIS": "LV1 Anglais", "ESPAGNOL": "LV2 Espagnol", 
    "ALLEMAND": "LV2 Allemand", "ITALIEN": "LV2 Italien",
    "ANGLAIS LCE": "LV1 Anglais", "LANGUE ET LITTERATURE ANGLAISE": "LV1 Anglais",
    "LATIN": "LCA Latin", "GREC": "LCA Grec",
    
    // Sciences
    "MATHEMATIQ": "Maths", "MATHEMATIQUES": "Maths", "MATHS": "Maths",
    "S. V. T.": "SVT", "SC. VIE TERRE": "SVT", "SVT": "SVT",
    "PHY.CHIMIE": "Phys-Chi", "PHYSIQUE-CHIMIE": "Phys-Chi", "SC. PHYSIQUES": "Phys-Chi",
    "TECHNOLOGI": "Techno", "TECHNOLOGIE": "Techno", "TECHNO": "Techno",
    "MATHS-SCIENCES": "Maths-Sciences",
    
    // Humanit√©s & Arts
    "HIST. GEO.": "Hist-G√©o", "HISTOIRE-GEOGRAPHIE": "Hist-G√©o", "HISTOIRE-GEO": "Hist-G√©o",
    "ARTS PLAST": "Arts Plast.", "ARTS PLASTIQUES": "Arts Plast.",
    "EDU MUSICA": "Education Musicale", "EDUCATION MUSICALE": "Education Musicale", "MUSIQUE": "Education Musicale",
    
    // Sport & Autres
    "E. P. S": "EPS", "EPS": "EPS", "ED. PHYS. SPORT.": "EPS",
    "DOCUMENTA": "Documentation", "DOCUMENTATION": "Documentation"
};

// --- FONCTION CORRECTIVE POUR LES NOMS DE CLASSES ---
// --- NOUVELLE FONCTION DE PR√âFIXE (ANTI-CONFLIT TST2S) ---
function getLevelPrefix(name) {
    if (!name) return "";
    
    // 1. Si le nom COMMENCE par un chiffre (ex: "2nde", "6√®me")
    // On prend juste ce chiffre.
    if (/^[0-9]/.test(name)) {
        return name.match(/^[0-9]+/)[0];
    }
    
    // 2. Sinon (ex: "TST2S", "BTS", "UPE2A")
    // On prend les 3 premiers caract√®res en majuscules.
    // TST2S deviendra "TST" (et non plus "2")
    return name.substring(0, 3).toUpperCase();
}

// --- FONCTION MA√éTRESSE : G√âN√àRE TOUS LES PR√âFIXES UNIQUES ---
function getAllUniquePrefixes() {
    const uniquePrefixes = [];
    const usedRegistry = {};

    DATA.structure.forEach(lvl => {
        // 1. On calcule le pr√©fixe de base (ex: "1")
        let p = getLevelPrefix(lvl.level);
        
        // 2. S'il est d√©j√† pris, on cherche une variante (ex: "12", "13", "14")
        if (usedRegistry[p]) {
            let suffix = 2;
            let candidate = p + suffix;
            while (usedRegistry[candidate]) {
                suffix++;
                candidate = p + suffix;
            }
            p = candidate;
        }
        
        // 3. On valide ce pr√©fixe
        usedRegistry[p] = true;
        uniquePrefixes.push(p);
    });
    
    // Retourne la liste des pr√©fixes dans l'ordre des niveaux
    // Ex: ["6", "5", "4", "3", "2", "1", "12", "T"]
    return uniquePrefixes;
}

let DATA = null;
let chartInstance = null;
let showRhCodes = false;

window.onload = function() {
    // Tentative de r√©cup√©ration de la sauvegarde
    if(localStorage.getItem('DHG_Data_V9')) {
        try { DATA = JSON.parse(localStorage.getItem('DHG_Data_V9')); } catch(e) {}
    }
    
    if(DATA) {
        // V√©rification des structures de donn√©es existantes
        if(!DATA.subjectMeta) DATA.subjectMeta = {};

        // --- AJOUT SP√âCIFIQUE POUR LE MENU √âQUIPES ---
        // Initialise le stockage des affectations profs/classes si inexistant
        if(!DATA.assignments) DATA.assignments = {}; 
        // ---------------------------------------------

        // Initialisation des modes par d√©faut pour les mati√®res (si manquant)
        DATA.subjects.forEach(s => {
            if(!DATA.subjectMeta[s]) DATA.subjectMeta[s] = {};
            if(!DATA.subjectMeta[s].mode) {
                DATA.subjectMeta[s].mode = 'div';
                DATA.subjectMeta[s].levels = getDefaultActiveLevels(s);
                DATA.subjectMeta[s].etab = 0;
                DATA.subjectMeta[s].volLevel = {};
            }
        });
        checkAndFixData();
        // Masquer l'√©cran d'accueil et lancer l'interface
        document.getElementById('setup-overlay').style.display = 'none';
        initYearSelector();
        initUI();
    } else {
        // Pas de donn√©es : Afficher l'√©cran de configuration
        document.getElementById('setup-overlay').style.display = 'flex';
    }
};

function getDefaultActiveLevels(s) {
    if(!DATA || !DATA.structure) return [];
    let all = DATA.structure.map(l => l.level);
    if(s.includes("Techno") || s.includes("Espagnol") || s.includes("LV2")) {
        return all.filter(l => !l.includes("6"));
    }
    if(s.includes("Philosophie")) {
        return all.filter(l => l.toLowerCase().includes("term"));
    }
    return all;
}

function initData(type) {
    const preset = PRESETS[type];
    const currentYear = new Date().getFullYear();
    DATA = {
        type: type,
        config: { year: currentYear, total: 0, hp: 0, hsa: 0 },
        structure: JSON.parse(JSON.stringify(preset.levels)),
        additionalMeans: { total: 0 },
        subjects: Object.keys(preset.subjects),
        subjectMeta: {},
        levelConfig: {},
        classOverrides: {},
        classNames: {}, 
        teachers: [],
        recapComments: {},
        assignments: {},
        // NOUVEAU : Stockage des EDS
        eds: {
            premiere: [],
            terminale: []
        }
    };
    
    DATA.subjects.forEach(s => {
        DATA.subjectMeta[s] = {
            mode: 'div',
            levels: getDefaultActiveLevels(s),
            etab: 0,
            volLevel: {},
            parent: "",
            code: ""
        };
        
        if(s.includes("Latin") || s.includes("LCA")) DATA.subjectMeta[s].parent = "Fran√ßais";
        
        if(s === "UNSS") {
            DATA.subjectMeta[s].mode = 'etab';
            DATA.subjectMeta[s].etab = 3;
            DATA.subjectMeta[s].parent = "EPS";
        }
    });

    DATA.structure.forEach(lvl => {
        DATA.levelConfig[lvl.level] = {};
        DATA.subjects.forEach(s => {
            const hrs = preset.subjects[s]?.[lvl.level] || 0;
            DATA.levelConfig[lvl.level][s] = {base: hrs, marge: 0, coef: 1.0};
        });
    });
    
    saveData();
    document.getElementById('setup-overlay').style.display = 'none';
    initYearSelector();
    initUI();
}

function changeEpleType() {
    if(confirm("‚ö†Ô∏è Attention : Changer de type d'√©tablissement va r√©initialiser les donn√©es actuelles.\n\nAvez-vous pens√© √† sauvegarder ?\n\nConfirmer le changement ?")) {
        localStorage.removeItem('DHG_Data_V9');
        location.reload();
    }
}

function initYearSelector() {
    const select = document.getElementById('dash-year');
    const yNow = new Date().getFullYear();
    const saved = DATA.config.year || yNow;
    select.innerHTML = '';
    for(let y = saved - 1; y <= saved + 5; y++) { let opt = new Option(y, y); if(y == saved) opt.selected = true; select.appendChild(opt); }
}

function initUI() {
    document.getElementById('global-dhg-display').innerText = DATA.config.total;
    document.getElementById('global-hp').value = DATA.config.hp;
    document.getElementById('global-hsa').value = DATA.config.hsa;
    if(!DATA.classNames) DATA.classNames = {}; 
    renderStructure(); renderGridSystem(); renderRH(); calculateRecap();
    renderSubjectsConfig();
}

function nav(id, btn) {
    // Blocage si EDS cliqu√© en mode coll√®ge
    if(id === 'eds' && DATA.type === 'college') {
        alert("Ce module est r√©serv√© aux structures Lyc√©e (EDS/Sp√©cialit√©s).");
        return;
    }

    document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    
    document.querySelectorAll('.menu-item').forEach(el => el.classList.remove('active'));
    if(btn) btn.classList.add('active');
    
    if(id === 'dashboard') { calculateRecap(); drawDashboardChart(); }
    else if(id === 'ventilation') renderGridSystem();
    else if(id === 'pilotage') renderRHDisc();
    else if(id === 'professeurs') renderRH();
    else if(id === 'equipes') renderTeams();
	else if(id === 'repartition') renderRepartition(); 
    else if(id === 'recap') calculateRecap();
    else if(id === 'matieres') renderSubjectsConfig();
    else if(id === 'eds') renderEDS();
}

function drawDashboardChart() {
    const canvas = document.getElementById('dhgChart');
    if(!canvas || canvas.offsetParent === null) return; 

    const totN = parseFloat(document.getElementById('dash-conso').innerText) || 0;
    const glo = parseFloat(document.getElementById('dash-total-dhg').innerText) || 0;
    const solde = glo - totN;

    const ctx = canvas.getContext('2d');
    if(chartInstance) chartInstance.destroy();
    
    chartInstance = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Consomm√©', 'Dispo', 'D√©ficit'],
            datasets: [{
                data: [
                    Math.min(totN, glo), 
                    Math.max(0, solde), 
                    solde < 0 ? Math.abs(solde) : 0
                ],
                backgroundColor: ['#3498db', '#2ecc71', '#e74c3c']
            }]
        },
        options: { 
            responsive: true, 
            maintainAspectRatio: false,
            animation: { duration: 500 }
        }
    });
}

function addNewLevel() {
    const name = prompt("Nom du niveau (ex: BTS 1) ?");
    if(!name) return;
    if(DATA.structure.some(l => l.level === name)) { alert("Existe d√©j√† !"); return; }
    DATA.structure.push({ level: name, students: 0, div: 0, target: 29.0 });
    DATA.levelConfig[name] = {};
    DATA.subjects.forEach(s => DATA.levelConfig[name][s] = {base:0, marge:0, coef:1.0});
    saveData(); renderStructure(); renderGridSystem();
}
function renameLevel(idx) {
    const lvl = DATA.structure[idx];
    const oldName = lvl.level;
    
    const newName = prompt("Renommer " + oldName + " en :", oldName);
    if (!newName || newName === oldName) return;

    // 1. On calcule les pr√©fixes AVANT et APR√àS le changement
    // (N√©cessite la fonction getLevelPrefix ajout√©e pr√©c√©demment)
    const oldPrefix = getLevelPrefix(oldName); 
    const newPrefix = getLevelPrefix(newName);

    // 2. "Geler" les noms actuels des classes
    // Si une classe s'appelle "6A" par d√©faut, on enregistre "6A" comme nom fixe.
    // Ainsi, m√™me si le code interne devient "N6A", l'affichage restera "6A".
    if (!DATA.classNames) DATA.classNames = {};
    for (let i = 0; i < lvl.div; i++) {
        const oldId = `${oldPrefix}${String.fromCharCode(65 + i)}`;
        // Si aucun nom personnalis√© n'existe, on force le nom actuel
        if (!DATA.classNames[oldId]) {
            DATA.classNames[oldId] = oldId;
        }
    }

    // 3. Appliquer le nouveau nom au niveau
    lvl.level = newName;

    // 4. Migrer la configuration du niveau (Mati√®res)
    if (DATA.levelConfig[oldName]) {
        DATA.levelConfig[newName] = JSON.parse(JSON.stringify(DATA.levelConfig[oldName]));
        delete DATA.levelConfig[oldName];
    }
    
    // Mettre √† jour les r√©f√©rences dans les M√©ta-donn√©es des mati√®res (si utilis√© en mode "niveau")
    DATA.subjects.forEach(s => {
        if (DATA.subjectMeta[s].levels && DATA.subjectMeta[s].levels.includes(oldName)) {
            const i = DATA.subjectMeta[s].levels.indexOf(oldName);
            DATA.subjectMeta[s].levels[i] = newName;
        }
        if (DATA.subjectMeta[s].volLevel && DATA.subjectMeta[s].volLevel[oldName]) {
            DATA.subjectMeta[s].volLevel[newName] = DATA.subjectMeta[s].volLevel[oldName];
            delete DATA.subjectMeta[s].volLevel[oldName];
        }
    });

    // 5. MIGRATION DES CLASSES (Noms & Heures personnalis√©es)
    // On doit d√©placer les donn√©es de l'ancien ID (ex: "6A") vers le nouvel ID (ex: "N6A")
    // tout en gardant le nom d'affichage "6A".
    
    if (oldPrefix !== newPrefix) {
        // Migration des noms de classes
        const newClassNames = { ...DATA.classNames };
        Object.keys(DATA.classNames).forEach(key => {
            if (key.startsWith(oldPrefix)) {
                // On cr√©e la nouvelle cl√© (ex: remplace '6' par 'N6' au d√©but)
                // Attention : on utilise une regex pour ne remplacer que le d√©but
                const newKey = key.replace(new RegExp('^' + oldPrefix), newPrefix);
                newClassNames[newKey] = DATA.classNames[key]; // On garde la valeur (le nom affich√©)
                delete newClassNames[key]; // On supprime l'ancienne cl√©
            }
        });
        DATA.classNames = newClassNames;

        // Migration des surcharges horaires (Overrides)
        if (DATA.classOverrides) {
            const newOverrides = { ...DATA.classOverrides };
            Object.keys(DATA.classOverrides).forEach(key => {
                if (key.startsWith(oldPrefix)) {
                    const newKey = key.replace(new RegExp('^' + oldPrefix), newPrefix);
                    newOverrides[newKey] = DATA.classOverrides[key];
                    delete newOverrides[key];
                }
            });
            DATA.classOverrides = newOverrides;
        }
        
        // Migration des affectations Professeurs (√âquipes P√©dagogiques)
        if (DATA.assignments) {
            const newAssignments = { ...DATA.assignments };
            Object.keys(DATA.assignments).forEach(key => {
                // key est sous forme "CLASSE_PROFINDEX" (ex: "6A_12")
                const parts = key.split('_');
                const cId = parts[0];
                if (cId.startsWith(oldPrefix)) {
                    const newCId = cId.replace(new RegExp('^' + oldPrefix), newPrefix);
                    const newKey = `${newCId}_${parts[1]}`;
                    newAssignments[newKey] = DATA.assignments[key];
                    delete newAssignments[key];
                }
            });
            DATA.assignments = newAssignments;
        }
    }

    saveData();
    renderStructure();
    renderGridSystem();
    renderSubjectsConfig();
    // Rafra√Æchir les onglets si n√©cessaire
    if (document.getElementById('equipes').classList.contains('active')) renderTeams();
}
function deleteLevel(idx) {
    const lvlName = DATA.structure[idx].level;
    if(confirm(`Supprimer le niveau "${lvlName}" ?`)) {
        DATA.structure.splice(idx, 1);
        delete DATA.levelConfig[lvlName];
        saveData(); renderStructure(); renderGridSystem();
    }
}

function renderStructure() {
    const tbody = document.getElementById('structure-body');
    tbody.innerHTML = '';
    let totEleves = 0, totDiv = 0, totHeures = 0;
    
    // ON R√âCUP√àRE LES PR√âFIXES UNIQUES ICI
    const allPrefixes = getAllUniquePrefixes();

    DATA.structure.forEach((lvl, idx) => {
        const besoin = lvl.div * lvl.target;
        totEleves += lvl.students; totDiv += lvl.div; totHeures += besoin;
        
        tbody.innerHTML += `<tr>
            <td><b>${lvl.level}</b></td>
            <td><input type="number" value="${lvl.students}" onchange="updStruct(${idx},'students',this.value)"></td>
            <td><input type="number" value="${lvl.div}" onchange="updStruct(${idx},'div',this.value)"></td>
            <td>${lvl.div>0 ? (lvl.students/lvl.div).toFixed(1) : 0}</td>
            <td><input type="number" value="${lvl.target}" step="0.5" style="background:#fffbe6; font-weight:bold; text-align:center;" onchange="updStruct(${idx},'target',this.value)"></td>
            <td style="font-weight:bold; color:var(--primary)">${besoin.toFixed(1)} h</td>
            <td>
                <div style="display:flex; gap:5px; justify-content:center;">
                    <button class="btn-sm btn-warning" onclick="renameLevel(${idx})">‚úèÔ∏è</button>
                    <button class="btn-sm btn-danger" onclick="deleteLevel(${idx})">üóëÔ∏è</button>
                </div>
            </td>
        </tr>`;
    });

    if(!DATA.additionalMeans) DATA.additionalMeans = { total: 0 };
    const suppTotal = parseFloat(DATA.additionalMeans.total || 0);
    totHeures += suppTotal;

    tbody.innerHTML += `
    <tr class="row-supp">
        <td colspan="4" style="text-align:right; font-weight:bold; font-style:italic;">
            Moyens suppl√©mentaires :
        </td>
        <td>
            <div class="supp-label-group">
                <input type="number" class="input-supp" value="${suppTotal}" onchange="updSupp(this.value)">
            </div>
        </td>
        <td style="font-weight:bold;">${suppTotal.toFixed(1)} h</td>
        <td></td>
    </tr>
    `;

    const moyGen = totDiv > 0 ? (totEleves / totDiv).toFixed(1) : 0;
    tbody.innerHTML += `<tr class="structure-total-row"><td>TOTAL G√âN√âRAL</td><td>${totEleves}</td><td>${totDiv}</td><td>${moyGen}</td><td style="text-align:right;">Total Moyens :</td><td style="color:#f1c40f;">${totHeures.toFixed(1)} h</td><td></td></tr>`;
    
    // G√©n√©ration des badges classes en bas de page
    const c = document.getElementById('class-list-container'); c.innerHTML = '';
    
    DATA.structure.forEach((lvl, idx) => {
        // ON UTILISE L'INDEX POUR R√âCUP√âRER LE BON PR√âFIXE UNIQUE
        const prefix = allPrefixes[idx];
        
        for(let i=0; i<lvl.div; i++) {
            const defId = `${prefix}${String.fromCharCode(65+i)}`;
            const displayName = DATA.classNames && DATA.classNames[defId] ? DATA.classNames[defId] : defId;
            c.innerHTML += `<span style="background:var(--secondary); color:white; padding:4px 8px; border-radius:4px; font-size:0.8rem;">${displayName}</span>`;
        }
    });

    DATA.config.total = totHeures;
    const dbTotal = document.getElementById('dash-total-dhg');
    if(dbTotal) dbTotal.innerText = totHeures;
    const dbDisplay = document.getElementById('global-dhg-display');
    if(dbDisplay) dbDisplay.innerText = totHeures;
    
    saveData();
}
function updStruct(i,f,v) { DATA.structure[i][f] = parseFloat(v); if(f==='div') generateClasses(false); saveData(); renderStructure(); }
function updSupp(val) { if(!DATA.additionalMeans) DATA.additionalMeans = { total: 0 }; DATA.additionalMeans.total = parseFloat(val) || 0; saveData(); renderStructure(); }
function generateClasses(conf) {
    // Si on clique sur le bouton "R√©g√©n√©rer", on force le reset (avec confirmation)
    if(conf) {
        if(!confirm("‚ö†Ô∏è Attention : Cela va r√©initialiser les noms des classes.\nContinuer ?")) return;
        DATA.classNames = {};
    }

    // S√©curit√© si l'objet n'existe pas
    if(!DATA.classNames) DATA.classNames = {};
    
    // 1. On r√©cup√®re les pr√©fixes
    const allPrefixes = getAllUniquePrefixes();
    
    // 2. On parcourt la structure pour AJOUTER ou GARDER les classes
    DATA.structure.forEach((lvl, idx) => {
        const prefix = allPrefixes[idx];
        
        for(let i=0; i<lvl.div; i++) {
            const id = `${prefix}${String.fromCharCode(65+i)}`; // Ex: 12A
            
            // LA CORRECTION EST ICI : 
            // Si le nom n'existe pas, on le cr√©e. 
            // S'il existe d√©j√† (ex: "6√®me SEGPA"), on ne le touche pas !
            if (!DATA.classNames[id]) {
                DATA.classNames[id] = id;
            }
        }
    });
    
    // (Optionnel) Nettoyage : On peut supprimer les classes qui seraient "hors limite" 
    // si tu r√©duis le nombre de divisions (ex: passage de 6 √† 5 classes), 
    // mais le plus important est de ne pas √©craser les existantes.
    
    saveData();
    renderStructure();
    renderGridSystem();
}

function calculateNeeds() {
    let n = {}; 
    DATA.subjects.forEach(s => n[s] = 0);
    
    DATA.subjects.forEach(s => {
        const meta = DATA.subjectMeta[s] || { mode: 'div', levels: [] };
        
        // --- CORRECTIF ANTI-DOUBLON ---
        // Si c'est un EDS, son besoin est g√©r√© par le forfait global, donc ici c'est 0.
        if (meta.isEds) return; 
        // ------------------------------

        // 1. MODE DIVISION
        if(meta.mode === 'div') {
            DATA.structure.forEach(lvl => {
                if(meta.levels && meta.levels.includes(lvl.level)) {
                    const prefix = getLevelPrefix(lvl.level);
                    const cfg = DATA.levelConfig[lvl.level][s] || {base:0, marge:0, coef:1.0};
                    const coef = cfg.coef || 1.0;
                    const hours = (cfg.base||0) + (cfg.marge||0);
                    
                    for(let i=0; i<lvl.div; i++) {
                        const c = `${prefix}${String.fromCharCode(65+i)}`;
                        if (DATA.classOverrides[c] && DATA.classOverrides[c][s]) {
                            const ov = DATA.classOverrides[c][s];
                            n[s] += ((ov.base||0) + (ov.marge||0)) * coef;
                        } else { 
                            n[s] += hours * coef; 
                        }
                    }
                }
            });
        }
        // 2. MODE NIVEAU
        else if (meta.mode === 'level') {
            DATA.structure.forEach(lvl => {
                const val = meta.volLevel ? parseFloat(meta.volLevel[lvl.level] || 0) : 0;
                n[s] += val;
            });
        }
        // 3. MODE √âTABLISSEMENT
        else if (meta.mode === 'etab') {
            n[s] += (parseFloat(meta.etab) || 0);
        }
    });
    return n;
}

function renderGridSystem() {
    const tabs = document.getElementById('grid-tabs');
    tabs.innerHTML = DATA.structure.map((l,i) => `<div class="tab ${i===0?'active':''}" onclick="changeTab(this, ${i})">${l.level}</div>`).join('');
    
    tabs.innerHTML += `<div class="tab global-tab" onclick="changeTab(this, -1)">üåç Vue Globale</div>`;
    
    const activeIdx = window.lastActiveGridTab !== undefined ? window.lastActiveGridTab : 0;
    if(activeIdx === -1) {
        const t = tabs.querySelector('.global-tab');
        if(t) { t.classList.add('active'); renderGlobalGrid(); }
    } else {
        const t = tabs.children[activeIdx];
        if(t) { t.classList.add('active'); renderLevelGrid(activeIdx); }
    }
	updateGridCounter();
}

function changeTab(el, idx) {
    document.querySelectorAll('#grid-tabs .tab').forEach(t => t.classList.remove('active'));
    el.classList.add('active');
    window.lastActiveGridTab = idx;
    if(idx === -1) renderGlobalGrid();
    else renderLevelGrid(idx);
}

function renameClass(originalId) {
    if(!DATA.classNames) DATA.classNames = {};
    const currentName = DATA.classNames[originalId] || originalId;
    const newName = prompt("Renommer la classe :", currentName);
    if(newName) {
        DATA.classNames[originalId] = newName;
        saveData();
        const activeTab = document.querySelector('#grid-tabs .tab.active');
        if(activeTab.innerText.includes("Vue Globale")) renderGlobalGrid();
        else renderGridSystem(); 
    }
}

function renderLevelGrid(idx) {
    const lvl = DATA.structure[idx]; if(!lvl) return;
    const name = lvl.level; 
    const safeName = name.replace(/'/g, "\\'");

    // 1. R√âCUP√âRATION DES PR√âFIXES UNIQUES (Ex: 12A, 12B...)
    const allPrefixes = getAllUniquePrefixes();
    const prefix = allPrefixes[idx];
    const cont = document.getElementById('grid-container');
    
    // 2. INITIALISATION
    if(!DATA.levelConfig[name]) DATA.levelConfig[name] = {};
    DATA.subjects.forEach(s => { 
        if(!DATA.levelConfig[name][s]) DATA.levelConfig[name][s] = {base:0, marge:0, coef:1.0}; 
        if(DATA.levelConfig[name][s].coef === undefined) DATA.levelConfig[name][s].coef = 1.0;
    });

    // 3. FILTRAGE MATI√àRES : On masque les sp√©cialit√©s individuelles (isEds) pour la lisibilit√©
    const visibleSubjects = DATA.subjects.filter(s => {
        const m = DATA.subjectMeta[s];
        if (m.isEds) return false; // Masque les EDS individuels dans cette vue
        if (m.mode === 'etab') return false;
        if (m.mode === 'level') {
            const vol = m.volLevel ? parseFloat(m.volLevel[name] || 0) : 0;
            return vol > 0;
        }
        return (!m.levels || m.levels.includes(name));
    });

    let h = `<div class="grid-wrapper"><table class="grid-table">
    <thead>
        <tr>
            <th class="th-class" style="vertical-align:bottom; padding-bottom:10px;"><span style="font-size:1.1rem; color:#2c3e50;">${name}</span></th>
            ${visibleSubjects.map(s => {
                const safeS = s.replace(/'/g, "\\'");
                return `<th class="th-vertical"><span class="del-badge" onclick="delSubject('${safeS}')">√ó</span><div class="th-text-wrapper">${s}</div></th>`;
            }).join('')}
            <th class="th-vertical" style="vertical-align:bottom;"><div style="writing-mode:vertical-rl; transform:rotate(180deg); color:#2c3e50; font-weight:bold; height:auto; margin:0 auto;">TOTAL</div></th>
        </tr>
    </thead>
    <tbody>
    
    <tr style="background:#fcf3ff;"><td style="text-align:center; font-weight:bold; color:#8e44ad; font-size:0.75rem;">Coeff.</td>
    ${visibleSubjects.map(s => `<td><input class="inp-coef" value="${DATA.levelConfig[name][s].coef || 1}" onchange="updLvl('${safeName}','${s.replace(/'/g, "\\'")}','coef',this.value)"></td>`).join('')}
    <td style="background:#f4f6f9;"></td></tr>
    
    <tr style="background:#fff;"><td style="text-align:center; font-weight:bold; color:#7f8c8d; font-size:0.75rem;">Off.</td>
    ${visibleSubjects.map(s => {
        const m = DATA.subjectMeta[s];
        if (m.mode === 'level') return `<td style="background:#fdf2e9; color:#d35400; font-weight:bold; text-align:center;">${m.volLevel[name] || 0}</td>`;
        return `<td><input class="inp-hours" value="${DATA.levelConfig[name][s].base}" onchange="updLvl('${safeName}','${s.replace(/'/g, "\\'")}','base',this.value)"></td>`;
    }).join('')}
    <td rowspan="2" id="tot-lvl" style="font-weight:bold; font-size:1.1rem; vertical-align:middle;">-</td></tr>
    
    <tr style="background:#fffcf5;"><td style="text-align:center; font-weight:bold; color:#d35400; font-size:0.65rem;">Autonomie</td>
    ${visibleSubjects.map(s => {
        if (DATA.subjectMeta[s].mode === 'level') return `<td style="background:#fdf2e9;"></td>`; 
        return `<td><input class="inp-marge" value="${DATA.levelConfig[name][s].marge}" onchange="updLvl('${safeName}','${s.replace(/'/g, "\\'")}','marge',this.value)"></td>`;
    }).join('')}
    </tr>
    
    <tr style="height:15px; background:#f4f6f9;"><td colspan="${visibleSubjects.length+2}"></td></tr>`;
    
    // 4. CALCUL DES CLASSES
    let grandTotalLevel = 0;
    let colTotals = {}; 
    visibleSubjects.forEach(s => colTotals[s] = 0);

    for(let i=0; i<lvl.div; i++) {
        const c = `${prefix}${String.fromCharCode(65+i)}`;
        const safeC = c.replace(/'/g, "\\'");
        const isOv = !!DATA.classOverrides[c]; 
        let rowT = 0; 
        const displayName = (DATA.classNames && DATA.classNames[c]) ? DATA.classNames[c] : c;

        h += `<tr style="background:${isOv ? '#eaf2f8' : 'white'}">
            <td class="td-class">
                <button class="class-name-btn" onclick="renameClass('${safeC}')">${displayName}</button>
                <label style="display:block; font-size:0.6rem;"><input type="checkbox" ${isOv?'checked':''} onchange="toggleOv('${safeC}')"> Perso.</label>
            </td>`;
            
        visibleSubjects.forEach(s => {
            if (DATA.subjectMeta[s].mode === 'level') {
                h += `<td style="background:#fdf2e9; color:#ccc; text-align:center;">-</td>`;
            } else {
                let v = isOv && DATA.classOverrides[c][s] ? DATA.classOverrides[c][s] : DATA.levelConfig[name][s];
                const cellTotal = ((v.base||0) + (v.marge||0)) * (DATA.levelConfig[name][s].coef || 1.0);
                rowT += cellTotal; colTotals[s] += cellTotal; 
                h += `<td style="${isOv?'':'opacity:0.6; pointer-events:none;'}"><div class="vertical-stack"><input class="inp-hours" value="${v.base}" onchange="updOv('${safeC}','${s.replace(/'/g, "\\'")}','base',this.value)"><input class="inp-marge" value="${v.marge}" onchange="updOv('${safeC}','${s.replace(/'/g, "\\'")}','marge',this.value)"></div></td>`;
            }
        });
        grandTotalLevel += rowT;
        h += `<td style="font-weight:bold;">${rowT.toFixed(1)}</td></tr>`;
    }

    // 5. LOGIQUE EDS : On affiche uniquement la ligne de r√©sum√© global du niveau
    let totalEdsNiveau = 0;
    const lowerName = name.toLowerCase();
    let levelKey = "";
    
    if (lowerName.includes("1") || lowerName.includes("prem")) levelKey = "premiere";
    else if (lowerName.includes("term") || lowerName.includes("tle")) levelKey = "terminale";

    if (levelKey && DATA.eds && DATA.eds[levelKey]) {
        DATA.eds[levelKey].forEach(e => {
            const vol = parseFloat(e.hPerGroup) || (levelKey === 'premiere' ? 4 : 6);
            totalEdsNiveau += (parseFloat(e.groups) || 0) * vol;
        });
    }

    if (totalEdsNiveau > 0) {
        h += `<tr style="background:#ebf5fb; font-style:italic; font-weight:bold; color:#2980b9;">
            <td style="text-align:right; padding-right:10px;">üéì Sp√©cialit√©s (EDS)</td>
            <td colspan="${visibleSubjects.length}" style="text-align:left; padding-left:20px; color:#7f8c8d; font-weight:normal;">
                Volume global calcul√© dans l'onglet Sp√©cialit√©s
            </td>
            <td>${totalEdsNiveau.toFixed(1)}</td>
        </tr>`;
        grandTotalLevel += totalEdsNiveau;
    }

    // 6. PIED DE TABLEAU
    h += `<tr style="background:#34495e; color:white; font-weight:bold;">
            <td style="text-align:right; padding-right:10px;">TOTAL NIV.</td>`;
    visibleSubjects.forEach(s => {
        const m = DATA.subjectMeta[s];
        if (m.mode === 'level') {
            const vol = parseFloat(m.volLevel[name] || 0);
            h += `<td>${vol.toFixed(1)}</td>`;
            grandTotalLevel += vol;
        } else {
            h += `<td>${colTotals[s].toFixed(1)}</td>`;
        }
    });
    h += `<td id="total-final-grille" style="font-size:1.1rem; color:#f1c40f;">${grandTotalLevel.toFixed(1)}</td></tr>`;

    cont.innerHTML = h + '</tbody></table></div>';

    // Mise √† jour des compteurs et KPI
    let totConf = 0; 
    visibleSubjects.forEach(s => {
        const m = DATA.subjectMeta[s];
        if (m.mode === 'level') totConf += parseFloat(m.volLevel[name] || 0);
        else totConf += (DATA.levelConfig[name][s].base + DATA.levelConfig[name][s].marge) * (DATA.levelConfig[name][s].coef || 1);
    });
    const el = document.getElementById('tot-lvl');
    if(el) el.innerText = totConf.toFixed(1);

    updateGridCounter();
}

function renderGlobalGrid() {
    const cont = document.getElementById('grid-container');
    
    // S√©paration des mati√®res par mode pour l'organisation des colonnes
    const subjectsDiv = DATA.subjects.filter(s => DATA.subjectMeta[s].mode === 'div');
    const subjectsLevel = DATA.subjects.filter(s => DATA.subjectMeta[s].mode === 'level');
    const subjectsEtab = DATA.subjects.filter(s => DATA.subjectMeta[s].mode === 'etab');
    
    let totalDecharges = 0;
    DATA.teachers.forEach(t => totalDecharges += (t.decharge || 0));

    let grandTotalTotalEtab = 0; 
    let colTotals = {}; 
    DATA.subjects.forEach(s => colTotals[s] = 0);

    // Construction de l'en-t√™te de la table
    let h = `<div class="grid-wrapper"><table class="grid-table" style="font-size:0.8rem;">
    <thead><tr><th class="th-class" style="width:100px;">Classe / Niveau</th>
    ${subjectsDiv.map(s => `<th class="th-vertical" style="height:120px;"><div class="th-text-wrapper" style="height:80px;">${s}</div></th>`).join('')}
    ${subjectsLevel.map(s => `<th class="th-vertical" style="height:120px; background:#fdf2e9; border-bottom:2px solid #e67e22;"><div class="th-text-wrapper" style="height:80px; color:#d35400;">${s}<br>(Niv)</div></th>`).join('')}
    ${subjectsEtab.map(s => `<th class="th-vertical" style="height:120px; background:#e8f8f5; border-bottom:2px solid #1abc9c;"><div class="th-text-wrapper" style="height:80px; color:#16a085;">${s}<br>(Etab)</div></th>`).join('')}
    <th class="th-vertical" style="height:120px; background:#fffcf5; border-bottom:2px solid #f39c12;"><div class="th-text-wrapper" style="height:80px; color:#d35400;">D√©gagements<br>(Interne)</div></th>
    <th class="th-vertical" style="height:120px;"><div style="writing-mode:vertical-rl; transform:rotate(180deg); margin:0 auto;">Total</div></th>
    </tr></thead><tbody>`;

    const allPrefixes = getAllUniquePrefixes();

    DATA.structure.forEach((lvl, idx) => {
        const name = lvl.level;
        const prefix = allPrefixes[idx];
        
        let levelColTotals = {};
        DATA.subjects.forEach(s => levelColTotals[s] = 0);
        let levelRowTotalTC = 0;

        // --- 1. AFFICHAGE DES CLASSES ---
        for(let i=0; i<lvl.div; i++) {
             const c = `${prefix}${String.fromCharCode(65+i)}`;
             const displayName = (DATA.classNames && DATA.classNames[c]) ? DATA.classNames[c] : c;
             let rowTotal = 0;
             
             h += `<tr><td style="font-weight:bold; padding-left:15px;">${displayName}</td>`;
             
             subjectsDiv.forEach(s => {
                 let val = 0;
                 if(DATA.subjectMeta[s].levels && DATA.subjectMeta[s].levels.includes(name)) {
                     const isOv = DATA.classOverrides[c] && DATA.classOverrides[c][s];
                     const cfg = isOv ? DATA.classOverrides[c][s] : DATA.levelConfig[name][s];
                     val = ((cfg.base||0) + (cfg.marge||0)) * (cfg.coef || 1.0);
                 }
                 if(val > 0) {
                     levelColTotals[s] += val; 
                     colTotals[s] += val;      
                     rowTotal += val;
                 }
                 h += `<td>${val > 0 ? parseFloat(val.toFixed(2)) : '-'}</td>`;
             });
             
             // Colonnes vides pour les modes Hors-Division au niveau de la classe
             subjectsLevel.forEach(s => h += `<td style="background:#fdf2e9; opacity:0.5;">-</td>`);
             subjectsEtab.forEach(s => h += `<td style="background:#e8f8f5; opacity:0.5;">-</td>`);
             h += `<td style="background:#fffcf5; opacity:0.5;">-</td>`;
             h += `<td style="font-weight:bold;">${parseFloat(rowTotal.toFixed(2))}</td></tr>`;
             levelRowTotalTC += rowTotal;
        }

        // --- 2. GESTION DES EDS (Sp√©cialit√©s Lyc√©e) ---
        let totalEdsNiveau = 0;
        let levelKey = "";
        const lowerName = name.toLowerCase();
        
        if (lowerName.match(/1√®re|1er|1g|premi/)) {
            levelKey = "premiere";
        } else if (lowerName.match(/term|tle|tg/)) {
            levelKey = "terminale";
        }
        
        if (levelKey && DATA.eds && DATA.eds[levelKey]) {
            DATA.eds[levelKey].forEach(e => {
                const vol = parseFloat(e.hPerGroup) || (levelKey === 'premiere' ? 4 : 6);
                totalEdsNiveau += (parseFloat(e.groups) || 0) * vol;
            });
        }

        // Affichage de la ligne EDS si applicable
        if (totalEdsNiveau > 0) {
            h += `<tr style="background:#ebf5fb; font-style:italic;">
                <td style="text-align:left; padding-left:25px; color:#2980b9;">‚Ü≥ Sp√©cialit√©s (EDS)</td>
                <td colspan="${subjectsDiv.length}" style="color:#7f8c8d; font-size:0.75rem; text-align:center;">Volume global du niveau</td>`;
            
            subjectsLevel.forEach(s => h += `<td style="background:#fdf2e9; opacity:0.5;">-</td>`);
            subjectsEtab.forEach(s => h += `<td style="background:#e8f8f5; opacity:0.5;">-</td>`);
            h += `<td style="background:#fffcf5; opacity:0.5;">-</td>`;
            h += `<td style="font-weight:bold; color:#2980b9;">${totalEdsNiveau.toFixed(1)}</td></tr>`;
        }

        // --- 3. SOUS-TOTAL DU NIVEAU ---
        h += `<tr style="background:#ecf0f1; border-top:1px solid #bdc3c7; font-weight:bold;">
            <td style="text-align:right; color:#2c3e50; font-style:italic;">SOUS-TOTAL ${name.toUpperCase()}</td>`;
        
        let subRowSum = totalEdsNiveau; 
        subjectsDiv.forEach(s => {
            const val = levelColTotals[s];
            subRowSum += val;
            h += `<td style="font-size:0.85rem;">${val > 0 ? parseFloat(val.toFixed(2)) : '-'}</td>`;
        });

        subjectsLevel.forEach(s => {
            const val = DATA.subjectMeta[s].volLevel ? parseFloat(DATA.subjectMeta[s].volLevel[name] || 0) : 0;
            colTotals[s] += val;
            subRowSum += val;
            h += `<td style="background:#fae5d3; color:#d35400;">${val > 0 ? val.toFixed(1) : '-'}</td>`;
        });

        subjectsEtab.forEach(s => h += `<td style="background:#e8f8f5;">-</td>`);
        h += `<td style="background:#fffcf5;">-</td>`;

        grandTotalTotalEtab += subRowSum; 
        h += `<td style="background:#bdc3c7; color:#2c3e50;">${subRowSum.toFixed(1)}</td></tr>`;
    });

    // --- 4. PIED DE TABLEAU (TOTAL G√âN√âRAL √âTABLISSEMENT) ---
    h += `<tr style="background:#2c3e50; color:white; font-weight:bold; border-top:3px solid #34495e;">
          <td style="text-align:right; padding-right:10px;">TOTAL G√âN√âRAL</td>`;
    
    subjectsDiv.forEach(s => h += `<td>${colTotals[s] > 0 ? colTotals[s].toFixed(1) : '-'}</td>`);
    subjectsLevel.forEach(s => h += `<td style="color:#e67e22;">${colTotals[s] > 0 ? colTotals[s].toFixed(1) : '-'}</td>`);
    
    // Affichage forc√© des mati√®res au forfait √âtablissement
    subjectsEtab.forEach(s => {
        let val = parseFloat(DATA.subjectMeta[s].etab || 0);
        grandTotalTotalEtab += val;
        h += `<td style="color:#1abc9c; font-size:1rem;">${val > 0 ? val.toFixed(1) : '0.0'}</td>`;
    });
    
    h += `<td style="background:#f39c12; color:white; font-size:1rem;">${totalDecharges > 0 ? totalDecharges.toFixed(1) : '-'}</td>`;
    grandTotalTotalEtab += totalDecharges;

    h += `<td style="background:#16a085; color:white; font-size:1.2rem;">${grandTotalTotalEtab.toFixed(1)}</td></tr>`;

    cont.innerHTML = h + '</tbody></table></div>';
}

function openWeightingMenu() {
    const choice = prompt("Gestion des Coefficients (Pond√©ration)\n\nEntrez une valeur pour l'appliquer √† TOUTES les mati√®res.\n\n(Laissez vide pour annuler)");
    if(choice) {
        const val = parseFloat(choice);
        if(!isNaN(val)) {
            if(confirm(`Appliquer le coefficient ${val} √† TOUTES les mati√®res de TOUS les niveaux ?`)) {
                DATA.structure.forEach(l => {
                    DATA.subjects.forEach(s => {
                        if(DATA.levelConfig[l.level][s]) DATA.levelConfig[l.level][s].coef = val;
                    });
                });
                saveData();
                renderGridSystem();
                alert("‚úÖ Coefficients mis √† jour !");
            }
        }
    }
}

function addSubject(){ const s=prompt("Nom ?"); if(s && !DATA.subjects.includes(s)){ 
    DATA.subjects.push(s); 
    DATA.subjectMeta[s]={ mode:'div', levels: getDefaultActiveLevels(s), etab:0, volLevel:{}, parent:"", code:""}; 
    DATA.structure.forEach(l=>DATA.levelConfig[l.level][s]={base:0,marge:0,coef:1.0}); 
    saveData(); renderGridSystem(); renderRH(); renderSubjectsConfig(); 
} }

function delSubject(s) { if(confirm("Supprimer ?")) { DATA.subjects=DATA.subjects.filter(sub=>sub!==s); delete DATA.subjectMeta[s]; Object.keys(DATA.levelConfig).forEach(l=>delete DATA.levelConfig[l][s]); saveData(); renderSubjectsConfig(); renderGridSystem(); renderRH(); } }
function updLvl(l, s, k, v) {
    DATA.levelConfig[l][s][k] = parseFloat(v) || 0;
    saveData();
	updateGridCounter();
    if (k === 'marge' || k === 'base') {
        const prefix = l.replace(/[^0-9]/g, '') || l.charAt(0);
        let ignoredClasses = [];
        Object.keys(DATA.classOverrides).forEach(c => {
            if (c.startsWith(prefix)) { 
                if (DATA.classOverrides[c][s]) {
                    const displayName = (DATA.classNames && DATA.classNames[c]) ? DATA.classNames[c] : c;
                    ignoredClasses.push(displayName);
                }
            }
        });
        if (ignoredClasses.length > 0) {
            alert(`‚ö†Ô∏è ATTENTION :\n\nVous avez modifi√© la ${k === 'marge' ? 'marge' : 'base'} pour tout le niveau ${l}.\n\nCependant, les classes suivantes sont en mode "Personnalis√©" et n'ont PAS √©t√© modifi√©es :\n\nüëâ ${ignoredClasses.join(', ')}\n\nPensez √† v√©rifier leurs horaires manuellement.`);
        }
    }
    renderLevelGrid(DATA.structure.findIndex(x => x.level === l));
}
function toggleOv(c){ 
    if(DATA.classOverrides[c]) delete DATA.classOverrides[c]; 
    else { 
        let foundLvl = null;
        for(let l of DATA.structure) {
            let p = l.level.replace(/[^0-9]/g, '') || l.level.charAt(0);
            if(c.startsWith(p)) { foundLvl=l.level; break; }
        }
        if(foundLvl) DATA.classOverrides[c]=JSON.parse(JSON.stringify(DATA.levelConfig[foundLvl])); 
    } 
    saveData(); 
    const activeTab = document.querySelector('.tab.active');
    if(activeTab) changeTab(activeTab, window.lastActiveGridTab);
}
function updOv(c,s,k,v){ 
    DATA.classOverrides[c][s][k] = parseFloat(v)||0; 
    saveData(); 
	updateGridCounter();
    const activeTab = document.querySelector('.tab.active');
    if(activeTab) changeTab(activeTab, window.lastActiveGridTab);
}

function renderSubjectsConfig() { 
    const t = document.getElementById('subjects-body'); 
    t.innerHTML = ''; 
    
    const sortedSubjects = [...DATA.subjects].sort();

    sortedSubjects.forEach(s => { 
        const m = DATA.subjectMeta[s];
        const safeS = s.replace(/'/g, "\\'"); 

        // 1. Select Parent
        let parentOptions = `<option value="">(Aucun - Racine)</option>`;
        sortedSubjects.forEach(parentName => {
            if (parentName !== s) {
                const isSelected = m.parent === parentName ? 'selected' : '';
                parentOptions += `<option value="${parentName}" ${isSelected}>${parentName}</option>`;
            }
        });

        // 2. BOUTON MODALE (Remplacement de la liste)
        // On compte combien de mati√®res sont d√©j√† li√©es pour l'afficher sur le bouton
        const linkCount = (m.linkedSubjects && m.linkedSubjects.length > 0) ? m.linkedSubjects.length : 0;
        
        // Style du bouton : Gris si 0, Bleu si des liens existent
        const btnStyle = linkCount > 0 
            ? "background:#3498db; color:white; border:1px solid #2980b9;" 
            : "background:white; color:#7f8c8d; border:1px solid #bdc3c7;";
            
        const linkedBtn = `
            <button class="btn btn-sm" 
                    style="${btnStyle} width:100%; display:flex; justify-content:center; align-items:center; gap:5px;"
                    onclick="openLinkedSubjectsModal('${safeS}')">
                <span>üîó G√©rer</span>
                <span style="background:rgba(0,0,0,0.2); padding:1px 6px; border-radius:10px; font-size:0.75rem;">${linkCount}</span>
            </button>
        `;

        // 3. Param√®tres (Niveaux/Volumes)
        let paramHtml = "";
        if (m.mode === 'div') {
            paramHtml = `<div class="lvl-check-container">`;
            DATA.structure.forEach(lvl => {
                const isChecked = m.levels && m.levels.includes(lvl.level);
                const safeLvl = lvl.level.replace(/'/g, "\\'");
                paramHtml += `<label class="lvl-check-item"><input type="checkbox" ${isChecked?'checked':''} onchange="toggleSubLevel('${safeS}','${safeLvl}')">${lvl.level}</label>`;
            });
            paramHtml += `</div>`;
        } else if (m.mode === 'level') {
            paramHtml = `<div style="display:flex; flex-wrap:wrap; gap:8px;">`;
            DATA.structure.forEach(lvl => {
                const val = m.volLevel ? (m.volLevel[lvl.level] || 0) : 0;
                const safeLvl = lvl.level.replace(/'/g, "\\'");
                paramHtml += `<div class="lvl-input-item" style="background:#fff; border:1px solid #ddd; padding:2px 6px; border-radius:4px;"><span style="font-size:0.8rem; font-weight:bold;">${lvl.level}:</span><input type="number" step="0.5" value="${val}" style="width:50px !important; text-align:center; height:24px;" onchange="updSubVolLevel('${safeS}','${safeLvl}',this.value)"></div>`;
            });
            paramHtml += `</div>`;
        } else if (m.mode === 'etab') {
             paramHtml = `<div class="lvl-input-item"><span style="font-weight:bold; color:#16a085;">Forfait :</span><input type="number" step="0.5" value="${m.etab||0}" style="width:80px !important; text-align:center; font-weight:bold; color:#16a085; border:2px solid #1abc9c; margin-left: 10px;" onchange="updSubEtab('${safeS}',this.value)"></div>`;
        }

        t.innerHTML += `<tr>
            <td style="width:80px;"><input type="text" value="${m.code||''}" placeholder="Code" style="font-family:monospace; text-align:center;" onchange="updateSubjectMeta('${safeS}','code',this.value)"></td>
            <td><input type="text" value="${s}" style="font-weight:bold;" onchange="renameSubject('${safeS}',this.value)"></td>
            <td style="width:180px;"><select style="font-size:0.9rem;" onchange="updateSubjectMeta('${safeS}','parent',this.value)">${parentOptions}</select></td>
            
            <td style="width:140px; text-align:center;">${linkedBtn}</td>

            <td style="width:160px;">
                <select onchange="updateSubjectMeta('${safeS}','mode',this.value)">
                    <option value="div" ${m.mode==='div'?'selected':''}>Division</option>
                    <option value="level" ${m.mode==='level'?'selected':''}>Niveau</option>
                    <option value="etab" ${m.mode==='etab'?'selected':''}>√âtablissement</option>
                </select>
            </td>
            <td style="text-align:left;">${paramHtml}</td>
            <td style="width:50px;"><button class="btn btn-danger btn-sm" onclick="delSubject('${safeS}')">√ó</button></td>
        </tr>`; 
    }); 
}

/**
 * Active ou d√©sactive le lien entre deux mati√®res
 * @param {string} targetSubject - La mati√®re principale (ex: "Ens. Scientifique")
 * @param {string} linkedSubject - La mati√®re √† autoriser (ex: "Maths")
 */
function toggleLinkedSubject(targetSubject, linkedSubject) {
    if (!DATA.subjectMeta[targetSubject]) return;
    
    // Initialisation du tableau si inexistant
    if (!DATA.subjectMeta[targetSubject].linkedSubjects) {
        DATA.subjectMeta[targetSubject].linkedSubjects = [];
    }
    
    const arr = DATA.subjectMeta[targetSubject].linkedSubjects;
    const idx = arr.indexOf(linkedSubject);
    
    if (idx > -1) {
        // Si existe d√©j√†, on retire
        arr.splice(idx, 1);
    } else {
        // Sinon, on ajoute
        arr.push(linkedSubject);
    }
    
    saveData();
    // On ne recharge pas toute la vue pour ne pas perdre le scroll ou le focus,
    // La sauvegarde suffit car l'√©tat visuel (checked) a d√©j√† chang√© via le clic.
}

function updateSubjectMeta(s,f,v){ 
    if(!DATA.subjectMeta[s]) DATA.subjectMeta[s]={}; 
    DATA.subjectMeta[s][f]=v; 
    
    if(f === 'mode') {
         if(v === 'div' && !DATA.subjectMeta[s].levels) DATA.subjectMeta[s].levels = getDefaultActiveLevels(s);
         if(v === 'level' && !DATA.subjectMeta[s].volLevel) DATA.subjectMeta[s].volLevel = {};
    }
    
    saveData(); 
    renderSubjectsConfig();
}
function toggleSubLevel(s, lvl) {
    if(!DATA.subjectMeta[s].levels) DATA.subjectMeta[s].levels = [];
    const arr = DATA.subjectMeta[s].levels;
    if(arr.includes(lvl)) DATA.subjectMeta[s].levels = arr.filter(x => x !== lvl);
    else arr.push(lvl);
    saveData();
}
function updSubVolLevel(s, lvl, val) {
    if(!DATA.subjectMeta[s].volLevel) DATA.subjectMeta[s].volLevel = {};
    DATA.subjectMeta[s].volLevel[lvl] = parseFloat(val) || 0;
    saveData();
}
function updSubEtab(s, val) {
    DATA.subjectMeta[s].etab = parseFloat(val) || 0;
    saveData();
}

function renameSubject(oldName, newName) { 
    if(!newName || newName===oldName) { renderSubjectsConfig(); return; }
    if(DATA.subjects.includes(newName)) { alert("Ce nom existe d√©j√† !"); renderSubjectsConfig(); return; }

    DATA.subjects[DATA.subjects.indexOf(oldName)] = newName; 
    
    if(DATA.subjectMeta[oldName]){
        DATA.subjectMeta[newName] = DATA.subjectMeta[oldName];
        delete DATA.subjectMeta[oldName];
    }
    
    Object.keys(DATA.subjectMeta).forEach(s => { 
        if(DATA.subjectMeta[s].parent === oldName) {
            DATA.subjectMeta[s].parent = newName;
        }
    }); 
    
    Object.keys(DATA.levelConfig).forEach(l => {
        if(DATA.levelConfig[l][oldName]){
            DATA.levelConfig[l][newName] = DATA.levelConfig[l][oldName];
            delete DATA.levelConfig[l][oldName];
        }
    }); 
    
    Object.keys(DATA.classOverrides).forEach(c => {
        if(DATA.classOverrides[c][oldName]) {
            DATA.classOverrides[c][newName] = DATA.classOverrides[c][oldName];
            delete DATA.classOverrides[c][oldName];
        }
    });

    DATA.teachers.forEach(t => {
        if(t.subject === oldName) t.subject = newName;
    }); 
    
    saveData(); 
    renderSubjectsConfig();
    
    if(document.getElementById('ventilation').classList.contains('active')) renderGridSystem();
}

// ------------------------------------------------------------------------------------------------
// VUE PILOTAGE (DISCIPLINE) - Mise √† jour V2.9 (Prise en compte CSD + D√©charges)
// ------------------------------------------------------------------------------------------------
function renderRHDisc() {
    const needs = calculateNeeds();
    const tBody = document.getElementById('rh-disc-body');
    const tFoot = document.getElementById('rh-disc-total');
    tBody.innerHTML = '';
    
    const roots = DATA.subjects.filter(s => !DATA.subjectMeta[s]?.parent).sort();

    const getStats = (sub) => {
        const profs = DATA.teachers.map((t, idx) => ({...t, idx: idx})).filter(t => t.subject === sub);
        const dechInt = profs.reduce((a,t)=>a+(t.decharge||0), 0);
        const dechExt = profs.reduce((a,t)=>a+(t.dech_ext||0), 0);
        const hp = profs.reduce((a,t)=> a + (t.ors - (t.csd||0) - (t.dech_ext||0)), 0);
        const hsa = profs.reduce((a,t)=>a+t.hsa, 0);
        const bes = (needs[sub] || 0) + dechInt;
        const app = hp + hsa;
        return { bes, app, hp, hsa, profs };
    };

    roots.forEach(r => {
        const rStats = getStats(r);
        const safeR = r.replace(/'/g, "\\'");
        const kids = DATA.subjects.filter(s => DATA.subjectMeta[s]?.parent === r);
        
        if (kids.length > 0) {
            let poleBes = rStats.bes;
            let poleApp = rStats.app;
            let poleHP = rStats.hp;
            let poleHSA = rStats.hsa;
            
            const kidsData = kids.map(k => {
                const kStats = getStats(k);
                poleBes += kStats.bes;
                poleApp += kStats.app;
                poleHP += kStats.hp;
                poleHSA += kStats.hsa;
                return { name: k, stats: kStats };
            });

            const soldePole = poleApp - poleBes;
            
            // EN-T√äTE P√îLE (Gris Anthracite)
            tBody.innerHTML += `<tr class="row-header">
                <td style="text-align:left; padding-left:10px;">üì¶ P√îLE ${r.toUpperCase()}</td>
                <td style="color:#f1c40f;">${poleBes.toFixed(1)}</td>
                <td style="color:#81d4fa;">${poleApp.toFixed(1)}</td>
                <td>${poleHP.toFixed(1)}</td>
                <td>${poleHSA.toFixed(1)}</td>
                <td style="background:${soldePole>=0?'#27ae60':'#c0392b'}; color:white;">${soldePole.toFixed(1)}</td>
            </tr>`;

            renderSubjectRow(r, rStats, true, `‚Ü≥ ${r}`, safeR);

            kidsData.forEach(kd => {
                renderSubjectRow(kd.name, kd.stats, true, `‚Ü≥ ${kd.name}`, kd.name.replace(/'/g, "\\'"));
            });

        } else {
            // MATI√àRE SOLO (Style En-t√™te Gris aussi)
            renderSubjectRow(r, rStats, false, r, safeR, true);
        }
    });

    function renderSubjectRow(name, stats, isChild, displayName, safeName, isHeader = false) {
        if(stats.bes === 0 && stats.app === 0) return;

        let rowClass = isChild ? 'row-sub-master' : 'row-master';
        let styleBes = isChild ? 'background:#fcf3cf; color:#d35400;' : 'background:#fdf2e9; color:#d35400;';
        let styleApp = isChild ? 'background:#d6eaf8; color:#2980b9;' : 'background:#ebf5fb; color:#2980b9;';
        
        if (isHeader) {
            rowClass = 'row-header';
            styleBes = 'color:#f1c40f;'; 
            styleApp = 'color:#81d4fa;'; 
        }

        const addBtn = `<button class="btn-add-subject-teacher" onclick="addTeacherToSubject('${safeName}')" style="${isHeader ? 'border:1px solid white;' : ''}">+</button>`;
        const solde = stats.app - stats.bes;
        const paddingName = isChild ? 'padding-left:20px;' : '';

        tBody.innerHTML += `<tr class="${rowClass}">
            <td style="text-align:left; display:flex; align-items:center; ${paddingName}">${displayName} ${addBtn}</td>
            <td style="${styleBes}">${stats.bes.toFixed(1)}</td>
            <td style="${styleApp}">${stats.app.toFixed(1)}</td>
            <td><small>${stats.hp.toFixed(1)}</small></td>
            <td><small>${stats.hsa.toFixed(1)}</small></td>
            <td style="color:${solde>=0 ? (isHeader?'#2ecc71':'green') : (isHeader?'#e74c3c':'red')}">${solde.toFixed(1)}</td>
        </tr>`;

        stats.profs.forEach(p => {
            let detailsTxt = "";
            
            // --- RESTAURATION : BADGES CLIQUABLES AVEC CRAYON ---
            
            // 1. BMP (Si > 0)
            if(p.bmp > 0) {
                detailsTxt += `<div onclick="setBMP(${p.idx})" title="Modifier le volume du BMP" style="cursor:pointer; background:#ebf5fb; border:1px solid #aed6f1; color:#2c3e50; font-size:0.75rem; font-weight:bold; margin-top:2px; padding:2px 5px; border-radius:4px; display:inline-flex; align-items:center; gap:5px;">
                   <span>‚òÖ BMP : ${p.bmp}h</span> <span>‚úèÔ∏è</span>
                </div><br>`;
            }
            
            // 2. CSD (Si > 0)
            if(p.csd > 0) {
                detailsTxt += `<div onclick="setCSD(${p.idx})" title="Modifier le volume CSD" style="cursor:pointer; background:#fdf2e9; border:1px solid #fad7a0; color:#e67e22; font-size:0.75rem; font-weight:bold; margin-top:2px; padding:2px 5px; border-radius:4px; display:inline-flex; align-items:center; gap:5px;">
                   <span>(Dont ${p.csd}h CSD)</span> <span>‚úèÔ∏è</span>
                </div><br>`;
            }

            // (Autres d√©charges : informatif seulement pour l'instant)
            if(p.decharge > 0) detailsTxt += `<span style="color:#8e44ad; font-size:0.7rem; display:block; margin-top:2px;">(Dont ${p.decharge}h DGH)</span>`;
            if(p.dech_ext > 0) detailsTxt += `<span style="color:#27ae60; font-size:0.7rem; display:block; margin-top:2px;">(Dont ${p.dech_ext}h Rect.)</span>`;

            const realContribution = (p.ors - (p.csd||0) - (p.dech_ext||0)) + p.hsa;
            const paddingProf = isChild ? 'padding-left:50px;' : 'padding-left:30px;';

            // Boutons d'ajout (colonne 1) : Masqu√©s si valeur d√©j√† saisie
            const btnBmp = (p.bmp > 0) 
                ? '' 
                : `<button onclick="setBMP(${p.idx})" style="cursor:pointer; background:#34495e; color:white; border:none; border-radius:3px; padding:1px 5px; font-size:0.65rem; margin-left:5px;" title="D√©finir BMP">BMP ?</button>`;

            const btnCsd = (p.csd > 0) 
                ? '' 
                : `<button onclick="setCSD(${p.idx})" style="cursor:pointer; background:#17a2b8; color:white; border:none; border-radius:3px; padding:1px 5px; font-size:0.65rem; margin-left:5px;" title="D√©finir CSD">CSD ?</button>`;

            tBody.innerHTML += `<tr class="row-detail">
                <td style="${paddingProf} text-align:left; display:flex; align-items:center;">
                    <span style="color:#bdc3c7; margin-right:5px;">‚Ü≥</span>
                    <input type="text" value="${p.name}" onchange="updT(${p.idx},'name',this.value)" style="border:none; border-bottom:1px dashed #bdc3c7; background:transparent; width:140px; color:#2c3e50; font-weight:500;" placeholder="Nom">
                    ${btnBmp} ${btnCsd}
                    <span style="font-size:0.75rem; color:#999; margin-left:5px;">(${p.status})</span>
                </td>
                <td colspan="2"></td>
                <td>
                    <input type="number" class="input-inline" value="${p.ors}" step="0.5" onchange="updT(${p.idx},'ors',this.value)">
                    <div style="display:flex; flex-direction:column; align-items:center;">${detailsTxt}</div>
                </td>
                <td><input type="number" class="input-inline" value="${p.hsa}" step="0.5" onchange="updT(${p.idx},'hsa',this.value)"></td>
                <td style="font-weight:bold; color:#7f8c8d;">${realContribution.toFixed(1)}</td>
            </tr>`;
        });
    }
    
    // Totaux
    let realHP=0, realHSA=0, realBesoin = 0; 
    DATA.teachers.forEach(t=>{ 
        realHP += (t.ors - (t.csd||0) - (t.dech_ext||0)); 
        realHSA += t.hsa; 
        realBesoin += (t.decharge || 0);
    });
    Object.values(needs).forEach(v=>realBesoin+=v);
    const realApport = realHP + realHSA;

    tFoot.innerHTML = `<td>TOTAUX G√âN√âRAUX</td>
        <td>${realBesoin.toFixed(1)}</td>
        <td>${realApport.toFixed(1)}</td>
        <td>HP:${realHP.toFixed(1)}</td>
        <td>HSA:${realHSA.toFixed(1)}</td>
        <td style="background:${(realApport-realBesoin)>=0?'var(--success)':'var(--danger)'}; color:white;">${(realApport-realBesoin).toFixed(1)}</td>`;
}

function updateYear(v){ DATA.config.year=parseInt(v); saveData(); }
function updateGlobalDHG(){ DATA.config.hp=parseFloat(document.getElementById('global-hp').value); DATA.config.hsa=parseFloat(document.getElementById('global-hsa').value); saveData(); calculateRecap(); }
function saveData(a){ localStorage.setItem('DHG_Data_V9', JSON.stringify(DATA)); if(a) alert("‚úÖ Sauvegard√©"); }

function loadSaveFile(input) {
    const f = input.files[0];
    if (!f) return;
    const r = new FileReader();
    r.onload = e => {
        try {
            let loadedData = JSON.parse(e.target.result);
            
            // --- MIGRATIONS & INITIALISATIONS ---
            // On garde les migrations existantes si elles sont d√©finies dans ton code
            if (typeof migrateV18toV19 === 'function') {
                loadedData = migrateV18toV19(loadedData);
            }
            
            // Initialisations V3
            if (!loadedData.assignments) loadedData.assignments = {}; 
            if (!loadedData.config) loadedData.config = { year: new Date().getFullYear(), total: 0, hp: 0, hsa: 0 };
            if (loadedData.teachers) {
                loadedData.teachers.forEach(p => {
                    if (p.csd === undefined) p.csd = 0;
                    if (p.decharge === undefined) p.decharge = 0;
                    if (p.dech_ext === undefined) p.dech_ext = 0; 
                });
            }

            // --- CHARGEMENT EN M√âMOIRE ---
            DATA = loadedData;

            // --- D√âTECTION INTELLIGENTE (LGT vs COLL√àGE) ---
            let isLGT = false;
            // On s√©curise la lecture de la structure pour √©viter le bug "Fichier corrompu"
            if (DATA.structure && Array.isArray(DATA.structure)) {
                isLGT = DATA.structure.some(lvl => {
                    // On g√®re les deux noms de propri√©t√©s possibles (.level ou .name)
                    const nom = lvl.level || lvl.name || ""; 
                    return nom.includes("1√®re") || nom.includes("Terminale");
                });
            }

            // --- D√âCISION ---
            if (isLGT) {
                // Cas LGT : On sauvegarde et on lance l'assistant de nettoyage
                saveData(); 
                alert("‚úÖ Fichier charg√© ! Une √©tape de v√©rification des Sp√©cialit√©s va s'ouvrir pour nettoyer votre grille.");
                
                if (typeof showEdsIdentificationModal === 'function') {
                    showEdsIdentificationModal(); 
                } else {
                    console.error("Fonction showEdsIdentificationModal introuvable, rechargement standard.");
                    location.reload();
                }
                return; // STOP : On ne recharge pas la page tout de suite
            }
            
            // Cas Autre (Coll√®ge) : On termine normalement
            saveData();
            alert("‚úÖ Fichier charg√© avec succ√®s !");
            location.reload();
            
        } catch (err) {
            console.error("Erreur import:", err);
            alert("‚ùå Erreur : Le fichier semble corrompu ou illisible.\n(D√©tails dans la console F12)");
        }
    };
    r.readAsText(f);
    input.value = '';
}


function showEdsIdentificationModal() {
    // 1. Cr√©ation de l'interface (Overlay + Fen√™tre)
    const overlay = document.createElement('div');
    overlay.id = 'eds-check-overlay';
    overlay.style = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.85); z-index: 10000;
        display: flex; justify-content: center; align-items: center;
    `;

    const modal = document.createElement('div');
    modal.style = `
        background: white; padding: 25px; border-radius: 12px;
        width: 600px; max-height: 90vh; display: flex; flex-direction: column;
        box-shadow: 0 10px 40px rgba(0,0,0,0.5); font-family: 'Segoe UI', sans-serif;
    `;

    // 2. Contenu HTML de la fen√™tre
    modal.innerHTML = `
        <h2 style="margin-top:0; color:#2c3e50;">üßπ Nettoyage de la Grille (LGT)</h2>
        <p style="color:#666; font-size:0.9rem; margin-bottom:20px;">
            Cochez les mati√®res qui sont des <strong>Sp√©cialit√©s (EDS)</strong>.<br>
            <em>Elles seront masqu√©es de la grille horaire principale pour √©viter les doublons et all√©ger l'affichage.</em>
        </p>
        <div style="flex:1; overflow-y:auto; border:1px solid #eee; border-radius:8px; padding:10px; margin-bottom:20px;" id="eds-check-list">
            </div>
        <div style="display:flex; justify-content:flex-end; gap:10px;">
            <button id="btn-skip-eds" style="padding:10px 20px; background:#bdc3c7; border:none; border-radius:6px; cursor:pointer; font-weight:bold; color:white;">Passer (Tout garder)</button>
            <button id="btn-save-eds" style="padding:10px 20px; background:#27ae60; border:none; border-radius:6px; cursor:pointer; font-weight:bold; color:white;">Valider & Masquer</button>
        </div>
    `;

    // 3. G√©n√©ration de la liste des mati√®res
    const listContainer = modal.querySelector('#eds-check-list');
    const sortedSubjects = DATA.subjects.slice().sort(); // Tri alphab√©tique

    let htmlTable = `<table style="width:100%; border-collapse:collapse;">
        <tr style="background:#f8f9fa; text-align:left; color:#7f8c8d;">
            <th style="padding:8px;">Mati√®re</th>
            <th style="padding:8px; text-align:center;">Masquer en 1√®re ?</th>
            <th style="padding:8px; text-align:center;">Masquer en Term ?</th>
        </tr>`;

    sortedSubjects.forEach(sub => {
        const meta = DATA.subjectMeta[sub] || {};
        
        // On essaye de deviner si c'est d√©j√† un EDS pour pr√©-cocher
        const isLikelyEds = meta.isEds || meta.parent === "Sp√©cialit√©s";
        const hasPrem = meta.levels && meta.levels.some(l => l.includes('1√®re'));
        const hasTerm = meta.levels && meta.levels.some(l => l.includes('Term'));

        htmlTable += `
            <tr style="border-bottom:1px solid #eee;">
                <td style="padding:8px; font-weight:500;">${sub}</td>
                <td style="padding:8px; text-align:center;">
                    <input type="checkbox" class="chk-prem" data-sub="${sub}" 
                           ${(isLikelyEds && hasPrem) ? 'checked' : ''} 
                           style="transform:scale(1.3); cursor:pointer;">
                </td>
                <td style="padding:8px; text-align:center;">
                    <input type="checkbox" class="chk-term" data-sub="${sub}" 
                           ${(isLikelyEds && hasTerm) ? 'checked' : ''} 
                           style="transform:scale(1.3); cursor:pointer;">
                </td>
            </tr>
        `;
    });
    htmlTable += `</table>`;
    listContainer.innerHTML = htmlTable;

    overlay.appendChild(modal);
    document.body.appendChild(overlay);

    // --- 4. GESTION DES CLICS ---

    // Bouton "Passer"
    document.getElementById('btn-skip-eds').onclick = () => {
        if(confirm("Aucune mati√®re ne sera masqu√©e. Continuer ?")) {
            document.body.removeChild(overlay);
            location.reload();
        }
    };

    // Bouton "Valider" (Logique de Nettoyage Uniquement)
    document.getElementById('btn-save-eds').onclick = () => {
        const rows = listContainer.querySelectorAll('tr');
        
        // On parcourt chaque ligne du tableau (sauf l'en-t√™te)
        for (let i = 1; i < rows.length; i++) {
            const row = rows[i];
            const chkPrem = row.querySelector('.chk-prem');
            const chkTerm = row.querySelector('.chk-term');
            const subjectName = chkPrem.getAttribute('data-sub');
            
            // Si au moins une case est coch√©e pour cette mati√®re
            if (chkPrem.checked || chkTerm.checked) {
                if (!DATA.subjectMeta[subjectName]) DATA.subjectMeta[subjectName] = {};
                
                // A. On active le masquage (isEds)
                DATA.subjectMeta[subjectName].isEds = true;
                DATA.subjectMeta[subjectName].mode = 'level';
                DATA.subjectMeta[subjectName].parent = "Sp√©cialit√©s";
                
                // B. On supprime les heures manuelles de la grille (Nettoyage)
                DATA.subjectMeta[subjectName].volLevel = {}; 

                // C. On met √† jour les niveaux concern√©s
                let levels = [];
                if (chkPrem.checked) levels.push("1√®re");
                if (chkTerm.checked) levels.push("Terminale");
                DATA.subjectMeta[subjectName].levels = levels;
                
                // NOTE : On n'ajoute PAS la mati√®re dans le tableau EDS du bas (DATA.eds).
                // Elle est juste masqu√©e de la grille principale.
            }
        }

        saveData();
        alert("‚úÖ Grille nettoy√©e ! Les mati√®res s√©lectionn√©es ont √©t√© masqu√©es.");
        document.body.removeChild(overlay);
        location.reload(); // Rechargement final pour afficher le r√©sultat
    };
}

// Fonction utilitaire pour cr√©er l'entr√©e dans le tableau EDS du bas si elle n'existe pas
function ensureEdsExistsInManager(levelCode, subjectName) {
    if (!DATA.eds) DATA.eds = { premiere: [], terminale: [] };
    if (!DATA.eds[levelCode]) DATA.eds[levelCode] = [];

    const exists = DATA.eds[levelCode].some(e => e.name === subjectName);
    if (!exists) {
        DATA.eds[levelCode].push({
            name: subjectName,
            students: 0,
            groups: 0,
            hPerGroup: (levelCode === 'premiere' ? 4 : 6) // Forfait par d√©faut (4h ou 6h)
        });
    }
}
function migrateV18toV19(data) {
    if (!data.subjects || !data.structure) return data;
    const allLevels = data.structure.map(l => l.level);
    if (!data.subjectMeta) data.subjectMeta = {};

    data.subjects.forEach(s => {
        if (!data.subjectMeta[s]) data.subjectMeta[s] = {};
        const meta = data.subjectMeta[s];

        if (!meta.mode) {
            if (meta.type === 'div' || !meta.type) meta.mode = 'div';
            else if (meta.type === 'etab') meta.mode = 'etab';
            else if (meta.type === 'level') meta.mode = 'level';
        }

        if (!meta.levels || !Array.isArray(meta.levels)) {
            if (s.includes("Techno") || s.includes("Espagnol") || s.includes("LV2")) {
                meta.levels = allLevels.filter(l => !l.includes("6"));
            } else if (s.includes("Philosophie")) {
                meta.levels = allLevels.filter(l => l.toLowerCase().includes("term"));
            } else {
                meta.levels = [...allLevels]; 
            }
        }

        if (meta.etab === undefined) meta.etab = 0;
        if (!meta.volLevel) meta.volLevel = {};
        if (!meta.code) meta.code = "";
    });

    return data;
}

// --- FONCTION DE SAUVEGARDE SUR DISQUE (Correction) ---
function downloadSaveFile() {
    const dateStr = new Date().toISOString().slice(0, 10);
    const filename = `DHG_Manager_Export_${dateStr}.data`;
    
    // On convertit l'objet DATA en cha√Æne JSON propre
    const blob = new Blob([JSON.stringify(DATA)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    
    // Cr√©ation d'un lien invisible pour d√©clencher le t√©l√©chargement
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    
    // Nettoyage
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

function switchRHView(mode) { 
    document.getElementById('rh-view-list').style.display=mode==='list'?'block':'none'; 
    document.getElementById('rh-view-disc').style.display=mode==='disc'?'block':'none'; 
    document.getElementById('btn-view-list').classList.toggle('active',mode==='list'); 
    document.getElementById('btn-view-disc').classList.toggle('active',mode==='disc'); 
    if(mode==='disc') renderRHDisc(); 
}

function toggleRhCodes() { showRhCodes = !showRhCodes; document.getElementById('btn-toggle-codes').classList.toggle('active', showRhCodes); renderRH(); }

// ------------------------------------------------------------------------------------------------
// GESTION RH (CORRECTIF V2.9.2) - Correction alignement hauteur des boutons
// ------------------------------------------------------------------------------------------------
function renderRH() { 
    const t = document.getElementById('rh-body'); 
    t.innerHTML = ''; 
    const headers = document.querySelectorAll('#rh-table-list th');
    headers.forEach(h => { if(h.classList.contains('col-code-header')) h.style.display = showRhCodes ? 'table-cell' : 'none'; });

    // 1. CR√âATION D'UNE VUE TRI√âE (On garde l'index original en m√©moire)
    // Cela permet d'afficher par ordre alphab√©tique sans casser les liens avec les √âquipes P√©dagogiques
    const sortedTeachers = DATA.teachers.map((t, index) => ({...t, originalIndex: index}));
    
    // Tri alphab√©tique (insensible √† la casse et aux accents)
    sortedTeachers.sort((a, b) => a.name.localeCompare(b.name, 'fr', {sensitivity: 'base'}));

    // 2. BOUCLE D'AFFICHAGE SUR LA LISTE TRI√âE
    sortedTeachers.forEach((p) => { 
        // IMPORTANT : On utilise l'index original (p.originalIndex) pour toutes les modifications
        const i = p.originalIndex;

        // Initialisation des valeurs si manquantes
        if (p.csd === undefined) p.csd = 0;
        if (p.decharge === undefined) p.decharge = 0;
        if (p.dech_ext === undefined) p.dech_ext = 0;
        if (p.bmp === undefined) p.bmp = 0; 

        let metaCode = DATA.subjectMeta[p.subject]?.code || "";
        let codeHtml = showRhCodes ? `<td class="col-code">${metaCode}</td>` : '';
        
        let infoDisplay = ``;
        let rowStyle = ``;
        
        // Gestion des affichages conditionnels (Couleurs de lignes)
        if (p.bmp > 0) {
            infoDisplay += `<div style="font-size:0.7rem; color:#2c3e50; font-weight:bold;">‚òÖ BMP/CSR : ${p.bmp}h</div>`;
            rowStyle = `background: linear-gradient(90deg, #fff 0%, #ebf5fb 100%);`; 
        }
        if (p.csd > 0) {
            infoDisplay += `<div style="font-size:0.7rem; color:#17a2b8; font-weight:bold;">- ${p.csd}h CSD</div>`;
            if(!rowStyle) rowStyle = `background: linear-gradient(90deg, #fff 0%, #eefbfd 100%);`; 
        }
        if (p.decharge > 0) {
            infoDisplay += `<div style="font-size:0.7rem; color:#e67e22; font-weight:bold;">- ${p.decharge}h DGH</div>`;
            if(!rowStyle) rowStyle = `background: linear-gradient(90deg, #fff 0%, #fffcf5 100%);`; 
        }
        if (p.dech_ext > 0) {
            infoDisplay += `<div style="font-size:0.7rem; color:#27ae60; font-weight:bold;">- ${p.dech_ext}h Rect.</div>`;
            if(!rowStyle) rowStyle = `background: linear-gradient(90deg, #fff 0%, #eafaf1 100%);`; 
        }

        const btnStyle = "padding:2px 5px; margin:0; font-size:0.7rem;";
        
        // Boutons d'action (utilisent 'i', l'index original)
        const bmpBtn = `<button class="btn btn-sm" style="background:#34495e; color:white; ${btnStyle}" onclick="setBMP(${i})" title="D√©finir comme BMP">BMP</button>`;
        const csdBtn = `<button class="btn btn-sm" style="background:#17a2b8; color:white; ${btnStyle}" onclick="setCSD(${i})" title="CSD">CSD</button>`;
        const dechBtn = `<button class="btn btn-sm" style="background:#9b59b6; color:white; ${btnStyle}" onclick="openDechargeMenu(${i})" title="D√©charge">D√©ch.</button>`;
        
        const children = DATA.subjects.filter(s => DATA.subjectMeta[s].parent === p.subject);
        let splitBtn = '';
        if (children.length > 0) {
            splitBtn = `<button class="btn btn-warning btn-sm" style="${btnStyle}" onclick="splitTeacher(${i})" title="Ventiler">‚úÇÔ∏è</button>`;
        }

        t.innerHTML += `<tr style="${rowStyle}">
            <td style="vertical-align:middle;"><input type="text" value="${p.name}" onchange="updT(${i},'name',this.value)"></td>
            ${codeHtml}
            <td style="vertical-align:middle;"><select onchange="updT(${i},'subject',this.value)">${DATA.subjects.map(s => `<option ${s === p.subject ? 'selected' : ''}>${s}</option>`).join('')}</select></td>
            <td style="vertical-align:middle;">
                <select onchange="updT(${i},'status',this.value)">
                    <option>Certifi√©</option>
                    <option ${p.status == 'Agr√©g√©' ? 'selected' : ''}>Agr√©g√©</option>
                    <option ${p.status == 'BMP/CSR' ? 'selected' : ''}>BMP/CSR</option>
                    <option ${p.status == 'Contractuel' ? 'selected' : ''}>Contractuel</option>
                </select>
            </td>
            
            <td style="vertical-align:middle;">
                <div style="display:flex; flex-direction:column; align-items:center;">
                    <input type="number" value="${p.ors}" step="0.5" style="width:60px; text-align:center;" onchange="updT(${i},'ors',this.value)">
                    ${infoDisplay}
                </div>
            </td>
            
            <td style="vertical-align:middle;"><input type="number" value="${p.hsa}" step="0.5" style="width:60px" onchange="updT(${i},'hsa',this.value)"></td>
            
            <td style="font-weight:bold; color:#7f8c8d; vertical-align:middle;">${(p.ors + p.hsa).toFixed(1)}</td>
            
            <td style="vertical-align:middle; width:220px;">
                <div style="display:flex; justify-content:center; align-items:center; gap:4px; flex-wrap:wrap;">
                    ${splitBtn} ${bmpBtn} ${dechBtn} ${csdBtn}
                    <button class="btn btn-danger btn-sm" style="${btnStyle}" onclick="delT(${i})">X</button>
                </div>
            </td>
        </tr>`; 
    }); 
    
    if (document.getElementById('pilotage').classList.contains('active')) renderRHDisc(); 
}

function setCSD(idx) {
    const teacher = DATA.teachers[idx];
    const current = teacher.csd || 0;
    
    const val = prompt(`G√©rer le CSD (Compl√©ment de Service Donn√©) pour ${teacher.name}.\n\nCe professeur fera une partie de son service ailleurs.\nCombien d'heures fait-il √Ä L'EXT√âRIEUR ?`, current);
    
    if (val !== null) {
        const hours = parseFloat(val);
        if (isNaN(hours) || hours < 0) return alert("Valeur invalide");
        if (hours >= teacher.ors) return alert("Le CSD ne peut pas √™tre sup√©rieur ou √©gal √† l'ORS total !");
        
        teacher.csd = hours;
        saveData();
        renderRH();
        // On rafra√Æchit les tableaux de bord car l'apport change
        if (document.getElementById('rh-view-disc').style.display !== 'none') renderRHDisc();
        calculateRecap();
    }
}

function setDecharge(idx) {
    const teacher = DATA.teachers[idx];
    const current = teacher.decharge || 0;
    
    const val = prompt(`G√©rer les D√©charges / Heures de Labo pour ${teacher.name}.\n\nCes heures sont PAY√âES mais ne sont PAS des heures de cours (face √©l√®ves).\nEx: Heure de Vaisselle, Cabinet, Syndical...\n\nVolume √† d√©duire du temps de cours :`, current);
    
    if (val !== null) {
        const hours = parseFloat(val);
        if (isNaN(hours) || hours < 0) return alert("Valeur invalide");
        if (hours >= teacher.ors) return alert("La d√©charge ne peut pas d√©passer l'ORS !");
        
        teacher.decharge = hours;
        saveData();
        renderRH();
        if (document.getElementById('rh-view-disc').style.display !== 'none') renderRHDisc();
        calculateRecap();
    }
}

// ------------------------------------------------------------------------------------------------
// VENTILATION VISUELLE (V2.5) - Pop-up avec cases multiples
// ------------------------------------------------------------------------------------------------

let currentSplitIdx = -1; // Pour m√©moriser quel prof on modifie

function splitTeacher(idx) {
    const teacher = DATA.teachers[idx];
    
    // 1. Trouver les sous-mati√®res
    const children = DATA.subjects.filter(s => DATA.subjectMeta[s].parent === teacher.subject);
    
    if (children.length === 0) return alert("‚ö†Ô∏è Cette mati√®re n'a aucune sous-mati√®re rattach√©e (ex: UNSS, Section...) dans l'onglet 'Mati√®res'.");

    currentSplitIdx = idx;
    
    // 2. Remplir les infos du Pop-up
    document.getElementById('split-info').innerHTML = `
        Professeur : ${teacher.name}<br>
        Discipline : ${teacher.subject}<br>
        <span style="display:block; margin-top:5px; border-top:1px solid #a2d9ce; padding-top:5px;">
        Disponible sur cette ligne : <strong>${teacher.ors} h</strong>
        </span>
    `;

    const container = document.getElementById('split-container');
    container.innerHTML = '';

    // 3. G√©n√©rer une ligne pour chaque mati√®re fille
    children.forEach(child => {
        container.innerHTML += `
            <div class="split-row">
                <label>${child}</label>
                <input type="number" id="split-val-${child}" placeholder="0" min="0" max="${teacher.ors}" step="0.5">
            </div>
        `;
    });

    // 4. Afficher le Pop-up
    document.getElementById('split-overlay').style.display = 'flex';
    
    // Focus sur la premi√®re case
    setTimeout(() => {
        const firstInput = container.querySelector('input');
        if(firstInput) firstInput.focus();
    }, 100);
}

function confirmVentilation() {
    if (currentSplitIdx === -1) return;
    
    const teacher = DATA.teachers[currentSplitIdx];
    const children = DATA.subjects.filter(s => DATA.subjectMeta[s].parent === teacher.subject);
    let totalVentile = 0;
    let newLines = [];

    // 1. On r√©cup√®re les valeurs saisies
    for (let child of children) {
        const input = document.getElementById(`split-val-${child}`);
        const val = parseFloat(input.value);
        
        if (!isNaN(val) && val > 0) {
            totalVentile += val;
            newLines.push({ subject: child, hours: val });
        }
    }

    // 2. V√©rifications
    if (totalVentile === 0) {
        return closeSplitModal(); // Rien √† faire
    }
    if (totalVentile > teacher.ors) {
        alert(`‚õî Erreur : Vous essayez de ventiler ${totalVentile}h alors que le professeur n'a que ${teacher.ors}h sur cette ligne !`);
        return;
    }

    // 3. Application des changements
    // A. On r√©duit la ligne m√®re
    teacher.ors -= totalVentile;

    // B. On ins√®re les nouvelles lignes juste en dessous
    // On inverse la boucle pour les ins√©rer dans le bon ordre visuel
    for (let i = newLines.length - 1; i >= 0; i--) {
        const line = newLines[i];
        DATA.teachers.splice(currentSplitIdx + 1, 0, {
            name: teacher.name,
            subject: line.subject,
            status: teacher.status,
            ors: line.hours,
            hsa: 0 // Pas d'HSA sur les ventilations
        });
    }

    // 4. Sauvegarde et Fermeture
    saveData();
    renderRH();
    closeSplitModal();
    
    // Petit feedback sympa
    // alert(`‚úÖ Ventilation effectu√©e avec succ√®s !`); 
}

function closeSplitModal() {
    document.getElementById('split-overlay').style.display = 'none';
    currentSplitIdx = -1;
}

function updT(i,f,v){ 
    DATA.teachers[i][f]=(f=='ors'||f=='hsa')?parseFloat(v)||0:v; 
    saveData(); 
    
    // CORRECTION : Si on est sur l'onglet Pilotage, on rafra√Æchit le tableau de pilotage
    if(document.getElementById('pilotage').classList.contains('active')) {
        renderRHDisc(); 
    } else {
        renderRH(); // Sinon on rafra√Æchit la liste
    }
}
function addTeacherToSubject(s) { 
    DATA.teachers.push({name:"Nouveau", subject:s, status:"Certifi√©", ors:18, hsa:0, csd:0, decharge:0}); 
    renderRH(); 
    saveData(); 
    // CORRECTION : Si on est d√©j√† sur le pilotage (ce qui est le cas quand on clique sur le +), on recharge le pilotage
    if(document.getElementById('pilotage').classList.contains('active')) renderRHDisc(); 
}
function delT(i){ DATA.teachers.splice(i,1); renderRH(); saveData(); }
function clearTeachers(){ if(confirm("Vider ?")) { DATA.teachers=[]; renderRH(); saveData(); } }
function promptAddTeacher() { 
    let s = prompt("Discipline ?"); 
    if(!s) return; 

    if(!DATA.subjects.includes(s)) { 
        if(confirm("La mati√®re '" + s + "' n'existe pas. Voulez-vous la cr√©er ?")) { 
            // 1. On ajoute le nom
            DATA.subjects.push(s); 
            
            // 2. CORRECTION : On initialise imm√©diatement les param√®tres de la mati√®re
            // (C'est cette partie qui manquait et faisait planter l'affichage)
            DATA.subjectMeta[s] = { 
                mode: 'div', 
                levels: getDefaultActiveLevels(s), 
                etab: 0, 
                volLevel: {}, 
                parent: "", 
                code: ""
            }; 

            // 3. On initialise les heures √† 0 pour tous les niveaux
            DATA.structure.forEach(l => {
                if(!DATA.levelConfig[l.level]) DATA.levelConfig[l.level] = {};
                DATA.levelConfig[l.level][s] = {base:0, marge:0, coef:1.0};
            });

            saveData(); 
        } else {
            return; // Si on annule la cr√©ation, on s'arr√™te l√†
        }
    } 
    
    // Si la mati√®re existe (ou vient d'√™tre cr√©√©e proprement), on ajoute le prof
    addTeacherToSubject(s); 
}

function importRH(input) {
    const f = input.files[0];
    if (!f) return;
    const r = new FileReader();
    r.onload = e => {
        try {
            const wb = XLSX.read(new Uint8Array(e.target.result), { type: 'array', codepage: 1252 });
            const rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
            let cnt = 0;
            rows.forEach(r => {
                const get = k => r[Object.keys(r).find(x => x.trim().toLowerCase() === k.toLowerCase())];
                const n = get('Nom') || get('NOM');
                const d = get('Discipline') || get('DISCIPLINE');
                if (n && d) {
                    let codeRaw = "";
                    let codeMatch = d.match(/^([A-Z0-9]+)\s+/);
                    if (codeMatch) codeRaw = codeMatch[1];
                    let cl = d.replace(/^([A-Z0-9]+)\s+/, '').replace(/^[L]\d+\s+/, '').trim().toUpperCase();
                    let fin = cl;
                    
                    // Votre logique de mapping originale (V2.old) qui fonctionne bien pour vous
                    for (const [k, v] of Object.entries(SUBJECT_MAPPING))
                        if (cl.includes(k)) { fin = v; break; }

                    if (!DATA.subjects.includes(fin)) {
                        DATA.subjects.push(fin);
                        DATA.subjectMeta[fin] = { mode: 'div', levels: getDefaultActiveLevels(fin), etab: 0, volLevel: {}, parent: "", code: codeRaw };
                        DATA.structure.forEach(l => DATA.levelConfig[l.level][fin] = { base: 0, marge: 0, coef: 1.0 });
                    }

                    // --- MODIFICATION ICI ---
                    // On ajoute csd:0 et decharge:0 pour la compatibilit√© V2
                    DATA.teachers.push({ 
                        name: `${n} ${get('Pr√©nom') || ''}`.trim(), 
                        subject: fin, 
                        status: "Certifi√©", 
                        ors: 18, 
                        hsa: 0,
                        csd: 0,       // Ajout√©
                        decharge: 0   // Ajout√©
                    });
                    cnt++;
                }
            });
            alert(`${cnt} import√©s`); renderRH(); saveData();
        } catch (err) {
            console.error(err); // J'ai ajout√© ceci pour voir l'erreur pr√©cise dans la console (F12) au cas o√π
            alert("Erreur lors de l'import");
        }
        input.value = '';
    };
    r.readAsArrayBuffer(f);
}


function calculateRecap() { 
    // S√©curit√© : On v√©rifie que les besoins sont calcul√©s
    const needs = (typeof calculateNeeds === 'function') ? calculateNeeds() : {};
    const t = document.getElementById('recap-body'); 
    if (!t) return; 
    t.innerHTML = ''; 
    
    // --- 1. CALCUL PASSERELLE EDS (Volume Dynamique) ---
    let totalHeuresEDS = 0;
    if (DATA.type !== 'college' && DATA.eds) {
        ['premiere', 'terminale'].forEach(lvl => {
            if (DATA.eds[lvl]) {
                DATA.eds[lvl].forEach(e => {
                    // Utilise le volume saisi par ligne ou le d√©faut officiel (4h/6h)
                    const vol = parseFloat(e.hPerGroup) || (lvl === 'premiere' ? 4 : 6);
                    totalHeuresEDS += (parseFloat(e.groups) || 0) * vol;
                });
            }
        });
    }

    // 2. Initialisation des compteurs et commentaires
    let res = {}; 
    let autoComments = {}; 

    DATA.subjects.forEach(s => {
        res[s] = { teaching:0, cost:0, hsa:0, dechInt:0 };
        autoComments[s] = []; 
    }); 
    
    // 3. Calculs issus des professeurs (Apports)
    DATA.teachers.forEach(p => {
        if (!p.subject) return;
        if (!res[p.subject]) res[p.subject] = { teaching:0, cost:0, hsa:0, dechInt:0 };
        if (!autoComments[p.subject]) autoComments[p.subject] = [];

        const csd = parseFloat(p.csd || 0);
        const dechInt = parseFloat(p.decharge || 0);
        const dechExt = parseFloat(p.dech_ext || 0);
        const ors = parseFloat(p.ors || 0);
        const hsa = parseFloat(p.hsa || 0);
        const bmp = parseFloat(p.bmp || 0);

        // Co√ªt financier r√©el : (ORS - CSD - DechExterne) + HSA
        const financialCost = (ors - csd - dechExt) + hsa;
        
        res[p.subject].cost += financialCost;
        res[p.subject].hsa += hsa;
        res[p.subject].dechInt += dechInt;

        // G√©n√©ration des tags automatiques (BMP, CSD)
        if (bmp > 0) autoComments[p.subject].push(`BMP ${bmp}h`);
        if (csd > 0) autoComments[p.subject].push(`CSD ${p.name} ${csd}h`);
    }); 
    
    // --- CORRECTIF ICI ---
    // On initialise l'apport √† 0 (ce sont les profs qui vont le remplir plus bas)
    let globalNeed = totalHeuresEDS, totalApport = 0, totalHSA = 0;
    // ---------------------

    // 4. Fonction de rendu des lignes (Restauration de votre logique visuelle)
    const renderRow = (s, label, isPole, isChild) => {
        const stats = res[s] || { cost:0, hsa:0, dechInt:0 };
        const structNeed = needs[s] || 0;
        const totalNeed = structNeed + stats.dechInt; 
        const apport = stats.cost;
        const ecart = apport - totalNeed;
        const hpOnly = apport - stats.hsa;

        if (!isPole && totalNeed === 0 && apport === 0) return null;

        const meta = DATA.subjectMeta[s];
        const isCounted = (meta && meta.isCounted !== false);
        const safeS = s.replace(/'/g, "\\'");
        
        if (!DATA.recapComments) DATA.recapComments = {};
        const comm = DATA.recapComments[s] || ""; 
        
        let rowClass = "";
        let bgStyle = "";
        let nameStyle = "text-align:left; font-weight:bold;";
        
        if (isPole) rowClass = "row-header"; 
        else if (!isChild && !isPole) rowClass = "row-header"; 
        else if (isChild) { bgStyle = "background:#f9f9f9;"; nameStyle += " padding-left:20px;"; }
        else if (!isCounted) bgStyle = "background:#f4f6f6; color:#95a5a6; font-style:italic;";

        const badge = (!isPole && !isCounted && rowClass !== "row-header") ? '<span style="font-size:0.7rem; background:#95a5a6; color:white; padding:1px 4px; border-radius:3px; margin-left:5px;">HORS DHG</span>' : '';
        const isHeader = (rowClass === "row-header");

        const autoTags = autoComments[s] || [];
        let autoHTML = "";
        const alertColor = isHeader ? '#ffca28' : '#d35400'; 

        if (autoTags.length > 0 && !isPole) {
            autoHTML = `<div style="margin-bottom:4px; font-size:0.75rem; color:${alertColor}; font-weight:bold;">${autoTags.join(' / ')}</div>`;
        }

        return {
            html: `<tr class="${rowClass}" style="${bgStyle}">
                <td style="${nameStyle}; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${label} ${badge}</td>
                <td style="font-weight:bold; ${isHeader?'color:#f1c40f;':'color:#c0392b;'}">${totalNeed.toFixed(1)}</td>
                <td style="font-weight:bold; ${isHeader?'color:#81d4fa;':'color:#16a085;'}">${apport.toFixed(1)}</td>
                <td>${hpOnly.toFixed(1)}</td> 
                <td>${stats.hsa.toFixed(1)}</td>
                <td style="font-weight:bold; color:${ecart>=0?(isHeader?'#2ecc71':'green'):(isHeader?'#e74c3c':'red')};">${ecart.toFixed(1)}</td>
                <td style="padding:4px; vertical-align:middle;">
                    ${!isPole ? `${autoHTML}<input class="input-comment" value="${comm}" onchange="updComment('${safeS}',this.value)" style="width:100%; box-sizing:border-box; border:1px solid ${isHeader?'#78909c':'#ccc'}; padding:4px; color:black;" placeholder="Autre commentaire...">` : ''}
                </td>
            </tr>`,
            data: { need: totalNeed, apport: apport, hsa: stats.hsa, counted: isCounted }
        };
    };

    // --- 5. INSERTION DE LA LIGNE EDS (Gris Anthracite) ---
    if (totalHeuresEDS > 0) {
        t.innerHTML += `<tr class="row-header" style="background:#2c3e50; color:white;">
            <td style="text-align:left; font-weight:bold;">üéì ENVELOPPE SP√âCIALIT√âS (EDS)</td>
            <td style="color:#f1c40f;">${totalHeuresEDS.toFixed(1)}</td>
            <td style="color:#81d4fa;">-</td>
            <td>-</td>
            <td>-</td>
            <td style="color:#e74c3c;">-${totalHeuresEDS.toFixed(1)}</td>
            <td style="font-size:0.8rem; font-style:italic;">Besoin global √† couvrir par les mati√®res ci-dessous</td>
        </tr>`;
    }

    // 6. Boucle d'affichage des p√¥les et mati√®res
    const roots = DATA.subjects.filter(s => DATA.subjectMeta[s] && !DATA.subjectMeta[s].parent).sort();

    roots.forEach(r => {
        const kids = DATA.subjects.filter(s => DATA.subjectMeta[s] && DATA.subjectMeta[s].parent === r);
        if (kids.length > 0) {
            let poleNeed = 0, poleApport = 0, poleHSA = 0;
            let rowsToRender = [];
            const rRow = renderRow(r, `‚Ü≥ ${r}`, false, true);
            if (rRow) {
                if(rRow.data.counted) { poleNeed += rRow.data.need; poleApport += rRow.data.apport; poleHSA += rRow.data.hsa; }
                rowsToRender.push(rRow.html);
            }
            kids.forEach(k => {
                const kRow = renderRow(k, `‚Ü≥ ${k}`, false, true);
                if (kRow) {
                    if(kRow.data.counted) { poleNeed += kRow.data.need; poleApport += kRow.data.apport; poleHSA += kRow.data.hsa; }
                    rowsToRender.push(kRow.html);
                }
            });
            const poleEcart = poleApport - poleNeed;
            const poleHPOnly = poleApport - poleHSA;
            if (rowsToRender.length > 0) {
                t.innerHTML += `<tr class="row-header">
                    <td style="text-align:left; font-weight:bold;">üì¶ P√îLE ${r.toUpperCase()}</td>
                    <td style="font-weight:bold; color:#f1c40f;">${poleNeed.toFixed(1)}</td>
                    <td style="font-weight:bold; color:#81d4fa;">${poleApport.toFixed(1)}</td>
                    <td>${poleHPOnly.toFixed(1)}</td>
                    <td>${poleHSA.toFixed(1)}</td>
                    <td style="font-weight:bold; background:${poleEcart>=0?'#27ae60':'#c0392b'}; color:white;">${poleEcart.toFixed(1)}</td>
                    <td></td>
                </tr>`;
                rowsToRender.forEach(html => t.innerHTML += html);
            }
            globalNeed += poleNeed; totalApport += poleApport; totalHSA += poleHSA;
        } else {
            const row = renderRow(r, r, false, false);
            if (row) {
                t.innerHTML += row.html;
                if(row.data.counted) { globalNeed += row.data.need; totalApport += row.data.apport; totalHSA += row.data.hsa; }
            }
        }
    });
    
    // 7. Mise √† jour des Totaux (Pied de tableau)
    const totalEl = document.getElementById('recap-total');
    if(totalEl) {
        totalEl.innerHTML = `
            <td style="text-align:right;">TOTAL G√âN√âRAL</td>
            <td style="color:#c0392b; font-size:1.1rem;">${globalNeed.toFixed(1)}</td>
            <td style="color:#16a085; font-size:1.1rem;">${totalApport.toFixed(1)}</td>
            <td>${(totalApport - totalHSA).toFixed(1)}</td>
            <td>${totalHSA.toFixed(1)}</td>
            <td style="color:${(totalApport - globalNeed)>=0?'green':'red'}; font-size:1.1rem;">${(totalApport - globalNeed).toFixed(1)}</td>
            <td></td>`; 
    }
    
    // 8. Mise √† jour des KPI du Dashboard d'accueil
    if(DATA.config && document.getElementById('dash-total-dhg')) {
        const g = DATA.config.total || 0; 
        document.getElementById('dash-total-dhg').innerText = g; 
        document.getElementById('dash-conso').innerText = totalApport.toFixed(1); 
        document.getElementById('dash-hsa').innerText = totalHSA.toFixed(1); 
        document.getElementById('dash-solde').innerText = (g - totalApport).toFixed(1);
        
        const hpUsed = Math.max(0, totalApport - totalHSA);
        document.getElementById('dash-hp-used').innerText = hpUsed.toFixed(1);

        const hsaInput = document.getElementById('global-hsa');
        const globalHsaInput = hsaInput ? (parseFloat(hsaInput.value) || 0) : 0;
        const globalDotation = parseFloat(document.getElementById('dash-total-dhg').innerText) || 0;
        let ratio = 0; if(globalDotation > 0) { ratio = (globalHsaInput / globalDotation) * 100; }
        document.getElementById('global-hsa-percent-display').innerText = ratio.toFixed(1) + "%";
    }
}
function renderFinalKPIs(need, apport, hsa) {
    const totalEl = document.getElementById('recap-total');
    if(totalEl) {
        totalEl.innerHTML = `
            <td style="text-align:right;">TOTAL G√âN√âRAL</td>
            <td style="color:#c0392b;">${need.toFixed(1)}</td>
            <td style="color:#16a085;">${apport.toFixed(1)}</td>
            <td>${(apport - hsa).toFixed(1)}</td><td>${hsa.toFixed(1)}</td>
            <td style="color:${(apport - need)>=0?'green':'red'};">${(apport - need).toFixed(1)}</td><td></td>`; 
    }
    // Mise √† jour Dashboard
    document.getElementById('dash-conso').innerText = apport.toFixed(1);
    document.getElementById('dash-solde').innerText = (DATA.config.total - apport).toFixed(1);
}

function updComment(s,v){ if(!DATA.recapComments)DATA.recapComments={}; DATA.recapComments[s]=v; saveData(); }

// Variable globale pour savoir quelle page on est en train d'exporter
let pendingExportSection = "";
let pendingExportTitle = "";
function exportCurrentPage(type) {
    // 1. Identification de la section active
    const activeSection = document.querySelector('.section.active').id;
    
    // ========================================================================
    // CAS SP√âCIFIQUE : ONGLET R√âPARTITION
    // ========================================================================
    if (activeSection === 'repartition') {
        
        // A. Sous-vue "Par Enseignant" (Cartes visuelles)
        if (typeof currentRepartitionView !== 'undefined' && currentRepartitionView === 'profs') {
            if (type === 'excel') {
                alert("‚õî Export Excel impossible sur la vue 'Cartes Enseignants'.\n\nCette vue est graphique. Utilisez l'export PDF pour imprimer les fiches, ou passez en vue 'Par Mati√®re' pour un export Excel.");
                return;
            }
            if (type === 'pdf') {
                // Lance la fonction PDF sp√©cifique "Cartes"
                generateRepartitionProfsPDF(); 
                return;
            }
        } 
        
        // B. Sous-vue "Par Mati√®re" (Tableaux)
        else {
            if (type === 'excel') {
                // Lance la fonction Excel sp√©cifique (Multi-onglets par P√¥le)
                exportRepartitionMatiereExcel(); 
                return;
            }
            if (type === 'pdf') {
                // Lance la fonction PDF sp√©cifique (Sauts de page par P√¥le)
                exportRepartitionMatierePDF(); 
                return;
            }
        }
    }

    // ========================================================================
    // CAS STANDARD : AUTRES ONGLETS
    // ========================================================================
    
    const dateStr = new Date().toLocaleDateString('fr-FR');
    let title = 'Export';
    let tableId = null;

    // Configuration des IDs de tableaux selon la page
    if (activeSection === 'dashboard') title = 'Tableau de Bord';
    else if (activeSection === 'structure') { title = 'Structure'; tableId = 'structure-table'; }
    else if (activeSection === 'ventilation') title = 'Grille Horaire'; 
    else if (activeSection === 'professeurs') { title = 'Liste des Enseignants'; tableId = 'rh-table-list'; }
    else if (activeSection === 'pilotage') { title = 'Ventilation par Mati√®re'; tableId = 'rh-table-disc'; }
    else if (activeSection === 'recap') { title = 'Bilan'; tableId = 'recap-table'; }
    else if (activeSection === 'equipes') title = 'Equipes P√©dagogiques';
    else if (activeSection === 'matieres') { title = 'Mati√®res'; tableId = 'subjects-table'; }

    const filename = `DHG - ${title} - ${dateStr}`;

    // --- Export EXCEL Standard ---
    if (type === 'excel') {
        const wb = XLSX.utils.book_new();
        
        // Cas 1 : Tableaux complexes n√©cessitant un nettoyage (Inputs -> Texte)
        if (activeSection === 'ventilation' || activeSection === 'matieres' || activeSection === 'structure') {
            let grid = null;
            if (activeSection === 'ventilation') grid = document.querySelector('.grid-table');
            else if (activeSection === 'matieres') grid = document.getElementById('subjects-table');
            else if (activeSection === 'structure') grid = document.getElementById('structure-table');
            
            if(grid) {
                const cleanT = cleanTableForExport(grid);
                XLSX.utils.book_append_sheet(wb, XLSX.utils.table_to_sheet(cleanT), "Donn√©es");
            }
        }
        // Cas 2 : Tableaux simples via ID
        else if (tableId) {
            const el = document.getElementById(tableId);
            if(el) {
                const cleanT = cleanTableForExport(el);
                XLSX.utils.book_append_sheet(wb, XLSX.utils.table_to_sheet(cleanT), "Donn√©es");
            }
        }
        // Cas 3 : Pilotage (Tableau sp√©cifique)
        else if (activeSection === 'pilotage') {
             const el = document.getElementById('rh-table-disc');
             if(el) XLSX.utils.book_append_sheet(wb, XLSX.utils.table_to_sheet(el), "Donn√©es");
        }
        // Cas 4 : Rien √† exporter
        else {
            alert("Rien √† exporter sur cette vue.");
            return;
        }
        
        XLSX.writeFile(wb, `${filename}.xlsx`);
    } 
    
    // --- Export PDF Standard (Via Modale) ---
    else if (type === 'pdf') {
        // On stocke le contexte et on ouvre la modale de choix (A4/A3, Portrait/Paysage)
        pendingExportSection = activeSection;
        pendingExportTitle = title;
        openExportModal();
    }
}

// --- UTILITAIRE : Convertit un index (0, 1, 2) en lettre Excel (A, B, C... AA, AB) ---
function getExcelAlpha(colIndex) {
    let temp, letter = '';
    while (colIndex >= 0) {
        temp = (colIndex) % 26;
        letter = String.fromCharCode(temp + 65) + letter;
        colIndex = (colIndex - temp - 1) / 26;
    }
    return letter;
}

function exportRepartitionMatiereExcel() {
    const wb = XLSX.utils.book_new();
    const roots = DATA.subjects.filter(s => !DATA.subjectMeta[s]?.parent).sort();

    // --- STYLES ---
    const baseStyle = {
        border: {
            top: { style: "thin", color: { auto: 1 } },
            bottom: { style: "thin", color: { auto: 1 } },
            left: { style: "thin", color: { auto: 1 } },
            right: { style: "thin", color: { auto: 1 } }
        },
        font: { name: "Calibri", sz: 11 }
    };

    const headerStyle = {
        ...baseStyle,
        fill: { fgColor: { rgb: "E7E6E6" } }, // Gris clair
        font: { name: "Calibri", sz: 11, bold: true },
        alignment: { horizontal: "center", vertical: "center" }
    };

    const needStyle = {
        ...baseStyle,
        fill: { fgColor: { rgb: "FFF2CC" } }, // Jaune clair
        font: { name: "Calibri", sz: 11, italic: true }
    };
    
    // Fonction nettoyage nom onglet
    const cleanSheetName = (name) => name.replace(/[\\/?*[\]]/g, ' ').substring(0, 31);

    roots.forEach(root => {
        const subjectsInPole = [root, ...DATA.subjects.filter(s => DATA.subjectMeta[s]?.parent === root)];
        let wsData = [];
        
        // Titre du P√¥le (Ligne 1)
        wsData.push([{ v: `P√îLE : ${root.toUpperCase()}`, s: { font: { bold: true, sz: 14 } } }]);
        wsData.push([]); 

        subjectsInPole.forEach(sub => {
            const meta = DATA.subjectMeta[sub];
            if (!meta) return;
            const isLabo = (meta.code === 'LAB' && meta.parent);
            
            let profs = [];
            if (isLabo) profs = DATA.teachers.map((t, i) => ({...t, idx: i})).filter(t => t.subject === meta.parent);
            else profs = DATA.teachers.map((t, i) => ({...t, idx: i})).filter(t => t.subject === sub);
            if (profs.length === 0 && isLabo) return;

            // --- 1. PR√âPARATION DES COLONNES ---
            let colKeys = []; 
            let headerRow = [{ v: "Enseignant", s: headerStyle }];

            if (meta.mode === 'div') {
                DATA.structure.forEach(lvl => {
                    const prefix = getLevelPrefix(lvl.level);
                    for (let i = 0; i < lvl.div; i++) {
                        const cId = `${prefix}${String.fromCharCode(65 + i)}`;
                        const isActive = (meta.levels && meta.levels.includes(lvl.level));
                        const hasHours = getHoursForClassSubject(cId, lvl.level, sub) > 0;
                        
                        if (hasHours || isActive) {
                            headerRow.push({ v: DATA.classNames[cId] || cId, s: headerStyle });
                            
                            // ‚¨áÔ∏è C'EST ICI QUE C'√âTAIT CORRIG√â : Ajout de 'lvl: lvl.level'
                            colKeys.push({id: cId, type: 'class', lvl: lvl.level}); 
                        }
                    }
                });
            } else if (meta.mode === 'level') {
                DATA.structure.forEach(lvl => {
                    headerRow.push({ v: lvl.level, s: headerStyle });
                    colKeys.push({id: lvl.level, type: 'level'}); // Ici le niveau est l'ID
                });
            } else if (meta.mode === 'etab') {
                headerRow.push({ v: "Global", s: headerStyle });
                colKeys.push({id: 'ETAB', type: 'etab'});
            }

            if (colKeys.length === 0) return;

            // Colonnes Totaux
            headerRow.push(
                { v: "Total Mati√®re", s: headerStyle },
                { v: "Service Global", s: headerStyle },
                { v: "Service D√ª", s: headerStyle },
                { v: "Solde", s: headerStyle }
            );

            // Titre Mati√®re
            wsData.push([{ v: `Mati√®re : ${sub}`, s: { font: { bold: true, color: { rgb: "2F75B5" } } } }]);
            wsData.push(headerRow);
            
            // --- 2. LIGNE BESOIN (Cible) ---
            if (!isLabo) {
                let needRow = [{ v: "BESOIN (Cible)", s: needStyle }];
                
                colKeys.forEach(col => {
                    let besoin = 0;
                    // Maintenant 'col.lvl' existe bien, donc le calcul fonctionne !
                    if(col.type === 'class') besoin = getHoursForClassSubject(col.id, col.lvl, sub);
                    else if(col.type === 'level') besoin = (meta.volLevel && meta.volLevel[col.id]) || 0;
                    else if(col.type === 'etab') besoin = meta.etab || 0;
                    
                    // On force un Nombre (t:'n') pour que les formules Excel marchent
                    needRow.push({ v: besoin > 0 ? besoin : "", t: 'n', s: needStyle });
                });
                
                // Cellules vides de fin de ligne (pour le style)
                needRow.push({v:"", s:needStyle}, {v:"", s:needStyle}, {v:"", s:needStyle}, {v:"", s:needStyle});
                wsData.push(needRow);
            }

            // --- 3. LIGNES PROFS ---
            profs.forEach(p => {
                const currentRowNum = wsData.length + 1; // Index Excel (1-based)
                
                let row = [{ v: p.name, s: baseStyle }];

                colKeys.forEach(col => {
                    let val = 0;
                    if (isLabo) val = p.decharge || 0; 
                    else {
                        const key = `${col.id}_${p.idx}`;
                        const assign = DATA.assignments[key];
                        val = (assign && assign.quota !== undefined) ? assign.quota : 0;
                    }
                    row.push({ v: val > 0 ? val : "", t: 'n', s: baseStyle });
                });

                // FORMULE SOMME
                const startChar = getExcelAlpha(1); // "B"
                const endChar = getExcelAlpha(colKeys.length); 
                const formulaTotal = `SUM(${startChar}${currentRowNum}:${endChar}${currentRowNum})`;
                
                row.push({ t: 'n', f: formulaTotal, s: { ...baseStyle, font: { bold: true } } });

                // Services & Solde
                const serviceGlobal = getGlobalTeacherService(p.idx);
                const serviceDu = p.ors - (p.csd || 0);
                
                row.push({ v: serviceGlobal, t: 'n', s: baseStyle });
                row.push({ v: serviceDu, t: 'n', s: baseStyle });
                
                // Formule Solde
                const colGlobalChar = getExcelAlpha(colKeys.length + 2);
                const colDuChar = getExcelAlpha(colKeys.length + 3);
                const formulaSolde = `${colGlobalChar}${currentRowNum}-${colDuChar}${currentRowNum}`;
                
                row.push({ t: 'n', f: formulaSolde, s: { ...baseStyle, font: { bold: true } } });

                wsData.push(row);
            });

            // --- 4. LIGNE RELIQUAT ---
            if (!isLabo) {
                const currentRowNum = wsData.length + 1;
                const needRowNum = currentRowNum - profs.length - 1; // On remonte chercher la ligne Besoin

                let relRow = [{ v: "RELIQUAT", s: { ...baseStyle, font: { italic: true, color: { rgb: "C00000" } } } }];
                
                colKeys.forEach((col, idx) => {
                    const colChar = getExcelAlpha(idx + 1);
                    const profStartRow = needRowNum + 1;
                    const profEndRow = currentRowNum - 1;
                    
                    // Formule : = Besoin - SOMME(Profs)
                    let formulaRel = "";
                    if (profStartRow > profEndRow) {
                        // Cas sans profs : Reliquat = Besoin
                        formulaRel = `${colChar}${needRowNum}`;
                    } else {
                        formulaRel = `${colChar}${needRowNum}-SUM(${colChar}${profStartRow}:${colChar}${profEndRow})`;
                    }
                    
                    relRow.push({ t: 'n', f: formulaRel, s: baseStyle });
                });
                
                relRow.push({v:"", s:baseStyle}, {v:"", s:baseStyle}, {v:"", s:baseStyle}, {v:"", s:baseStyle});
                wsData.push(relRow);
            }

            wsData.push([]); 
            wsData.push([]); 
        });

        // Cr√©ation de la feuille
        if (wsData.length > 2) {
            const ws = XLSX.utils.aoa_to_sheet([]);
            XLSX.utils.sheet_add_aoa(ws, wsData, { origin: "A1" });

            // Largeurs colonnes
            let maxColCount = 0;
            wsData.forEach(r => { if(r.length > maxColCount) maxColCount = r.length; });
            let wscols = [];
            for(let i=0; i<maxColCount; i++) wscols.push({wch: 12});
            wscols[0] = {wch: 25};
            ws['!cols'] = wscols;

            XLSX.utils.book_append_sheet(wb, ws, cleanSheetName(root));
        }
    });

    const dateStr = new Date().toLocaleDateString('fr-FR').replace(/\//g, '-');
    XLSX.writeFile(wb, `DHG_Repartition_Matieres_PRO_${dateStr}.xlsx`);
}

function exportRepartitionMatierePDF() {
    const { jsPDF } = window.jspdf;
    // Format Paysage obligatoire vu la largeur des tableaux
    const doc = new jsPDF({ orientation: 'landscape', format: 'a4' });
    
    const margin = 14;
    let cursorY = 20;
    const pageWidth = doc.internal.pageSize.width;

    // Fonction En-t√™te (r√©p√©t√©e sur chaque page si besoin)
    const printHeader = (title) => {
        doc.setFillColor(44, 62, 80);
        doc.rect(0, 0, pageWidth, 15, 'F');
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(10);
        doc.setFont("helvetica", "bold");
        doc.text(`DHG MANAGER - R√âPARTITION : ${title.toUpperCase()}`, margin, 10);
        doc.text(`Ann√©e ${DATA.config.year}`, pageWidth - margin, 10, { align: 'right' });
        cursorY = 25;
    };

    const roots = DATA.subjects.filter(s => !DATA.subjectMeta[s]?.parent).sort();
    let isFirstPage = true;

    roots.forEach(root => {
        const subjectsInPole = [root, ...DATA.subjects.filter(s => DATA.subjectMeta[s]?.parent === root)];
        
        // V√©rifier s'il y a du contenu √† afficher pour ce p√¥le
        // (Pour √©viter de cr√©er une page vide si le p√¥le est vide)
        let hasContent = subjectsInPole.some(sub => {
             const meta = DATA.subjectMeta[sub];
             // Logique simplifi√©e : si la mati√®re existe, on suppose qu'il faut l'afficher
             return !!meta; 
        });

        if (!hasContent) return;

        // GESTION DU SAUT DE PAGE ENTRE P√îLES
        if (!isFirstPage) {
            doc.addPage();
            cursorY = 20;
        }
        isFirstPage = false;

        // Impression du Titre du P√¥le (Haut de page)
        printHeader(root);

        // Boucle sur les mati√®res du p√¥le
        subjectsInPole.forEach(sub => {
            const meta = DATA.subjectMeta[sub];
            if (!meta) return;

            const isLabo = (meta.code === 'LAB' && meta.parent);
            let profs = [];
            if (isLabo) profs = DATA.teachers.map((t, i) => ({...t, idx: i})).filter(t => t.subject === meta.parent);
            else profs = DATA.teachers.map((t, i) => ({...t, idx: i})).filter(t => t.subject === sub);

            if (profs.length === 0 && isLabo) return;

            // --- Pr√©paration des colonnes pour le PDF ---
            let pdfColumns = [{ header: 'Enseignant', dataKey: 'name' }];
            let colKeys = [];

            if (meta.mode === 'div') {
                DATA.structure.forEach(lvl => {
                    const prefix = getLevelPrefix(lvl.level);
                    for (let i = 0; i < lvl.div; i++) {
                        const cId = `${prefix}${String.fromCharCode(65 + i)}`;
                        const isActive = (meta.levels && meta.levels.includes(lvl.level));
                        const hasHours = getHoursForClassSubject(cId, lvl.level, sub) > 0;
                        if (hasHours || isActive) {
                            pdfColumns.push({ header: DATA.classNames[cId] || cId, dataKey: cId });
                            colKeys.push({id: cId, lvl: lvl.level, type: 'class'});
                        }
                    }
                });
            } else if (meta.mode === 'level') {
                DATA.structure.forEach(lvl => {
                    pdfColumns.push({ header: lvl.level, dataKey: lvl.level });
                    colKeys.push({id: lvl.level, lvl: lvl.level, type: 'level'});
                });
            } else if (meta.mode === 'etab') {
                pdfColumns.push({ header: 'Global', dataKey: 'ETAB' });
                colKeys.push({id: 'ETAB', type: 'etab'});
            }

            if (colKeys.length === 0) return;

            // Colonnes de totaux
            pdfColumns.push(
                { header: 'Tot.', dataKey: 'total' },
                { header: 'Svc.', dataKey: 'global' },
                { header: 'D√ª', dataKey: 'due' }
            );

            // --- Pr√©paration des donn√©es (Lignes) ---
            let pdfRows = [];
            profs.forEach(p => {
                let row = { name: p.name };
                let rowTotal = 0;

                colKeys.forEach(col => {
                    let val = 0;
                    if (isLabo) val = p.decharge || 0;
                    else {
                        const key = `${col.id}_${p.idx}`;
                        const assign = DATA.assignments[key];
                        val = (assign && assign.quota !== undefined) ? assign.quota : 0;
                    }
                    if (val > 0) rowTotal += parseFloat(val);
                    row[col.id] = val > 0 ? val : "";
                });

                const serviceGlobal = getGlobalTeacherService(p.idx);
                const serviceDu = p.ors - (p.csd || 0);

                row.total = rowTotal.toFixed(1);
                row.global = serviceGlobal.toFixed(1);
                row.due = serviceDu.toFixed(1);
                
                // Info de style pour la ligne
                row._style_global = { textColor: serviceGlobal >= serviceDu ? [39, 174, 96] : [192, 57, 43], fontStyle: 'bold' };
                row._style_due = { textColor: [142, 68, 173] }; // Violet pour le d√ª
                
                pdfRows.push(row);
            });

            // Ligne Reliquat
            if (!isLabo) {
                let relRow = { name: "RELIQUAT" };
                colKeys.forEach(col => {
                    let assignedInCol = 0;
                    profs.forEach(p => {
                         const q = DATA.assignments[`${col.id}_${p.idx}`]?.quota || 0;
                         assignedInCol += parseFloat(q);
                    });
                    
                    let besoin = 0;
                    if(col.type === 'class') besoin = getHoursForClassSubject(col.id, col.lvl, sub);
                    else if(col.type === 'level') besoin = (meta.volLevel && meta.volLevel[col.id]) || 0;
                    else if(col.type === 'etab') besoin = meta.etab || 0;

                    const diff = besoin - assignedInCol;
                    relRow[col.id] = Math.abs(diff) < 0.01 ? "OK" : diff.toFixed(1);
                    
                    // Style conditionnel cellule
                    relRow[`_style_${col.id}`] = { 
                        textColor: Math.abs(diff) < 0.01 ? [39, 174, 96] : (diff > 0 ? [192, 57, 43] : [230, 126, 34]),
                        fontStyle: 'bold'
                    };
                });
                // Styles vides pour les totaux sur la ligne reliquat
                relRow.total = ""; relRow.global = ""; relRow.due = "";
                pdfRows.push(relRow);
            }

            // --- G√©n√©ration du Tableau PDF ---
            
            // Titre de la mati√®re
            doc.setFontSize(11);
            doc.setTextColor(52, 152, 219);
            doc.text(`${sub} (${isLabo ? 'Labo' : meta.mode})`, margin, cursorY + 5);
            
            doc.autoTable({
                startY: cursorY + 7,
                columns: pdfColumns,
                body: pdfRows,
                theme: 'grid',
                styles: { fontSize: 8, cellPadding: 1, textColor: 50, halign: 'center' },
                headStyles: { fillColor: [52, 73, 94], textColor: 255, fontStyle: 'bold' },
                columnStyles: { name: { halign: 'left', fontStyle: 'bold', cellWidth: 35 } },
                
                // Application des styles conditionnels
                didParseCell: function(data) {
                    if (data.section === 'body') {
                        const rowRaw = data.row.raw;
                        
                        // Style Colonne Totale Global Prof
                        if (data.column.dataKey === 'global' && rowRaw._style_global) {
                            data.cell.styles.textColor = rowRaw._style_global.textColor;
                            data.cell.styles.fontStyle = rowRaw._style_global.fontStyle;
                        }
                        // Style Colonne D√ª
                        if (data.column.dataKey === 'due' && rowRaw._style_due) {
                            data.cell.styles.textColor = rowRaw._style_due.textColor;
                        }
                        // Style Cellules Reliquat
                        const styleMeta = rowRaw[`_style_${data.column.dataKey}`];
                        if (styleMeta) {
                            data.cell.styles.textColor = styleMeta.textColor;
                            data.cell.styles.fontStyle = styleMeta.fontStyle;
                        }
                        // Fond rouge pour la ligne Reliquat
                        if (rowRaw.name === "RELIQUAT" && data.column.dataKey === 'name') {
                             data.cell.styles.fontStyle = 'italic';
                             data.cell.styles.textColor = [192, 57, 43];
                        }
                    }
                },
                margin: { left: margin, right: margin }
            });

            cursorY = doc.lastAutoTable.finalY + 10;
            
            // Si on arrive en bas de page, on saute
            if (cursorY > doc.internal.pageSize.height - 20) {
                doc.addPage();
                cursorY = 20;
            }
        });
    });

    const dateStr = new Date().toLocaleDateString('fr-FR').replace(/\//g, '-');
    doc.save(`Repartition_Matiere_Par_Pole_${dateStr}.pdf`);
}

function generateRepartitionProfsPDF() {
    const { jsPDF } = window.jspdf;
    // Force paysage (Landscape) pour avoir de la place, format A4
    const doc = new jsPDF({ orientation: 'landscape', format: 'a4' });
    
    const pageWidth = doc.internal.pageSize.width;
    const pageHeight = doc.internal.pageSize.height;
    const margin = 14;
    let cursorY = 20;

    // --- EN-T√äTE DU DOCUMENT ---
    const addHeader = () => {
        doc.setFillColor(44, 62, 80); // Couleur Primary
        doc.rect(0, 0, pageWidth, 15, 'F');
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(10);
        doc.setFont("helvetica", "bold");
        doc.text(`DHG MANAGER - R√âPARTITION PAR ENSEIGNANT`, margin, 10);
        doc.text(`Ann√©e ${DATA.config.year}`, pageWidth - margin, 10, { align: 'right' });
        cursorY = 25;
    };
    addHeader();

    // 1. Regroupement des donn√©es (Idem que l'affichage √©cran)
    const consolidated = {};
    DATA.teachers.forEach((t, idx) => {
        const cleanName = t.name.trim();
        if(!consolidated[cleanName]) {
            consolidated[cleanName] = { name: cleanName, indices: [], data: [] };
        }
        consolidated[cleanName].indices.push(idx);
        consolidated[cleanName].data.push(t);
    });

    // Tri alphab√©tique
    const groups = Object.values(consolidated).sort((a, b) => a.name.localeCompare(b.name));

    // 2. Boucle sur chaque professeur
    groups.forEach(group => {
        // --- Calculs (Copie de la logique √©cran) ---
        let totalServiceFait = 0;
        let totalDu = 0;
        let rows = [];

        // Mati√®re principale
        let mainSub = group.data[0].subject;
        group.data.forEach(t => {
            const meta = DATA.subjectMeta[t.subject];
            const metaMain = DATA.subjectMeta[mainSub];
            if(DATA.subjects.some(s => DATA.subjectMeta[s]?.parent === t.subject)) mainSub = t.subject;
            if(metaMain?.parent === t.subject) mainSub = t.subject;
        });

        // Traitement des lignes
        group.data.forEach((t, i) => {
            const realIdx = group.indices[i];
            const csd = parseFloat(t.csd || 0);
            const dech = (parseFloat(t.decharge || 0) + parseFloat(t.dech_ext || 0));
            totalDu += (t.ors - csd);

            let levelsPaid = new Set();
            const relevantKeys = Object.keys(DATA.assignments).filter(k => parseInt(k.split('_')[1]) === realIdx);

            relevantKeys.forEach(key => {
                const parts = key.split('_');
                const assign = DATA.assignments[key];
                const entityId = parts.slice(0, parts.length - 1).join('_');
                const meta = DATA.subjectMeta[t.subject];
                
                let parentLevelName = null;
                const structLvlExact = DATA.structure.find(l => l.level === entityId);
                if (structLvlExact) parentLevelName = structLvlExact.level;
                else {
                    const structLvlPrefix = DATA.structure.find(l => entityId.startsWith(getLevelPrefix(l.level)));
                    if (structLvlPrefix) parentLevelName = structLvlPrefix.level;
                }

                let h = assign.quota !== undefined ? parseFloat(assign.quota) : 0;
                if(h === 0 && parentLevelName) h = getHoursForClassSubject(entityId, parentLevelName, t.subject);

                if(h > 0) {
                    let label = DATA.classNames[entityId] || entityId;
                    let typeBadge = "Cl.";
                    if (entityId === 'ETAB') { label = "Forfait Etab"; typeBadge = "Etab"; }
                    else if (structLvlExact) { typeBadge = "Niv"; }

                    let effectiveHours = h;
                    let isIncluded = false;

                    if (meta && meta.mode === 'level' && parentLevelName) {
                        if (levelsPaid.has(parentLevelName)) { effectiveHours = 0; isIncluded = true; }
                        else { levelsPaid.add(parentLevelName); effectiveHours = h; }
                    }

                    totalServiceFait += effectiveHours;
                    
                    let rowLabel = label;
                    if(t.subject !== mainSub) rowLabel += ` (${t.subject})`;

                    // Ajout au tableau PDF
                    rows.push({
                        col1: rowLabel,
                        col2: effectiveHours > 0 ? h.toFixed(1) : "(Incl.)",
                        col3: typeBadge,
                        isIncluded: isIncluded,
                        isDech: false
                    });
                }
            });

            if(dech > 0) {
                totalServiceFait += dech;
                rows.push({ col1: "D√©charges / Autres", col2: dech.toFixed(1), col3: "Div.", isDech: true });
            }
        });

        // Calcul du solde et couleur
        const solde = totalServiceFait - totalDu;
        const isOk = solde >= -0.1;
        const colorHex = isOk ? "#27ae60" : "#c0392b"; // Vert ou Rouge
        const colorRGB = isOk ? [39, 174, 96] : [192, 57, 43];

        // --- RENDU SUR LE PDF ---

        // 1. V√©rification de l'espace restant pour √©viter de couper une carte
        // Estimation hauteur : Header (10) + Table (approx 7 par ligne) + Padding
        const estimatedHeight = 15 + (rows.length * 7) + 10;
        
        if (cursorY + estimatedHeight > pageHeight - 10) {
            doc.addPage();
            addHeader(); // Remettre l'en-t√™te sur la nouvelle page
        }

        // 2. Dessin du cadre "Carte"
        const cardStartY = cursorY;
        
        // Barre de couleur √† gauche
        doc.setFillColor(colorRGB[0], colorRGB[1], colorRGB[2]);
        doc.rect(margin, cardStartY, 2, 8, 'F'); // Petite barre color√©e visuelle

        // Titre Professeur
        doc.setFontSize(11);
        doc.setFont("helvetica", "bold");
        doc.setTextColor(44, 62, 80);
        doc.text(`${group.name} - ${mainSub}`, margin + 4, cardStartY + 6);

        // Indicateur Solde (√† droite)
        doc.setFontSize(10);
        doc.text(`Fait: ${totalServiceFait.toFixed(2)}h / D√ª: ${totalDu.toFixed(1)}h`, pageWidth - margin - 30, cardStartY + 6, { align: 'right' });
        
        // Badge Solde
        doc.setFillColor(colorRGB[0], colorRGB[1], colorRGB[2]);
        doc.roundedRect(pageWidth - margin - 25, cardStartY + 1, 25, 7, 2, 2, 'F');
        doc.setTextColor(255, 255, 255);
        doc.setFont("helvetica", "bold");
        doc.text(`${solde > 0 ? '+' : ''}${solde.toFixed(2)}`, pageWidth - margin - 12.5, cardStartY + 5.5, { align: 'center' });

        cursorY += 10;

        // 3. Tableau des services (s'il y a des lignes)
        if (rows.length > 0) {
            doc.autoTable({
                startY: cursorY,
                head: [['Support / Classe', 'Heures', 'Type']],
                body: rows.map(r => [r.col1, r.col2, r.col3]),
                theme: 'grid',
                styles: { fontSize: 9, cellPadding: 1, textColor: 50 },
                headStyles: { fillColor: [236, 240, 241], textColor: 50, fontStyle: 'bold', lineWidth: 0.1, lineColor: 200 },
                columnStyles: {
                    0: { cellWidth: 'auto' },
                    1: { cellWidth: 20, halign: 'center', fontStyle: 'bold' },
                    2: { cellWidth: 15, halign: 'center', textColor: 100 }
                },
                didParseCell: function(data) {
                    // Style conditionnel (lignes gris√©es si incluses, etc.)
                    const rowRaw = rows[data.row.index];
                    if (data.section === 'body' && rowRaw) {
                        if (rowRaw.isIncluded) {
                            data.cell.styles.textColor = [150, 150, 150];
                            data.cell.styles.fillColor = [248, 249, 250];
                        }
                        if (rowRaw.isDech) {
                            data.cell.styles.textColor = [142, 68, 173]; // Violet pour d√©charges
                            data.cell.styles.fillColor = [244, 236, 247];
                        }
                    }
                },
                margin: { left: margin + 4, right: margin } // Indentation l√©g√®re sous le titre
            });

            cursorY = doc.lastAutoTable.finalY + 8; // Espace apr√®s le tableau
        } else {
            // Cas sans service
            doc.setFont("helvetica", "italic");
            doc.setFontSize(9);
            doc.setTextColor(150);
            doc.text("(Aucun service saisi)", margin + 4, cursorY + 5);
            cursorY += 15;
        }
        
        // Ligne de s√©paration l√©g√®re entre les profs (optionnel)
        doc.setDrawColor(230, 230, 230);
        doc.line(margin, cursorY - 4, pageWidth - margin, cursorY - 4);

    });

    // Finalisation
    const dateStr = new Date().toLocaleDateString('fr-FR').replace(/\//g, '-');
    doc.save(`Repartition_Service_Enseignants_${dateStr}.pdf`);
}

// Fonction appel√©e quand on clique sur "T√©l√©charger" dans le pop-up
function confirmGlobalExport() {
    // R√©cup√®re les choix du menu
    const orientation = expConfig.orientation; // 'portrait' ou 'landscape'
    const format = expConfig.format;           // 'a3' ou 'a4'
    const forceOnePage = document.getElementById('chk-force-one-page').checked;
    
    // Ferme le menu
    document.getElementById('export-overlay').style.display = 'none';

    // Lance le bon export selon la section
    if (pendingExportSection === 'equipes') {
        exportTeamsGridPDF(orientation, format, forceOnePage);
    } else {
        const dateStr = new Date().toLocaleDateString('fr-FR');
        const filename = `DHG - ${pendingExportTitle} - ${dateStr}`;
        generateProPDF(pendingExportSection, pendingExportTitle, filename, orientation, format);
    }
}

// Nouvelle version de generateProPDF qui accepte le format et l'orientation
function generateProPDF(section, title, filename, customOrientation, customFormat) {
    const { jsPDF } = window.jspdf;
    
    // Si pas de choix (ex: appel direct), valeurs par d√©faut
    const orient = customOrientation || 'landscape';
    const fmt = customFormat || 'a4';

    const doc = new jsPDF({ orientation: orient, format: fmt });
    
    const pageWidth = doc.internal.pageSize.width;
    const margin = 14;

    // Ajustement de la taille de police de base selon le format pour remplir l'espace
    // A3 permet d'√©crire plus gros ou d'avoir plus de colonnes
    let baseFontSize = (fmt === 'a3') ? 11 : 9;
    let headerFontSize = (fmt === 'a3') ? 11 : 9;

    // --- EN-T√äTE ---
    const addHeader = (data) => {
        doc.setTextColor(44, 62, 80);
        doc.setFontSize(16);
        doc.setFont("helvetica", "bold");
        doc.text(title.toUpperCase(), margin, 20); 
        
        doc.setFontSize(12);
        doc.setFont("helvetica", "bold");
        doc.setTextColor(100); 
        doc.text(`Rentr√©e ${DATA.config.year} - ${DATA.config.year+1}`, pageWidth - margin, 20, { align: 'right' });
        
        doc.setDrawColor(200, 200, 200);
        doc.line(margin, 25, pageWidth - margin, 25);
    };

    // --- VENTILATION (PILOTAGE) ---
    if (section === 'pilotage') {
        const needs = calculateNeeds();
        const rows = [];
        
        // (Logique de r√©cup√©ration des donn√©es identique...)
        const getStats = (sub) => {
            const profs = DATA.teachers.map((t, idx) => ({...t, idx: idx})).filter(t => t.subject === sub);
            const dechInt = profs.reduce((a,t)=>a+(t.decharge||0), 0);
            const dechExt = profs.reduce((a,t)=>a+(t.dech_ext||0), 0);
            const hp = profs.reduce((a,t)=> a + (t.ors - (t.csd||0) - (t.dech_ext||0)), 0);
            const hsa = profs.reduce((a,t)=>a+t.hsa, 0);
            const bes = (needs[sub] || 0) + dechInt;
            const app = hp + hsa;
            return { bes, app, hp, hsa, profs };
        };

        const roots = DATA.subjects.filter(s => !DATA.subjectMeta[s]?.parent).sort();
        
        roots.forEach(r => {
            const rStats = getStats(r);
            const kids = DATA.subjects.filter(s => DATA.subjectMeta[s]?.parent === r);
            
            if (kids.length > 0) {
                let poleBes = rStats.bes, poleApp = rStats.app, poleHP = rStats.hp, poleHSA = rStats.hsa;
                const kidsData = kids.map(k => {
                    const kStats = getStats(k);
                    poleBes += kStats.bes; poleApp += kStats.app; poleHP += kStats.hp; poleHSA += kStats.hsa;
                    return { name: k, stats: kStats };
                });
                const soldePole = poleApp - poleBes;

                rows.push({
                    col1: `P√îLE ${r.toUpperCase()}`,
                    col2: poleBes.toFixed(1), col3: poleApp.toFixed(1), col4: poleHP.toFixed(1), col5: poleHSA.toFixed(1), col6: soldePole.toFixed(1),
                    _style: { fillColor: [69, 90, 100], fontStyle: 'bold', textColor: 255 } // Gris Anthracite
                });

                addSubjectRows(rows, r, rStats, true);
                kidsData.forEach(kd => addSubjectRows(rows, kd.name, kd.stats, true));

            } else {
                // Mati√®re Solo : Style "En-t√™te" aussi
                rows.push({
                    col1: r,
                    col2: rStats.bes.toFixed(1), col3: rStats.app.toFixed(1), col4: rStats.hp.toFixed(1), col5: rStats.hsa.toFixed(1), col6: (rStats.app - rStats.bes).toFixed(1),
                    _style: { fillColor: [69, 90, 100], fontStyle: 'bold', textColor: 255 } // Gris Anthracite
                });
                
                // Profs de la mati√®re solo
                rStats.profs.forEach(p => addProfRow(rows, p, false));
            }
        });

        function addSubjectRows(targetArray, name, stats, indent) {
            // Pour les sous-mati√®res dans un p√¥le
            if(stats.bes === 0 && stats.app === 0) return;
            const solde = stats.app - stats.bes;
            const label = indent ? `   ${name}` : name; 

            targetArray.push({
                col1: label,
                col2: stats.bes.toFixed(1), col3: stats.app.toFixed(1), col4: stats.hp.toFixed(1), col5: stats.hsa.toFixed(1), col6: solde.toFixed(1),
                _style: { fillColor: [245, 245, 245], fontStyle: 'bold', textColor: 0 } // Gris tr√®s clair
            });
            stats.profs.forEach(p => addProfRow(targetArray, p, true));
        }

        function addProfRow(targetArray, p, indent) {
            const realContrib = (p.ors - (p.csd||0) - (p.dech_ext||0)) + p.hsa;
            let info = ""; 
            if(p.bmp>0) info += `BMP ${p.bmp}h `;
            if(p.csd>0) info += `(Dont ${p.csd}h CSD) `;
            if(p.decharge>0) info += `(Dont ${p.decharge}h DGH) `;
            
            const profLabel = indent ? `      ${p.name} (${p.status})` : `   ${p.name} (${p.status})`;

            targetArray.push({
                col1: profLabel,
                col2: '', col3: '', 
                col4: `${p.ors} ${info}`, 
                col5: p.hsa, 
                col6: realContrib.toFixed(1),
                _style: { fillColor: [255, 255, 255], fontStyle: 'normal', textColor: 50 }
            });
        }

        doc.autoTable({
            head: [['Discipline / Enseignant', 'Besoin', 'Apport', 'HP', 'HSA', 'Solde']],
            body: rows.map(r => [r.col1, r.col2, r.col3, r.col4, r.col5, r.col6]),
            startY: 35,
            theme: 'grid',
            headStyles: { fillColor: [52, 152, 219], textColor: 255, fontStyle: 'bold', halign: 'center', fontSize: headerFontSize },
            styles: { fontSize: baseFontSize, cellPadding: 1.5, valign: 'middle', halign: 'center', lineColor: [200,200,200], lineWidth: 0.1 },
            columnStyles: { 0: { halign: 'left', cellWidth: 'auto' } },
            didParseCell: function(data) {
                const rowObj = rows[data.row.index];
                if (data.section === 'body' && rowObj && rowObj._style) {
                    data.cell.styles.fillColor = rowObj._style.fillColor;
                    data.cell.styles.fontStyle = rowObj._style.fontStyle;
                    data.cell.styles.textColor = rowObj._style.textColor;
                }
            },
            didDrawPage: addHeader,
            margin: { top: 35, bottom: 20, left: margin, right: margin }
        });
    }

    // --- AUTRES (BILAN, PROFS, ETC.) ---
    else {
        let sourceElem = null;
        if (section === 'professeurs') sourceElem = document.getElementById('rh-table-list'); 
        else if (section === 'recap') sourceElem = document.getElementById('recap-table');
        else if (section === 'ventilation') sourceElem = document.querySelector('.grid-table');
        else if (section === 'structure') sourceElem = document.getElementById('structure-table');
        else if (section === 'matieres') sourceElem = document.getElementById('subjects-table');

        if (!sourceElem && section !== 'dashboard') { alert("Rien √† exporter."); return; }

        if (section === 'dashboard') {
             // (Code dashboard inchang√©...)
             addHeader();
             doc.save(`${filename}.pdf`);
             return;
        }

        // Nettoyage avant export
        const cleanT = cleanTableForExport(sourceElem);
        
        doc.autoTable({
            html: cleanT,
            startY: 35,
            theme: 'grid',
            headStyles: { fillColor: [52, 152, 219], textColor: 255, fontStyle: 'bold', halign: 'center', fontSize: headerFontSize },
            styles: { fontSize: baseFontSize, textColor: 50, valign: 'middle', halign: 'center', cellPadding: 1 },
            
            // Gestion des couleurs pour le BILAN
            didParseCell: function(data) {
                if(section === 'recap' && data.section === 'body') {
                    const rowRaw = data.row.raw;
                    // Si la ligne a la classe "row-header" (notre gris anthracite)
                    if(rowRaw.classList && rowRaw.classList.contains('row-header')) {
                         data.cell.styles.fillColor = [69, 90, 100]; // Gris Anthracite
                         data.cell.styles.textColor = 255;
                         data.cell.styles.fontStyle = 'bold';
                    }
                }
            },
            
            didDrawPage: addHeader,
            margin: { top: 35, bottom: 20, left: margin, right: margin }
        });
    }

    doc.save(`${filename}.pdf`);
}

function cleanTableForExport(original) {
    if (!original) return null;
    const clone = original.cloneNode(true);

    // 1. Suppression Colonne Code
    const codeHeader = clone.querySelector('.col-code-header');
    if(codeHeader) codeHeader.remove();
    clone.querySelectorAll('.col-code').forEach(el => el.remove());

    // 2. Aplatissement des Inputs
    clone.querySelectorAll('.td-class').forEach(td => {
        const btn = td.querySelector('.class-name-btn');
        const name = btn ? btn.innerText : td.innerText;
        td.innerHTML = '';
        td.innerText = name.trim();
        td.style.fontWeight = 'bold';
        td.style.textAlign = 'center'; 
    });

    clone.querySelectorAll('.vertical-stack').forEach(stack => {
        const inputs = stack.querySelectorAll('input');
        if(inputs.length === 2) {
            const base = parseFloat(inputs[0].value || 0);
            const marge = parseFloat(inputs[1].value || 0);
            const span = document.createElement('span');
            span.innerText = marge > 0 ? `${base} + ${marge}` : base;
            span.style.whiteSpace = 'nowrap';
            stack.parentNode.replaceChild(span, stack);
        }
    });

    clone.querySelectorAll('input').forEach(input => {
        const span = document.createElement('span');
        span.innerText = input.value !== "" ? input.value : "";
        input.parentNode.replaceChild(span, input);
    });

    clone.querySelectorAll('select').forEach(select => {
        const span = document.createElement('span');
        span.innerText = select.options[select.selectedIndex]?.text || "";
        select.parentNode.replaceChild(span, select);
    });

    // 3. Nettoyage Interface
    clone.querySelectorAll('button, .del-badge, .btn, label, input[type=checkbox]').forEach(el => el.remove());

    // 4. Nettoyage En-t√™tes
    clone.querySelectorAll('th').forEach(th => {
        const text = th.innerText.trim().replace(/\s+/g, ' '); 
        th.innerHTML = text;
        th.style.width = 'auto';
        th.style.height = 'auto';
    });
    
    // 5. Suppression Colonne Actions
    const headers = clone.querySelectorAll('th');
    let actionIndex = -1;
    headers.forEach((th, idx) => {
        if(th.innerText.includes('Act') || th.innerText.includes('Suppr') || th.innerText.includes('Actions') || th.innerText.includes('Action')) actionIndex = idx;
    });
    
    if (actionIndex > -1) {
        headers[actionIndex].remove();
        clone.querySelectorAll('tbody tr').forEach(tr => {
            if(tr.cells.length > actionIndex) tr.deleteCell(actionIndex);
        });
    }

    // --- 6. OPTIMISATION ET NETTOYAGE DES ICONES ---
    clone.querySelectorAll('td').forEach(el => {
        // Suppression fl√®ches
        if(el.innerText.includes('‚Ü≥')) {
            el.innerText = el.innerText.replace(/‚Ü≥/g, '').trim();
        }
        
        // AJOUT : Suppression de l'ic√¥ne BO√éTE/POLE (üì¶) pour le PDF
        if(el.innerText.includes('üì¶')) {
            el.innerText = el.innerText.replace(/üì¶/g, '').trim();
        }
        
        // Nettoyage g√©n√©ral
        el.innerHTML = el.innerText.replace(/\n/g, ' ').replace(/\s+/g, ' ').trim();
        
        // Compactage visuel
        el.style.paddingLeft = '2px';
        el.style.textAlign = 'left';
    });

    return clone;
}

function renderTeams() {
    const t = document.getElementById('teams-table');
    if (!t) return;
    t.innerHTML = '';
    
    // Modification de la l√©gende (inchang√©)
    const legendContainer = t.closest('.card').querySelector('.card-header div[style*="font-style:italic"]');
    if (legendContainer) {
        legendContainer.innerHTML = `
            <span style="display:flex; align-items:center;"><span style="width:12px; height:12px; background:#27ae60; margin-right:4px;"></span>Classe</span>
            <span style="display:flex; align-items:center; margin-left:10px;"><span style="width:12px; height:12px; background:#3498db; margin-right:4px;"></span>Partage de classe</span>
            <span style="margin-left:10px;">üëë Clic Droit = Prof Principal</span>
            <span style="color:#c0392b; font-weight:bold; margin-left:10px;">Rouge = Prof manquant</span>
        `;
    }

    // Construction du Header (inchang√©)
    let headerHTML = '<thead><tr><th style="min-width:220px; text-align:left; padding-left:10px;">Mati√®re / Enseignant</th>';
    DATA.structure.forEach(lvl => {
        const prefix = getLevelPrefix(lvl.level);
        for(let i=0; i<lvl.div; i++) {
            const defId = `${prefix}${String.fromCharCode(65+i)}`;
            const displayName = DATA.classNames[defId] || defId;
            headerHTML += `<th style="width:45px; font-size:0.8rem;">${displayName}</th>`;
        }
    });
    headerHTML += '</tr></thead>';
    t.innerHTML = headerHTML;
    
    const body = document.createElement('tbody');
    const roots = DATA.subjects.filter(s => !DATA.subjectMeta[s]?.parent).sort();
    const organized = [];
    
    // Organisation hi√©rarchique
    roots.forEach(r => { 
        organized.push({name: r, isChild: false}); 
        DATA.subjects.filter(s => DATA.subjectMeta[s]?.parent === r).forEach(c => organized.push({name: c, isChild: true, parent: r})); 
    });

    organized.forEach(subjItem => {
        const sub = subjItem.name;
        const meta = DATA.subjectMeta[sub] || {};
        let isSubjectVisible = false;

        // V√©rification de visibilit√© (inchang√©)
        DATA.structure.forEach(lvl => {
            const prefix = getLevelPrefix(lvl.level);
            for(let i=0; i<lvl.div; i++) {
                const cId = `${prefix}${String.fromCharCode(65+i)}`;
                if (getHoursForClassSubject(cId, lvl.level, sub) > 0) isSubjectVisible = true;
            }
        });
        
        if (!isSubjectVisible) return;

        // Titre de la section Mati√®re
        body.innerHTML += `<tr class="team-subject-row"><td colspan="100%">${sub}</td></tr>`;

        // --- NOUVELLE LOGIQUE DE FUSION ---
        
        // 1. Les titulaires
        const mainProfs = DATA.teachers
            .map((p, idx) => ({...p, idx}))
            .filter(p => p.subject === sub);
            
        // 2. Les invit√©s (Disciplines associ√©es)
        let guestProfs = [];
        if (meta.linkedSubjects && meta.linkedSubjects.length > 0) {
            guestProfs = DATA.teachers
                .map((p, idx) => ({...p, idx}))
                .filter(p => meta.linkedSubjects.includes(p.subject));
        }

        // 3. Fusion et Tri
        const profs = [...mainProfs, ...guestProfs].sort((a, b) => a.name.localeCompare(b.name));
        
        // ----------------------------------

        profs.forEach(p => {
            // Affichage distinctif pour les invit√©s
            let displayName = p.name;
            if (p.subject !== sub) {
                displayName += ` <span style="font-size:0.75rem; color:#e67e22; font-weight:normal;">(${p.subject})</span>`;
            }

            let rowHTML = `<tr><td class="team-teacher-label" title="${p.name}">${displayName}</td>`;
            
            // G√©n√©ration des cellules (Logique inchang√©e)
            DATA.structure.forEach(lvl => {
                const prefix = getLevelPrefix(lvl.level);
                for(let i=0; i<lvl.div; i++) {
                    const cId = `${prefix}${String.fromCharCode(65+i)}`;
                    const key = `${cId}_${p.idx}`;
                    const assign = DATA.assignments[key];
                    const hours = getHoursForClassSubject(cId, lvl.level, sub);
                    
                    let cellClass = "cell-assign";
                    let content = "";
                    
                    if (hours <= 0) {
                        cellClass += " cell-disabled";
                    } else if (assign) {
                        cellClass += assign.mode === 'GROUP' ? " mode-group" : " mode-class";
                        content = assign.mode === 'GROUP' ? "üë•" : "‚úÖ";
                        if(assign.isPP) cellClass += " is-pp";
                    } else {
                        cellClass += " missing-teacher";
                    }
                    
                    const actions = hours > 0 ? `onclick="toggleTeamAssign('${cId}', ${p.idx})" oncontextmenu="toggleTeamPP(event, '${cId}', ${p.idx})"` : "";
                    rowHTML += `<td><div class="${cellClass}" ${actions}>${content}</div></td>`;
                }
            });
            rowHTML += `</tr>`;
            body.innerHTML += rowHTML;
        });

        // Cas vide (inchang√©)
        if(profs.length === 0) {
            let rowHTML = `<tr><td class="team-teacher-label" style="font-style:italic; color:#999;">(Aucun enseignant)</td>`;
            DATA.structure.forEach(lvl => {
                const prefix = getLevelPrefix(lvl.level);
                for(let i=0; i<lvl.div; i++) {
                    const cId = `${prefix}${String.fromCharCode(65+i)}`;
                    if (getHoursForClassSubject(cId, lvl.level, sub) <= 0) rowHTML += `<td><div class="cell-assign cell-disabled"></div></td>`;
                    else rowHTML += `<td><div class="cell-assign missing-teacher"></div></td>`;
                }
            });
            body.innerHTML += rowHTML + `</tr>`;
        }
    });
    t.appendChild(body);
}

function toggleTeamAssign(cId, tIdx) {
    const key = `${cId}_${tIdx}`;
    const teacher = DATA.teachers[tIdx];

    if (!DATA.assignments[key]) {
        const lvlName = DATA.structure.find(l => cId.startsWith(getLevelPrefix(l.level)))?.level;
        const h = getHoursForClassSubject(cId, lvlName, teacher.subject);
        DATA.assignments[key] = { mode: 'CLASS', quota: h, isPP: false };
    } else {
        delete DATA.assignments[key];
    }

    // Recalcul imm√©diat des modes pour la classe/mati√®re
    const subject = teacher.subject;
    const assigned = DATA.teachers.map((t, i) => i)
        .filter(idx => DATA.assignments[`${cId}_${idx}`] && DATA.teachers[idx].subject === subject);

    const newMode = assigned.length > 1 ? 'GROUP' : 'CLASS';
    assigned.forEach(idx => { DATA.assignments[`${cId}_${idx}`].mode = newMode; });

    saveData();
    renderTeams();
}

// Clic Droit : Prof Principal
function toggleTeamPP(e, cId, tIdx) {
    e.preventDefault(); // Bloque le menu contextuel du navigateur
    if(!DATA.assignments) DATA.assignments = {};
    const key = `${cId}_${tIdx}`;
    
    // Si la case est vide, le clic droit l'active en "Classe enti√®re" direct
    if(!DATA.assignments[key]) DATA.assignments[key] = { mode: 'CLASS', isPP: false };
    
    DATA.assignments[key].isPP = !DATA.assignments[key].isPP;
    saveData();
    renderTeams();
}

function exportTeamsListsPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const pageWidth = doc.internal.pageSize.width;
    let pageAdded = false;

    DATA.structure.forEach(lvl => {
        const prefix = lvl.level.replace(/[^0-9]/g, '') || lvl.level.charAt(0);
        for(let i=0; i<lvl.div; i++) {
            const cId = `${prefix}${String.fromCharCode(65+i)}`;
            const displayName = DATA.classNames[cId] || cId;
            
            if(pageAdded) doc.addPage();
            pageAdded = true;

            // Titre Classe
            doc.setFillColor(44, 62, 80);
            doc.rect(0, 0, pageWidth, 25, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(16);
            doc.setFont("helvetica", "bold");
            doc.text(`√âQUIPE P√âDAGOGIQUE - ${displayName}`, pageWidth/2, 16, { align: 'center' });

            let ppName = "Non d√©sign√©";
            for(const [key, val] of Object.entries(DATA.assignments)) {
                if(key.startsWith(cId+'_') && val.isPP) {
                    const idx = parseInt(key.split('_')[1]);
                    const teacher = DATA.teachers[idx];
                    if(teacher) {
                        const sub = teacher.subject;
                        const meta = DATA.subjectMeta[sub] || {};
                        let isActive = false;
                        if (meta.mode === 'div') {
                             const ov = DATA.classOverrides[cId] && DATA.classOverrides[cId][sub];
                             const cfg = DATA.levelConfig[lvl.level] && DATA.levelConfig[lvl.level][sub];
                             if( ((ov||cfg).base||0) + ((ov||cfg).marge||0) > 0 ) isActive = true;
                        } else if (meta.mode === 'level') {
                             if( (meta.volLevel && meta.volLevel[lvl.level] > 0) ) isActive = true;
                        }
                        if(isActive) ppName = teacher.name;
                    }
                }
            }

            doc.setFontSize(11);
            doc.text(`Professeur Principal : ${ppName}`, pageWidth/2, 23, { align: 'center' });

            const tableBody = [];
             const roots = DATA.subjects.filter(s => !DATA.subjectMeta[s]?.parent).sort();
             const organized = [];
             roots.forEach(r => { 
                organized.push(r); 
                DATA.subjects.filter(s => DATA.subjectMeta[s]?.parent === r).forEach(c => organized.push(c)); 
             });

             organized.forEach(sub => {
                 const meta = DATA.subjectMeta[sub] || {};
                 let hours = 0;
                 if (meta.mode === 'etab') return;

                 if (meta.mode === 'div') {
                     const ov = DATA.classOverrides[cId] && DATA.classOverrides[cId][sub];
                     const cfg = DATA.levelConfig[lvl.level] && DATA.levelConfig[lvl.level][sub];
                     if(ov || cfg) hours = ((ov||cfg).base||0) + ((ov||cfg).marge||0);
                 } else if (meta.mode === 'level') {
                     hours = (meta.volLevel && meta.volLevel[lvl.level]) || 0;
                 }
                 
                 if (hours <= 0) return; 

                 const assignedProfs = [];
                 DATA.teachers.forEach((t, idx) => {
                     if(t.subject === sub) {
                         const key = `${cId}_${idx}`;
                         if(DATA.assignments[key] && DATA.assignments[key].mode) {
                             let name = t.name;
                             // MODIFICATION ICI : Terme "Partage"
                             if(DATA.assignments[key].mode === 'GROUP') name += " (Partage)";
                             if(DATA.assignments[key].isPP) name += " (PP)";
                             assignedProfs.push(name);
                         }
                     }
                 });

                 if(assignedProfs.length > 0) {
                     tableBody.push([sub, assignedProfs.join(', ')]);
                 }
             });

            doc.autoTable({
                head: [['Mati√®re', 'Enseignant(s)']],
                body: tableBody,
                startY: 35,
                theme: 'grid',
                headStyles: { fillColor: [52, 152, 219] },
                columnStyles: { 0: { fontStyle: 'bold', width: 60 } }
            });
        }
    });
    doc.save(`Equipes_Pedagogiques_${DATA.config.year}.pdf`);
}

// Variables d'√©tat pour l'export
let expConfig = {
    orientation: 'landscape', // 'portrait' ou 'landscape'
    format: 'a3'              // 'a4' ou 'a3'
};

function openExportModal() {
    document.getElementById('export-overlay').style.display = 'flex';
    // On remet les valeurs par d√©faut visuellement
    setExportParam('orientation', 'landscape');
    setExportParam('format', 'a3');
}

function setExportParam(type, value) {
    // Mise √† jour de la config
    expConfig[type] = value;
    
    // Mise √† jour visuelle (Classe .selected)
    if (type === 'orientation') {
        document.getElementById('tile-orient-portrait').classList.toggle('selected', value === 'portrait');
        document.getElementById('tile-orient-landscape').classList.toggle('selected', value === 'landscape');
    } else if (type === 'format') {
        document.getElementById('tile-format-a4').classList.toggle('selected', value === 'a4');
        document.getElementById('tile-format-a3').classList.toggle('selected', value === 'a3');
    }
}

function confirmTeamExport() {
    const forceOnePage = document.getElementById('chk-force-one-page').checked;
    exportTeamsGridPDF(expConfig.orientation, expConfig.format, forceOnePage);
    document.getElementById('export-overlay').style.display = 'none';
}

function exportTeamsGridPDF(orientation, format, forceOnePage) {
    const { jsPDF } = window.jspdf;
    
    const doc = new jsPDF({ 
        orientation: orientation, 
        format: format 
    });
    
    const dateStr = new Date().toLocaleDateString('fr-FR');
    const pageWidth = doc.internal.pageSize.width;
    const margin = 14;

    // --- 1. EN-T√äTE ---
    doc.setFontSize(14);
    doc.setFont("helvetica", "bold");
    doc.text("√âQUIPES P√âDAGOGIQUES", margin, 15);
    
    doc.setFontSize(10);
    doc.setFont("helvetica", "normal");
    doc.text(`Version du ${dateStr}`, margin, 20);
    
    doc.setFontSize(9);
    doc.setTextColor(100);
    
    const legendX = orientation === 'landscape' ? pageWidth - margin : margin;
    const legendAlign = orientation === 'landscape' ? 'right' : 'left';
    const legendY = orientation === 'landscape' ? 15 : 25;
    
    // MODIFICATION DE LA L√âGENDE ICI
    doc.text("L√©gende : Vert = Classe | Bleu = Partage de classe | (PP) = Prof. Principal", legendX, legendY, { align: legendAlign });
    doc.setTextColor(0);

    let baseFontSize = 8;
    let cellPadding = 1;
    
    if (forceOnePage) {
        baseFontSize = 7;
        cellPadding = 0.8;
        if (orientation === 'portrait' && format === 'a4') {
            baseFontSize = 5;
            cellPadding = 0.5;
        } else if (format === 'a4' || orientation === 'portrait') {
            baseFontSize = 6;
        }
    } else {
        if (format === 'a3' && orientation === 'landscape') {
            baseFontSize = 10;
        }
    }

    const columns = [
        { header: 'Discipline / Enseignant', dataKey: 'libelle' }
    ];
    
    const classKeys = [];
    DATA.structure.forEach(lvl => {
        const prefix = lvl.level.replace(/[^0-9]/g, '') || lvl.level.charAt(0);
        for(let i=0; i<lvl.div; i++) {
            const cId = `${prefix}${String.fromCharCode(65+i)}`;
            const cName = DATA.classNames[cId] || cId;
            columns.push({ header: cName, dataKey: cId });
            classKeys.push(cId);
        }
    });

    const colNameWidth = (format === 'a3' && orientation === 'landscape') ? 80 : 50;
    const availableWidth = pageWidth - (margin * 2) - colNameWidth;
    const nbClasses = classKeys.length;
    const colClassWidth = nbClasses > 0 ? (availableWidth / nbClasses) : 20;

    let customColStyles = { 
        0: { cellWidth: colNameWidth, halign: 'left' } 
    };
    for(let i=1; i <= nbClasses; i++) {
        customColStyles[i] = { cellWidth: colClassWidth, halign: 'center' };
    }

    const rows = [];
    const roots = DATA.subjects.filter(s => !DATA.subjectMeta[s]?.parent).sort();
    const organized = [];
    roots.forEach(r => { 
        organized.push({name: r, isChild: false}); 
        DATA.subjects.filter(s => DATA.subjectMeta[s]?.parent === r).forEach(c => organized.push({name: c, isChild: true, parent: r})); 
    });

    organized.forEach(subjItem => {
        const sub = subjItem.name;
        let isVisible = false;
        const meta = DATA.subjectMeta[sub] || {};
        if (meta.mode !== 'etab') {
            DATA.structure.forEach(lvl => {
                 const prefix = lvl.level.replace(/[^0-9]/g, '') || lvl.level.charAt(0);
                 for(let i=0; i<lvl.div; i++) {
                    const cId = `${prefix}${String.fromCharCode(65+i)}`;
                    if (DATA.levelConfig[lvl.level] && DATA.levelConfig[lvl.level][sub] && DATA.levelConfig[lvl.level][sub].base > 0) isVisible = true;
                    if (DATA.classOverrides[cId] && DATA.classOverrides[cId][sub] && DATA.classOverrides[cId][sub].base > 0) isVisible = true;
                    if (meta.mode === 'level' && meta.volLevel && meta.volLevel[lvl.level] > 0) isVisible = true;
                 }
            });
        }
        if (!isVisible) return;

        rows.push({ libelle: sub, isSubjectRow: true });

        const profs = DATA.teachers.map((p, idx) => ({...p, idx})).filter(p => p.subject === sub);
        profs.forEach(p => {
            const pRow = { libelle: p.name, isSubjectRow: false };
            classKeys.forEach(cId => {
                const key = `${cId}_${p.idx}`;
                const assign = (DATA.assignments && DATA.assignments[key]) ? DATA.assignments[key] : null;
                if (assign) {
                    let txt = "";
                    if (assign.mode === 'CLASS') txt = "X";
                    // MODIFICATION ICI : Abr√©viation "Ptg" pour "Partage"
                    if (assign.mode === 'GROUP') txt = "Ptg";
                    if (assign.isPP) txt += " PP";
                    pRow[cId] = txt;
                    pRow[`_style_${cId}`] = {
                        fillColor: assign.mode === 'CLASS' ? [39, 174, 96] : [52, 152, 219],
                        textColor: 255,
                        fontStyle: assign.isPP ? 'bold' : 'normal'
                    };
                }
            });
            rows.push(pRow);
        });
    });

    doc.autoTable({
        columns: columns,
        body: rows,
        startY: orientation === 'landscape' ? 25 : 30,
        theme: 'grid',
        styles: { 
            fontSize: baseFontSize,
            cellPadding: cellPadding,
            valign: 'middle', 
            lineWidth: 0.1,
            lineColor: [200, 200, 200],
            overflow: 'linebreak'
        },
        headStyles: {
            fillColor: [44, 62, 80],
            textColor: 255,
            fontStyle: 'bold',
            halign: 'center',
            fontSize: baseFontSize + 1
        },
        columnStyles: customColStyles,
        didParseCell: function(data) {
            if (data.row.raw.isSubjectRow) {
                data.cell.styles.fillColor = [230, 230, 250];
                data.cell.styles.fontStyle = 'bold';
                data.cell.styles.textColor = [0, 0, 0];
                if(data.column.index > 0) data.cell.text = "";
            }
            if (!data.row.raw.isSubjectRow && data.column.dataKey !== 'libelle') {
                const styleMeta = data.row.raw[`_style_${data.column.dataKey}`];
                if (styleMeta) {
                    data.cell.styles.fillColor = styleMeta.fillColor;
                    data.cell.styles.textColor = styleMeta.textColor;
                    data.cell.styles.fontStyle = styleMeta.fontStyle;
                }
            }
        }
    });

    doc.save(`Equipes_Pedagogiques_${format.toUpperCase()}_${orientation}.pdf`);
}

// --- FONCTION DE MISE √Ä JOUR DES COMPTEURS (WIDGET & GLOBALS) ---
function updateGridCounter() {
    if (!DATA) return;

    // --- 1. CALCUL GLOBAL √âTABLISSEMENT ---
    let totalConsoEtab = 0;
    
    // A. Ajout des EDS (Le forfait global)
    if (DATA.type !== 'college' && DATA.eds) {
        ['premiere', 'terminale'].forEach(lvl => {
            if (DATA.eds[lvl]) {
                DATA.eds[lvl].forEach(e => {
                    const vol = parseFloat(e.hPerGroup) || (lvl === 'premiere' ? 4 : 6);
                    totalConsoEtab += (parseFloat(e.groups) || 0) * vol;
                });
            }
        });
    }

    // B. Ajout du Tronc Commun (On ignore les mati√®res EDS ici)
    DATA.structure.forEach(lvl => {
        const prefix = getLevelPrefix(lvl.level);
        for(let i=0; i<lvl.div; i++) {
            const cId = `${prefix}${String.fromCharCode(65+i)}`;
            DATA.subjects.forEach(s => {
                const meta = DATA.subjectMeta[s];
                // CORRECTIF : On saute si c'est un EDS
                if (meta && meta.isEds) return; 

                if (meta && meta.mode === 'div') {
                    const cfg = (DATA.classOverrides && DATA.classOverrides[cId] && DATA.classOverrides[cId][s]) 
                                ? DATA.classOverrides[cId][s] 
                                : DATA.levelConfig[lvl.level][s];
                    if (cfg) totalConsoEtab += ((cfg.base||0) + (cfg.marge||0)) * (cfg.coef||1);
                }
            });
        }
        DATA.subjects.forEach(s => {
             const meta = DATA.subjectMeta[s];
             // CORRECTIF : On saute si c'est un EDS
             if (meta && meta.isEds) return;

             if (meta && meta.mode === 'level' && meta.volLevel && meta.volLevel[lvl.level]) {
                 totalConsoEtab += parseFloat(meta.volLevel[lvl.level] || 0);
             }
        });
    });

    // C. Ajout d√©charges et forfaits Etab
    DATA.subjects.forEach(s => { 
        if(DATA.subjectMeta[s] && DATA.subjectMeta[s].mode === 'etab') 
            totalConsoEtab += parseFloat(DATA.subjectMeta[s].etab || 0); 
    });
    DATA.teachers.forEach(t => { totalConsoEtab += parseFloat(t.decharge || 0); });

    // Mise √† jour des Widgets
    const dotationEtab = DATA.config.total || 0;
    const soldeEtab = dotationEtab - totalConsoEtab;
    const etabValEl = document.getElementById('kpi-etab-val');
    if (etabValEl) {
        etabValEl.innerText = `${totalConsoEtab.toFixed(1)} / ${dotationEtab.toFixed(1)} h`;
        updateKpiTag('kpi-etab-diff', soldeEtab);
    }
    
    // (Le reste de la fonction pour le Widget Niveau reste identique...)
    const activeTab = document.querySelector('#grid-tabs .tab.active');
    const levelRow = document.getElementById('kpi-level-row');
    if (!activeTab || activeTab.classList.contains('global-tab')) {
        if (levelRow) levelRow.style.display = 'none';
    } else {
        if (levelRow) levelRow.style.display = 'flex';
        const levelName = activeTab.innerText;
        const lvlObj = DATA.structure.find(l => l.level === levelName);
        if (lvlObj) {
            const dotationNiveau = (lvlObj.div * lvlObj.target); 
            const grilleTotalEl = document.getElementById('total-final-grille');
            const consoNiveau = grilleTotalEl ? parseFloat(grilleTotalEl.innerText) : 0;
            const soldeNiveau = dotationNiveau - consoNiveau;
            const lvlValEl = document.getElementById('kpi-lvl-val');
            if (lvlValEl) {
                lvlValEl.innerText = `${consoNiveau.toFixed(1)} / ${dotationNiveau.toFixed(1)} h`;
                updateKpiTag('kpi-lvl-diff', soldeNiveau);
            }
        }
    }
}

// Petit helper pour la couleur du badge (Correctif inclus)
function updateKpiTag(id, val) {
    const el = document.getElementById(id);
    if(!el) return;
    const sign = val > 0 ? "+" : "";
    el.innerText = `${sign}${val.toFixed(1)}`;
    el.className = 'kpi-tag'; 
    if(Math.abs(val) < 0.1) el.classList.add('bg-nul');
    else if(val > 0) el.classList.add('bg-pos');
    else el.classList.add('bg-neg');
}


function changeTab(el, idx) {
    document.querySelectorAll('#grid-tabs .tab').forEach(t => t.classList.remove('active'));
    el.classList.add('active');
    window.lastActiveGridTab = idx;
    if(idx === -1) renderGlobalGrid();
    else renderLevelGrid(idx);
    
    // AJOUT ICI : Mettre √† jour le compteur (Etab + Niveau actif)
    updateGridCounter();
}

/* --- GESTION AVANC√âE DES D√âCHARGES --- */
let currentDechIdx = -1;

function openDechargeMenu(idx) {
    currentDechIdx = idx;
    const t = DATA.teachers[idx];
    
    // On remplit les champs du pop-up avec les valeurs actuelles du prof
    document.getElementById('dech-teacher-name').innerText = t.name;
    document.getElementById('input-dech-int').value = t.decharge || 0;
    document.getElementById('input-dech-ext').value = t.dech_ext || 0;
    
    // Affichage du pop-up
    document.getElementById('dech-overlay').style.display = 'flex';
    document.getElementById('input-dech-int').focus();
}

function saveDechargeDetails() {
    if (currentDechIdx === -1) return;
    
    const valInt = parseFloat(document.getElementById('input-dech-int').value) || 0;
    const valExt = parseFloat(document.getElementById('input-dech-ext').value) || 0;
    
    const t = DATA.teachers[currentDechIdx];
    
    // V√©rification de coh√©rence avant modification
    if ((valInt + valExt) > t.ors) {
        alert("Attention : Le total des d√©charges d√©passe l'ORS du professeur !");
        return;
    }
    
    // On applique les modifications seulement maintenant
    t.decharge = valInt;
    t.dech_ext = valExt;
    
    // Sauvegarde et mise √† jour de l'interface
    saveData();
    
    // Fermeture du pop-up AVANT les rafra√Æchissements lourds pour √©viter les blocages visuels
    document.getElementById('dech-overlay').style.display = 'none';
    
    // Mise √† jour des tableaux
    renderRH();
    if (document.getElementById('pilotage').classList.contains('active')) renderRHDisc();
    calculateRecap();
    
    currentDechIdx = -1;
}

function setBMP(idx) {
    const t = DATA.teachers[idx];
    const current = t.bmp || 0;
    
    const val = prompt(`G√©rer BMP / CSR pour ${t.name}.\n\nSaisissez le volume horaire de ce bloc.\n(Cela remplacera automatiquement la valeur de l'ORS).`, current);
    
    if (val !== null) {
        const hours = parseFloat(val);
        if (isNaN(hours) || hours < 0) return alert("Valeur invalide");
        
        t.bmp = hours;
        
        // Logique m√©tier : Si c'est un BMP, l'ORS devient √©gal au volume du BMP
        if (hours > 0) {
            t.ors = hours;
            t.status = "BMP/CSR"; // On met √† jour le statut automatiquement
        } else {
            // Si on remet √† 0, on repasse en Certifi√© par d√©faut (√† ajuster manuellement si besoin)
            if(t.status === "BMP/CSR") t.status = "Certifi√©";
        }

        saveData();
        
        // Rafra√Æchissement intelligent selon la page active
        if (document.getElementById('pilotage').classList.contains('active')) {
            renderRHDisc();
        } else {
            renderRH();
        }
        calculateRecap();
    }
}

/* --- EXPORT PPTX POUR CA (VERSION NETTOY√âE - SANS EDS DANS LES GRILLES) --- */
function generateCAPres() {
    // 1. Initialisation
    let pptx = new PptxGenJS();
    pptx.layout = 'LAYOUT_16x9'; 
    
    const colors = {
        primary: "2C3E50", secondary: "3498DB", accent: "E67E22",
        tableHeader: "34495E", tableRowAlt: "F4F6F6", success: "27AE60",
        danger: "C0392B", poleHeader: "455A64", text: "2C3E50",
        white: "FFFFFF", black: "000000", border: "BDC3C7"
    };

    const headerStyles = { fill: colors.tableHeader, color: colors.white, bold: true, halign: 'center', valign:'middle' };
    const stdBorder = { pt: 0.5, color: colors.border };
    const chunkArray = (arr, size) => Array.from({ length: Math.ceil(arr.length / size) }, (v, i) => arr.slice(i * size, i * size + size));
    const addFooter = (slide, text) => {
        slide.addText(text, { x: 0.5, y: 5.3, fontSize: 8, color: "95A5A6" });
        slide.addText(`DHG ${DATA.config.year}`, { x: 9, y: 5.3, w:0.5, fontSize: 8, color: "95A5A6", align:'right' });
    };

    // --- 1. SLIDE INTRO ---
    let s1 = pptx.addSlide();
    s1.background = { color: "ECF0F1" };
    s1.addShape(pptx.ShapeType.rect, { x: 0, y: 0, w: 0.6, h: '100%', fill: colors.primary });
    s1.addText("CONSEIL D'ADMINISTRATION", { x: 1.2, y: 2.0, w: '80%', fontSize: 20, bold: true, color: colors.secondary, spc:2 });
    s1.addText("PR√âPARATION RENTR√âE", { x: 1.2, y: 2.6, w: '80%', fontSize: 36, bold: true, color: colors.primary });
    s1.addText(`Ann√©e Scolaire ${DATA.config.year} - ${DATA.config.year + 1}`, { x: 1.2, y: 3.8, w: '80%', fontSize: 18, color: "7F8C8D", italic:true });

    // --- 2. STRUCTURE & MOYENS ---
    let s2 = pptx.addSlide();
    s2.addText("1. Structure & Moyens", { x: 0.5, y: 0.3, fontSize: 18, bold: true, color: colors.primary });
    s2.addShape(pptx.ShapeType.line, { x:0.5, y:0.7, w:9, h:0, line:{color:colors.accent, width:2} });

    // 1. On ajoute la colonne H/Div dans les en-t√™tes (J'ai ajust√© les largeurs 'w' pour que √ßa rentre)
    let structHeaders = [
        { text: "Niveau", options: { ...headerStyles, fill: colors.secondary, w: 1.1 } },
        { text: "Eff.", options: { ...headerStyles, fill: colors.secondary, w: 0.7 } },
        { text: "Div.", options: { ...headerStyles, fill: colors.secondary, w: 0.6 } },
        { text: "E/D", options: { ...headerStyles, fill: colors.secondary, w: 0.7 } },
        { text: "H/Div", options: { ...headerStyles, fill: colors.secondary, w: 0.8 } }, // <--- NOUVELLE COLONNE
        { text: "Dotation", options: { ...headerStyles, fill: colors.primary, w: 1.1 } }
    ];

    let structRows = [];
    let totEleves = 0, totDiv = 0, totDot = 0;

    DATA.structure.forEach(lvl => {
        const div = parseFloat(lvl.div) || 0;
        const target = parseFloat(lvl.target) || 0; // Le H/E (Heures par division)
        const students = parseInt(lvl.students) || 0;
        
        // Calcul simple : Div x H/Div
        let need = div * target;

        structRows.push([
            { text: lvl.level, options: { bold: true, align: 'left', border: stdBorder } },
            { text: students.toString(), options: { border: stdBorder } },
            { text: div.toString(), options: { border: stdBorder } },
            { text: div > 0 ? (students/div).toFixed(1) : "-", options: { border: stdBorder } },
            { text: target.toFixed(1), options: { border: stdBorder, fill: "F4F6F6" } }, // <--- AFFICHAGE H/DIV
            { text: need.toFixed(1), options: { bold: true, color: colors.primary, border: stdBorder } }
        ]);

        totEleves += students; 
        totDiv += div; 
        totDot += need;
    });

    // Gestion des moyens suppl√©mentaires
    const supp = DATA.additionalMeans ? parseFloat(DATA.additionalMeans.total || 0) : 0;
    if(supp > 0) {
        // On met un colspan de 5 pour couvrir jusqu'√† la colonne Dotation
        structRows.push([
            { text: "Moyens Suppl√©mentaires", options: { colspan: 5, align: 'right', italic: true, color: "8D6E63", fill: colors.white, border: stdBorder } }, 
            { text: "+ " + supp.toFixed(1), options: { bold: true, color: colors.accent, fill: colors.white, border: stdBorder, align: 'center' } }
        ]);
        totDot += supp;
    }
    
    // Ligne TOTAL
    structRows.push([
        { text: "TOTAL", options: { fill: "D5D8DC", bold: true, border: stdBorder } }, 
        { text: totEleves.toString(), options: { fill: "D5D8DC", bold: true, border: stdBorder } }, 
        { text: totDiv.toString(), options: { fill: "D5D8DC", bold: true, border: stdBorder } }, 
        { text: totDiv>0?(totEleves/totDiv).toFixed(1):"-", options: { fill: "D5D8DC", bold: true, border: stdBorder } }, 
        { text: "-", options: { fill: "D5D8DC", bold: true, border: stdBorder } }, // Pas de total pour H/Div
        { text: totDot.toFixed(1), options: { fill: "D5D8DC", bold: true, color: colors.primary, border: stdBorder } }
    ]);
    
    // G√©n√©ration du tableau (J'ai l√©g√®rement √©largi le tableau √† w: 5.0 pour l'esth√©tique)
    s2.addTable([structHeaders, ...structRows], { x: 0.5, y: 1.2, w: 5.0, fontSize: 10, rowH: 0.4, align:'center', valign:'middle', fill: { color: colors.tableRowAlt } });

    // --- Partie Droite (Reste inchang√©) ---
    const dhgTotale = parseFloat(DATA.config.total || 0);
    const hp = parseFloat(DATA.config.hp || 0);
    const hsa = parseFloat(DATA.config.hsa || 0);
    const percentHSA = dhgTotale > 0 ? ((hsa / dhgTotale) * 100).toFixed(1) : 0;
    
    s2.addShape(pptx.ShapeType.rect, { x: 5.8, y: 1.2, w: 3.7, h: 3.5, fill: "F8F9F9", line: {color: colors.border, width: 1} });
    s2.addText("DOTATION GLOBALE", { x: 5.8, y: 1.4, w: 3.7, fontSize: 12, bold: true, color: colors.primary, align: 'center' });
    s2.addText(`${dhgTotale.toFixed(1)} h`, { x: 5.8, y: 1.8, w: 3.7, fontSize: 32, bold: true, color: colors.primary, align: 'center' });
    s2.addShape(pptx.ShapeType.rect, { x: 6, y: 2.8, w: 3.3, h: 0.6, fill: colors.secondary });
    s2.addText(`Heures Postes : ${hp.toFixed(1)}`, { x: 6, y: 2.8, w: 3.3, h: 0.6, fontSize: 11, color: colors.white, bold: true, align: 'center' });
    s2.addShape(pptx.ShapeType.rect, { x: 6, y: 3.6, w: 3.3, h: 0.6, fill: colors.accent });
    s2.addText(`H.S.A. : ${hsa.toFixed(1)}`, { x: 6, y: 3.6, w: 3.3, h: 0.6, fontSize: 11, color: colors.white, bold: true, align: 'center' });
    s2.addText(`(Taux HSA : ${percentHSA} %)`, { x: 5.8, y: 4.4, w: 3.7, fontSize: 9, color: "7F8C8D", align: 'center', italic:true });
    
    addFooter(s2, "Structure pr√©visionnelle");

    // --- 2. D√âTAIL EDS (Lyc√©e uniquement - Reste inchang√©) ---
    const levelsEDS = [{ key: 'premiere', label: 'PREMI√àRE' }, { key: 'terminale', label: 'TERMINALE' }];
    levelsEDS.forEach(lvl => {
        if (DATA.eds && DATA.eds[lvl.key] && DATA.eds[lvl.key].length > 0) {
            const chunks = chunkArray(DATA.eds[lvl.key], 8);
            chunks.forEach((chunk, idx) => {
                let sEds = pptx.addSlide();
                sEds.addText(`2. D√©tail Sp√©cialit√©s (EDS) : ${lvl.label}${chunks.length > 1 ? ` (${idx + 1}/${chunks.length})` : ""}`, { x: 0.5, y: 0.3, fontSize: 18, bold: true, color: colors.secondary });
                sEds.addShape(pptx.ShapeType.line, { x:0.5, y:0.7, w:9, h:0, line:{color:colors.secondary, width:2} });
                let edsRows = chunk.map(e => {
                    const vol = parseFloat(e.hPerGroup) || (lvl.key === 'premiere' ? 4 : 6);
                    return [{ text: e.name, options: { align: 'left', bold: true, border: stdBorder } }, { text: e.students.toString(), options: { border: stdBorder } }, { text: e.groups.toString(), options: { border: stdBorder } }, { text: vol.toFixed(1) + " h", options: { border: stdBorder } }, { text: (e.groups * vol).toFixed(1) + " h", options: { bold: true, fill: "EBF5FB", border: stdBorder } }];
                });
                sEds.addTable([[{ text: "Sp√©cialit√©", options: { ...headerStyles, w: 3.5 } }, { text: "√âl√®ves", options: { ...headerStyles, w: 1.0 } }, { text: "Gr.", options: { ...headerStyles, w: 1.0 } }, { text: "H/Gr.", options: { ...headerStyles, w: 1.0 } }, { text: "Total utilis√©", options: { ...headerStyles, w: 1.5, fill: colors.primary } }], ...edsRows], { x: 0.5, y: 1.0, w: 9, fontSize: 11, valign: 'middle', align: 'center' });
                addFooter(sEds, `D√©tail EDS ${lvl.label}`);
            });
        }
    });

    // --- 3. GRILLES HORAIRES PAR NIVEAU (EDS EXCLUS) ---
    const LIMIT_GRID = 11;
    DATA.structure.forEach(lvl => {
        let allGridRows = [];
        DATA.subjects.forEach(s => {
            const meta = DATA.subjectMeta[s];
            if (meta.isEds) return; // CORRECTIF : On saute les sp√©cialit√©s individuelles
            
            let base = 0, marge = 0, coef = 1, display = false, labelHoraire = "";
            if(meta.mode === 'div' && meta.levels && meta.levels.includes(lvl.level)) {
                const cfg = DATA.levelConfig[lvl.level][s];
                if(cfg && (cfg.base > 0 || cfg.marge > 0)) {
                    base = cfg.base; marge = cfg.marge; coef = cfg.coef || 1;
                    labelHoraire = base.toFixed(1) + " h"; display = true;
                }
            } else if(meta.mode === 'level') {
                const vol = meta.volLevel ? parseFloat(meta.volLevel[lvl.level] || 0) : 0;
                if(vol > 0) { labelHoraire = "(Forfait)"; base = vol; display = true; }
            }
            if(display) {
                allGridRows.push([{ text: s, options: { align: 'left', bold: true } }, labelHoraire, marge > 0 ? marge.toFixed(1) + " h" : "-", { text: ((base + marge) * coef).toFixed(1) + " h", options: { bold: true, fill: "EAF2F8", color: colors.primary } }]);
            }
        });
        if(allGridRows.length > 0) {
            const chunks = chunkArray(allGridRows, LIMIT_GRID);
            chunks.forEach((chunk, idx) => {
                let sLvl = pptx.addSlide();
                sLvl.addText(`3. Grille Horaire : Niveau ${lvl.level}${chunks.length > 1 ? ` (${idx+1}/${chunks.length})` : ""}`, { x: 0.5, y: 0.3, fontSize: 18, bold: true, color: colors.primary });
                sLvl.addShape(pptx.ShapeType.line, { x:0.5, y:0.5, w:9, h:0, line:{color:colors.secondary, width:2} });
                sLvl.addTable([[{ text: "Discipline", options: { ...headerStyles, fill: colors.primary, w: 3.5 } }, { text: "Horaire √âl√®ve", options: { ...headerStyles, fill: colors.secondary, w: 2.0 } }, { text: "Autonomie", options: { ...headerStyles, fill: colors.accent, w: 2.0 } }, { text: "Total Prof", options: { ...headerStyles, fill: colors.tableHeader, w: 2.0 } }], ...chunk], { x: 0.25, y: 0.65, w: 9.5, fontSize: 10, rowH: 0.35, border: stdBorder, align: 'center', valign: 'middle' });
                addFooter(sLvl, `Grille ${lvl.level}`);
            });
        }
    });

    // --- 4. SYNTH√àSE GLOBALE ---
    const LIMIT_GLOBAL = 14; 
    let colW = (9.5 - 2.5) / (DATA.structure.length + 1);
    let globHeaders = [{ text: "Discipline", options: { ...headerStyles, fill: colors.primary, w: 2.5 } }];
    DATA.structure.forEach(l => globHeaders.push({ text: l.level, options: { ...headerStyles, fill: colors.secondary, w: colW } }));
    globHeaders.push({ text: "TOT", options: { ...headerStyles, fill: colors.tableHeader, w: colW } });

    let allGlobRows = [];
    DATA.subjects.forEach(s => {
        let rowData = [], grandTotal = 0, visible = false;
        rowData.push({ text: s, options: { align: 'left', bold: true, fill: "F2F3F4", fontSize: 8 } });
        DATA.structure.forEach(lvl => {
            let h = 0; const meta = DATA.subjectMeta[s];
            if(meta.mode === 'div') { const cfg = DATA.levelConfig[lvl.level][s]; if(cfg) h = ((cfg.base||0) + (cfg.marge||0)) * (cfg.coef||1) * lvl.div; }
            else if(meta.mode === 'level') { h = meta.volLevel ? parseFloat(meta.volLevel[lvl.level] || 0) : 0; }
            if(h > 0) visible = true; grandTotal += h; rowData.push({ text: h > 0 ? h.toFixed(1) : "-", options: { fontSize: 8, color: h>0?colors.black:"CCCCCC" } });
        });
        if(DATA.subjectMeta[s].mode === 'etab') { grandTotal += parseFloat(DATA.subjectMeta[s].etab || 0); visible = true; }
        rowData.push({ text: grandTotal.toFixed(1), options: { bold: true, fill: "EAFAF1", color: colors.success, fontSize: 8 } });
        if(visible) allGlobRows.push(rowData);
    });
    chunkArray(allGlobRows, LIMIT_GLOBAL).forEach((chunk, idx) => {
        let sGlobal = pptx.addSlide();
        sGlobal.addText(`4. Synth√®se Globale${allGlobRows.length > LIMIT_GLOBAL ? ` (${idx+1})` : ""}`, { x: 0.5, y: 0.3, fontSize: 18, bold: true, color: colors.primary });
        sGlobal.addShape(pptx.ShapeType.line, { x:0.5, y:0.6, w:9, h:0, line:{color:colors.tableHeader, width:2} });
        sGlobal.addTable([globHeaders, ...chunk], { x: 0.25, y: 0.75, w: 9.5, rowH: 0.3, border: { pt: 0.25, color: "CCCCCC" }, align: 'center', valign: 'middle' });
        addFooter(sGlobal, "Vue d'ensemble");
    });

    // --- 5. BILAN PAR P√îLES ---
    const LIMIT_BILAN = 11; 
    let recapRows = []; const needs = calculateNeeds(); let res = {}; let autoComments = {};
    DATA.subjects.forEach(s => { res[s] = { cost:0 }; autoComments[s] = []; });
    DATA.teachers.forEach(p => {
        if (!p.subject) return; if (!res[p.subject]) res[p.subject] = { cost:0 };
        res[p.subject].cost += (p.ors - (p.csd||0) - (p.dech_ext||0)) + p.hsa;
        if (p.bmp > 0) autoComments[p.subject].push(`BMP ${p.bmp}h`);
        if (p.csd > 0) autoComments[p.subject].push(`CSD ${p.name}`);
    });
    const roots = DATA.subjects.filter(s => !DATA.subjectMeta[s]?.parent).sort();
    roots.forEach(r => {
        const kids = DATA.subjects.filter(s => DATA.subjectMeta[s]?.parent === r);
        const makeRow = (label, subjName, isHeader, isChild) => {
            const bes = needs[subjName] || 0, app = res[subjName] ? res[subjName].cost : 0, ecart = app - bes, manComm = (DATA.recapComments && DATA.recapComments[subjName]) ? DATA.recapComments[subjName] : "", autComm = autoComments[subjName] ? autoComments[subjName].join(", ") : "";
            let fullComm = (autComm && manComm) ? `${autComm} / ${manComm}` : (autComm || manComm);
            if(isHeader) return [{ text: label, options: { fill: colors.poleHeader, color: colors.white, bold: true, align: 'left' } }, { text: bes.toFixed(1), options: { fill: colors.poleHeader, color: colors.white, bold: true } }, { text: app.toFixed(1), options: { fill: colors.poleHeader, color: colors.white, bold: true } }, { text: ecart.toFixed(1), options: { fill: colors.poleHeader, color: ecart>=0?colors.success:"#E57373", bold: true } }, { text: "", options: { fill: colors.poleHeader } }];
            else return [{ text: isChild ? "    " + label : label, options: { align: 'left' } }, bes.toFixed(1), app.toFixed(1), { text: ecart.toFixed(1), options: { color: ecart>=0 ? colors.success : colors.danger, bold: true } }, { text: fullComm, options: { align: 'left', italic: true, fontSize: 8 } }];
        };
        if (kids.length > 0) {
            let poleBes = 0, poleApp = 0, kidsRows = [];
            if((needs[r] || 0) > 0 || (res[r] && res[r].cost > 0)) { poleBes += needs[r] || 0; poleApp += (res[r]?.cost || 0); kidsRows.push(makeRow(r, r, false, true)); }
            kids.forEach(k => { if((needs[k] || 0) > 0 || (res[k] && res[k].cost > 0)) { poleBes += needs[k] || 0; poleApp += (res[k]?.cost || 0); kidsRows.push(makeRow(k, k, false, true)); }});
            if(poleApp > 0 || poleBes > 0) {
                let ecartPole = poleApp - poleBes; recapRows.push(makeRow(`P√îLE ${r.toUpperCase()}`, r, true, false)); 
                recapRows[recapRows.length-1][1].text = poleBes.toFixed(1); recapRows[recapRows.length-1][2].text = poleApp.toFixed(1); recapRows[recapRows.length-1][3].text = ecartPole.toFixed(1); recapRows[recapRows.length-1][3].options.color = ecartPole>=0?"#81C784":"#E57373";
                recapRows.push(...kidsRows);
            }
        } else if((needs[r] || 0) > 0 || (res[r] && res[r].cost > 0)) recapRows.push(makeRow(r, r, false, false));
    });
    chunkArray(recapRows, LIMIT_BILAN).forEach((chunk, idx) => {
        let sBilan = pptx.addSlide();
        sBilan.addText(`5. Bilan & Commentaires${recapRows.length > LIMIT_BILAN ? ` (${idx+1})` : ""}`, { x: 0.5, y: 0.3, fontSize: 18, bold: true, color: colors.primary });
        sBilan.addShape(pptx.ShapeType.line, { x:0.5, y:0.6, w:9, h:0, line:{color:colors.danger, width:2} });
        sBilan.addTable([[{ text: "Discipline", options: { ...headerStyles, fill: colors.primary, w: 2.5 } }, { text: "Besoin", options: { ...headerStyles, fill: colors.danger, color: colors.black, w: 1.0 } }, { text: "Apport", options: { ...headerStyles, fill: colors.success, w: 1.0 } }, { text: "√âcart", options: { ...headerStyles, fill: "95A5A6", w: 1.0 } }, { text: "Commentaires", options: { ...headerStyles, fill: colors.secondary, w: 4.0 } }], ...chunk], { x: 0.25, y: 0.75, w: 9.5, fontSize: 10, rowH: 0.35, border: stdBorder, align: 'center', valign: 'middle' });
        addFooter(sBilan, "Bilan disciplinaire");
    });

    // --- 6. VOTE & RH ---
    let sVote = pptx.addSlide();
    sVote.addText("6. Synth√®se & Vote", { x: 0.5, y: 0.3, fontSize: 18, bold: true, color: colors.primary });
    sVote.addShape(pptx.ShapeType.line, { x:0.5, y:0.6, w:9, h:0, line:{color:colors.primary, width:2} });
    sVote.addShape(pptx.ShapeType.rect, { x: 0.5, y: 0.8, w: 9, h: 3.2, fill: "FFF8E1", line: {color: colors.accent, dashType:'dash'} });
    sVote.addText("INFORMATIONS RH (Postes & BMP)", { x: 0.7, y: 1.0, fontSize: 11, bold: true, color: colors.accent });
    let rhTxt = [];
    DATA.teachers.forEach(t => {
        if(t.bmp > 0) rhTxt.push(`‚Ä¢ ${t.subject} : BMP ${t.bmp}h`);
        if(t.csd > 0) rhTxt.push(`‚Ä¢ ${t.subject} : CSD ${t.csd}h (${t.name})`);
    });
    if(rhTxt.length > 0) {
        let half = Math.ceil(rhTxt.length/2);
        sVote.addText(rhTxt.slice(0, half).join("\n"), { x: 0.7, y: 1.3, w: 4, h: 2.5, fontSize: 10, valign:'top' });
        sVote.addText(rhTxt.slice(half).join("\n"), { x: 5.0, y: 1.3, w: 4, h: 2.5, fontSize: 10, valign:'top' });
    } else sVote.addText("Aucun moyen provisoire signal√©.", { x: 0.7, y: 1.4, fontSize: 10, italic: true });
    
    let yVote = 4.3; let hVote = 0.8;
    sVote.addShape(pptx.ShapeType.rect, { x: 0.5, y: yVote, w: 9, h: hVote, fill: colors.primary });
    sVote.addText("VOTE CA", { x: 0.7, y: yVote, w: 2, h: hVote, fontSize: 16, bold: true, color: colors.white, valign:'middle' });
    let boxY = yVote + 0.15; let boxH = 0.5;
    sVote.addShape(pptx.ShapeType.rect, { x: 3.0, y: boxY, w: 1.8, h: boxH, fill: colors.white });
    sVote.addText("POUR", { x: 3.0, y: boxY, w: 1.8, h: boxH, fontSize: 10, align:'center', valign:'middle' });
    sVote.addShape(pptx.ShapeType.rect, { x: 5.1, y: boxY, w: 1.8, h: boxH, fill: colors.white });
    sVote.addText("CONTRE", { x: 5.1, y: boxY, w: 1.8, h: boxH, fontSize: 10, align:'center', valign:'middle' });
    sVote.addShape(pptx.ShapeType.rect, { x: 7.2, y: boxY, w: 1.8, h: boxH, fill: colors.white });
    sVote.addText("ABST.", { x: 7.2, y: boxY, w: 1.8, h: boxH, fontSize: 10, align:'center', valign:'middle' });
    addFooter(sVote, "S√©ance du ........................");

    pptx.writeFile({ fileName: `DHG_CA_${DATA.config.year}.pptx` });
}
let currentEdsLevel = ''; // Pour savoir si on est en 1ere ou Term
let tempSelectedEds = new Set();

const EDS_REFERENTIEL = [
    // --- ENSEIGNEMENTS DE SP√âCIALIT√â G√âN√âRAUX ---
    { name: "Math√©matiques", cat: "Gen" },
    { name: "Physique-Chimie", cat: "Gen" },
    { name: "SVT", cat: "Gen" },
    { name: "HGGSP", cat: "Gen" },
    { name: "SES", cat: "Gen" },
    { name: "HLP", cat: "Gen" },
    { name: "LLCE Anglais", cat: "Gen" },
    { name: "LLCE Espagnol", cat: "Gen" },
    { name: "LLCE Allemand", cat: "Gen" },
    { name: "LLCE Italien", cat: "Gen" },
    { name: "NSI", cat: "Gen" },
    { name: "SI (Sciences de l'Ing√©nieur)", cat: "Gen" },
    { name: "AMC (Anglais Monde Contemp.)", cat: "Gen" },
    { name: "EPPCS (Sport)", cat: "Gen" },
    
    // --- P√îLE ARTS (Ind√©pendants) ---
    { name: "Sp√© Arts Plastiques (Arts)", cat: "Gen" },
    { name: "Sp√© Musique (Arts)", cat: "Gen" },
    { name: "Sp√© Th√©√¢tre (Arts)", cat: "Gen" },
    { name: "Sp√© Cin√©ma-Audiovisuel (Arts)", cat: "Gen" },
    { name: "Sp√© Danse (Arts)", cat: "Gen" },
    { name: "Sp√© Histoire des Arts (Arts)", cat: "Gen" },
    { name: "Sp√© Arts du Cirque (Arts)", cat: "Gen" },

    // --- FILI√àRE STI2D : PREMI√àRE ---
    { name: "STI2D - Innovation Technologique (IT)", cat: "Tech" },
    { name: "STI2D - Ing√©nierie et d√©v. durable (I2D)", cat: "Tech" },
    { name: "STI2D - Phys.-Chimie et Maths (PCM)", cat: "Tech" },

    // --- FILI√àRE STI2D : TERMINALE ---
    { name: "Physique-Chimie et Math√©matiques (STI2D)", cat: "Tech" },
    { name: "2I2D - Arch. et Construction (AC)", cat: "Tech" },
    { name: "2I2D - √ânergie et Environnement (EE)", cat: "Tech" },
    { name: "2I2D - Innovation Tech. et √âco-conception (ITEC)", cat: "Tech" },
    { name: "2I2D - Syst√®mes d'Info. et Num√©rique (SIN)", cat: "Tech" },

    // --- FILI√àRE STMG ---
    { name: "STMG - Gestion et Finance", cat: "Tech" },
    { name: "STMG - Mercatique (Marketing)", cat: "Tech" },
    { name: "STMG - Ressources Humaines et Comm.", cat: "Tech" },
    { name: "STMG - Syst√®mes d'Information de Gestion", cat: "Tech" },

    // --- AUTRES FILI√àRES TECHNO ---
    { name: "ST2S - Sciences et tech. sanitaires et sociales", cat: "Tech" },
    { name: "ST2S - Biologie et physiopathologie humaines", cat: "Tech" },
    { name: "STL - Biotechnologies", cat: "Tech" },
    { name: "STL - Sciences phys. et chim. en labo", cat: "Tech" },
    { name: "STD2A - Analyse et m√©thodes en design", cat: "Tech" },
    { name: "STD2A - Conception et cr√©ation en design", cat: "Tech" },
    { name: "STHR - H√¥tellerie et Restauration", cat: "Tech" },
    { name: "STAV - Am√©nagement / Production / Transformation", cat: "Tech" },
    { name: "S2TMD - Musique / Danse / Th√©√¢tre", cat: "Tech" }
];

function addEDS(level) {
    // S√©curit√© : on s'assure que la structure existe au moment du clic
    if (!DATA.eds) DATA.eds = { premiere: [], terminale: [] };
    if (!DATA.eds[level]) DATA.eds[level] = [];

    currentEdsLevel = level;
    tempSelectedEds.clear();
    
    const container = document.getElementById('eds-tiles-container');
    const title = document.getElementById('eds-selector-title');
    
    if (!container || !title) return;

    title.innerText = `Choisir les EDS : ${level === 'premiere' ? 'Premi√®re' : 'Terminale'}`;
    container.innerHTML = '';

    const existing = DATA.eds[level].map(e => e.name || "");

    // G√©n√©ration des tuiles avec FILTRAGE CORRIG√â
    EDS_REFERENTIEL.forEach(eds => {
        // --- LOGIQUE DE FILTRAGE STI2D / 2I2D ---
        
        // 1. En Premi√®re : On cache les sp√©s de Terminale (celles commen√ßant par 2I2D ou contenant (STI2D))
        if (level === 'premiere' && (eds.name.startsWith("2I2D") || eds.name.includes("(STI2D)"))) {
            return;
        }
        
        // 2. En Terminale : On cache les 3 sp√©s obligatoires de Premi√®re (celles commen√ßant par STI2D -)
        if (level === 'terminale' && eds.name.startsWith("STI2D - ")) {
            return;
        }

        // Affichage si pas d√©j√† s√©lectionn√©
        if (!existing.includes(eds.name)) {
            const tile = document.createElement('div');
            tile.className = 'eds-tile';
            tile.innerText = eds.name;
            tile.onclick = () => {
                tile.classList.toggle('selected');
                if(tile.classList.contains('selected')) tempSelectedEds.add(eds.name);
                else tempSelectedEds.delete(eds.name);
            };
            container.appendChild(tile);
        }
    });

    const overlay = document.getElementById('eds-selector-overlay');
    if (overlay) {
        overlay.style.display = 'flex';
        document.getElementById('btn-validate-eds').onclick = confirmEdsSelection;
    }
}

function confirmEdsSelection() {
    tempSelectedEds.forEach(name => {
        // 1. Ajout dans la liste de gestion des EDS (Tableau du bas)
        if (!DATA.eds[currentEdsLevel].some(e => e.name === name)) {
            DATA.eds[currentEdsLevel].push({ 
                name: name, 
                students: 0, 
                groups: 0, 
                hPerGroup: (currentEdsLevel === 'premiere' ? 4 : 6) 
            });
        }

        // 2. Gestion de la Mati√®re (Tableau principal)
        if (!DATA.subjects.includes(name)) {
            // Cas A : La mati√®re n'existe pas, on la cr√©e proprement
            DATA.subjects.push(name);
            DATA.subjectMeta[name] = { 
                mode: 'level', 
                levels: [currentEdsLevel === 'premiere' ? '1√®re' : 'Terminale'],
                etab: 0, 
                volLevel: {}, 
                parent: "Sp√©cialit√©s",
                code: "EDS",
                isEds: true // C'est ce flag qui cache la colonne
            };
        } else {
            // Cas B : La mati√®re EXISTE D√âJ√Ä (Saisie manuelle avant)
            // ==> ON FORCE LA CONVERSION EN EDS
            if (!DATA.subjectMeta[name]) DATA.subjectMeta[name] = {};
            
            DATA.subjectMeta[name].isEds = true; // On force le masquage de la colonne
            DATA.subjectMeta[name].mode = 'level'; // On force le mode "Niveau"
            DATA.subjectMeta[name].parent = "Sp√©cialit√©s"; // On la range dans le bon p√¥le
            
            // On s'assure que le niveau actuel est bien activ√© pour cette mati√®re
            const lvlLabel = currentEdsLevel === 'premiere' ? '1√®re' : 'Terminale';
            if (!DATA.subjectMeta[name].levels) DATA.subjectMeta[name].levels = [];
            if (!DATA.subjectMeta[name].levels.includes(lvlLabel)) {
                DATA.subjectMeta[name].levels.push(lvlLabel);
            }
        }
    });
    
    saveData();
    syncEdsToVentilation(); // Synchronise les heures
    renderEDS();
    closeEdsSelector();
    
    // Rafra√Æchit les √©crans pour faire dispara√Ætre instantan√©ment la colonne en trop
    if(typeof renderSubjectsConfig === 'function') renderSubjectsConfig();
    if(typeof renderGridSystem === 'function') renderGridSystem();
}

function closeEdsSelector() {
    document.getElementById('eds-selector-overlay').style.display = 'none';
}

function renderEDS() {
    const levels = ['premiere', 'terminale'];
    let globalTotal = 0;

    levels.forEach(lvl => {
        const tbody = document.getElementById(`eds-full-${lvl === 'premiere' ? '1ere' : 'term'}`);
        if(!tbody) return;
        tbody.innerHTML = '';
        let levelTotal = 0;

        // 1. Filtrage et Tri Alphab√©tique
        const genItems = DATA.eds[lvl]
            .filter(e => {
                const ref = EDS_REFERENTIEL.find(r => r.name === e.name);
                return !ref || ref.cat === 'Gen';
            })
            .sort((a, b) => a.name.localeCompare(b.name)); // Tri alphab√©tique

        const techItems = DATA.eds[lvl]
            .filter(e => {
                const ref = EDS_REFERENTIEL.find(r => r.name === e.name);
                return ref && ref.cat !== 'Gen';
            })
            .sort((a, b) => a.name.localeCompare(b.name)); // Tri alphab√©tique

        const renderItems = (items, label) => {
            if(items.length === 0) return;
            tbody.innerHTML += `<tr><td colspan="7" class="eds-cat-header">${label}</td></tr>`;
            
            items.forEach(item => {
                const globalIdx = DATA.eds[lvl].indexOf(item);
                if(item.hPerGroup === undefined) item.hPerGroup = (lvl === 'premiere' ? 4 : 6);
                
                const ratioE_G = item.groups > 0 ? (item.students / item.groups).toFixed(1) : 0;
                const totalHours = item.groups * item.hPerGroup;
                levelTotal += totalHours;

                const costPerStudent = item.students > 0 ? (totalHours / item.students).toFixed(3) : 0;
                const ratioClass = ratioE_G > 35 ? 'text-danger' : (ratioE_G < 15 ? 'text-warning' : 'text-success');

                tbody.innerHTML += `
                    <tr>
                        <td style="text-align:left; font-weight:bold; font-size:0.9rem;">
                            <span class="badge-cat">${label.includes('G√âN') ? 'GEN' : 'TECH'}</span>${item.name}
                        </td>
                        <td><input type="number" value="${item.students}" class="input-inline-eds" onchange="updEDS('${lvl}', ${globalIdx}, 'students', this.value)"></td>
                        <td><input type="number" value="${item.groups}" class="input-inline-eds" style="border-color:var(--secondary)" onchange="updEDS('${lvl}', ${globalIdx}, 'groups', this.value)"></td>
                        <td><input type="number" value="${item.hPerGroup}" class="input-inline-eds" style="border-color:var(--accent)" onchange="updEDS('${lvl}', ${globalIdx}, 'hPerGroup', this.value)"></td>
                        <td class="${ratioClass}" style="font-weight:bold; font-size:1.1rem;">${ratioE_G}</td>
                        <td><span class="cost-badge">${costPerStudent} h/√©l.</span></td>
                        <td><button onclick="delEDS('${lvl}', ${globalIdx})" style="border:none; background:none; color:#c0392b; cursor:pointer; font-size:1.2rem;">√ó</button></td>
                    </tr>
                `;
            });
        };

        renderItems(genItems, "EDS G√âN√âRAUX");
        renderItems(techItems, "EDS TECHNOLOGIQUES");

        document.getElementById(`total-eds-${lvl === 'premiere' ? '1ere' : 'term'}`).innerText = levelTotal.toFixed(1);
        globalTotal += levelTotal;
    });

    if(document.getElementById('total-eds-global')) 
        document.getElementById('total-eds-global').innerText = globalTotal.toFixed(1) + " h";
}

// FONCTION DE BASCULEMENT (Transfert)
function transferEDS(from, to) {
    if(DATA.eds[from].length === 0) return alert("Rien √† transf√©rer !");
    if(!confirm(`Voulez-vous copier la structure des EDS de ${from} vers ${to} ?\n(Les effectifs seront remis √† 0, mais les groupes et noms seront conserv√©s)`)) return;

    DATA.eds[from].forEach(source => {
        // On v√©rifie si l'EDS n'existe pas d√©j√† dans la cible
        if(!DATA.eds[to].some(e => e.name === source.name)) {
            DATA.eds[to].push({
                name: source.name,
                students: 0,
                groups: source.groups,
                hPerGroup: (to === 'terminale' ? 6 : 4) // Ajustement automatique du volume
            });
        }
    });
    saveData();
    renderEDS();
    alert("‚úÖ Structure transf√©r√©e ! Pensez √† ajuster les effectifs et les volumes horaires.");
}

function updEDS(lvl, idx, field, val) {
    DATA.eds[lvl][idx][field] = parseFloat(val) || 0;
    
    // Synchroniser les volumes vers la ventilation
    syncEdsToVentilation();
    
    saveData();
    renderEDS();
    calculateRecap();
}

function delEDS(lvl, idx) {
    if(confirm("Supprimer cet enseignement de sp√©cialit√© ?")) {
        // On retire l'√©l√©ment du tableau correspondant (1ere ou Term)
        DATA.eds[lvl].splice(idx, 1);
        
        // Sauvegarde et mise √† jour de l'interface
        saveData();
        renderEDS();
        
        // On met √† jour le bilan global pour refl√©ter la suppression des heures
        calculateRecap();
    }
}

function syncEdsToVentilation() {
    const levels = ['premiere', 'terminale'];
    levels.forEach(lvlKey => {
        const realLevelName = DATA.structure.find(l => 
            lvlKey === 'premiere' ? (l.level.includes("1") || l.level.includes("Prem")) : (l.level.includes("Term") || l.level.includes("Tle"))
        )?.level;

        if (realLevelName && DATA.eds[lvlKey]) {
            DATA.eds[lvlKey].forEach(eds => {
                const totalHours = (eds.groups || 0) * (eds.hPerGroup || (lvlKey === 'premiere' ? 4 : 6));
                if (DATA.subjectMeta[eds.name]) {
                    if (!DATA.subjectMeta[eds.name].volLevel) DATA.subjectMeta[eds.name].volLevel = {};
                    DATA.subjectMeta[eds.name].volLevel[realLevelName] = totalHours;
                }
            });
        }
    });
}
// Changez 'profs' par 'matieres'
let currentRepartitionView = 'matieres'; 

function switchRepartitionView(view) {
    currentRepartitionView = view;
    // Mise √† jour visuelle des boutons
    document.getElementById('btn-view-repart-prof').classList.toggle('active', view === 'profs');
    document.getElementById('btn-view-repart-mat').classList.toggle('active', view === 'matieres');
    renderRepartition();
}

function renderRepartition() {
    const container = document.getElementById('repartition-content');
    if (!container) return;
    container.innerHTML = '';

    if (currentRepartitionView === 'profs') {
        renderRepartitionProfs(container);
    } else {
        renderRepartitionMatieres(container);
    }
}
// --- VUE PAR ENSEIGNANT (CORRIG√âE V7 : D√©doublonnage Strict Classes vs Niveau) ---
function renderRepartitionProfs(container) {
    // 1. Regroupement par Enseignant
    const consolidated = {};

    DATA.teachers.forEach((t, idx) => {
        const cleanName = t.name.trim();
        if(!consolidated[cleanName]) {
            consolidated[cleanName] = { name: cleanName, indices: [], data: [] };
        }
        consolidated[cleanName].indices.push(idx);
        consolidated[cleanName].data.push(t);
    });

    // 2. G√©n√©ration de l'affichage
    Object.values(consolidated)
        .sort((a, b) => a.name.localeCompare(b.name))
        .forEach(group => {
            let totalServiceFait = 0;
            let totalDu = 0;
            let rows = [];

            // A. Mati√®re principale
            let mainSub = group.data[0].subject;
            group.data.forEach(t => {
                const meta = DATA.subjectMeta[t.subject];
                const metaMain = DATA.subjectMeta[mainSub];
                if(DATA.subjects.some(s => DATA.subjectMeta[s]?.parent === t.subject)) mainSub = t.subject;
                if(metaMain?.parent === t.subject) mainSub = t.subject;
            });

            // B. Parcours des lignes RH
            group.data.forEach((t, i) => {
                const realIdx = group.indices[i];
                const csd = parseFloat(t.csd || 0);
                const dech = (parseFloat(t.decharge || 0) + parseFloat(t.dech_ext || 0));
                totalDu += (t.ors - csd);

                // --- SET ANTI-DOUBLON ---
                let levelsPaid = new Set();

                // C. R√©cup√©ration et TRI des affectations
                // On veut traiter les colonnes "Niveau" (ex: 4√®me) AVANT les classes (ex: 4A)
                const relevantKeys = Object.keys(DATA.assignments).filter(key => {
                    return parseInt(key.split('_')[1]) === realIdx;
                });

                const sortedKeys = relevantKeys.sort((a, b) => {
                    const idA = a.split('_')[0];
                    const idB = b.split('_')[0];
                    // Est-ce une colonne Niveau ? (Exact match dans structure)
                    const isLvlA = DATA.structure.some(l => l.level === idA) || idA === 'ETAB';
                    const isLvlB = DATA.structure.some(l => l.level === idB) || idB === 'ETAB';
                    return isLvlB - isLvlA; // True (1) avant False (0)
                });

                sortedKeys.forEach(key => {
                    const parts = key.split('_');
                    const assign = DATA.assignments[key];
                    const entityId = parts.slice(0, parts.length - 1).join('_'); // ex: "4A" ou "4√®me"
                    const meta = DATA.subjectMeta[t.subject];
                    
                    // 1. Identification du Niveau Parent (CRUCIAL)
                    let parentLevelName = null;
                    
                    // Cas 1: C'est une colonne niveau (ex: entityId = "4√®me")
                    const structLvlExact = DATA.structure.find(l => l.level === entityId);
                    if (structLvlExact) {
                        parentLevelName = structLvlExact.level;
                    } 
                    // Cas 2: C'est une classe (ex: entityId = "4A"), on cherche son parent
                    else {
                        const structLvlPrefix = DATA.structure.find(l => entityId.startsWith(getLevelPrefix(l.level)));
                        if (structLvlPrefix) parentLevelName = structLvlPrefix.level;
                    }

                    // 2. Calcul des heures
                    let h = 0;
                    if(assign.quota !== undefined && assign.quota !== null) {
                        h = parseFloat(assign.quota);
                    } else {
                        // Fallback
                        if(parentLevelName) h = getHoursForClassSubject(entityId, parentLevelName, t.subject);
                    }

                    if(h > 0) {
                        let label = DATA.classNames[entityId] || entityId;
                        let typeBadge = "Cl.";
                        if (entityId === 'ETAB') { label = "Forfait Global"; typeBadge = "Etab"; }
                        else if (structLvlExact) { typeBadge = "Niv"; }

                        // --- LOGIQUE DE D√âDOUBLONNAGE ---
                        let effectiveHours = h;
                        let isIncluded = false;

                        // Si la mati√®re est en mode "Forfait Niveau" (ex: LCE, Chorale)
                        if (meta && meta.mode === 'level' && parentLevelName) {
                            
                            // Si ce niveau a d√©j√† √©t√© pay√© pour ce prof sur cette mati√®re
                            if (levelsPaid.has(parentLevelName)) {
                                effectiveHours = 0;
                                isIncluded = true;
                            } else {
                                // Premier passage (gr√¢ce au tri, c'est souvent la colonne Niveau)
                                levelsPaid.add(parentLevelName);
                                effectiveHours = h;
                            }
                        }
                        // --------------------------------

                        totalServiceFait += effectiveHours;

                        // Cosm√©tique
                        if(typeBadge === "Cl." && assign.mode === 'GROUP') typeBadge = "Ptg";
                        const labelSub = (t.subject !== mainSub) ? `<br><small style="color:#e67e22; font-weight:bold;">${t.subject}</small>` : '';
                        
                        let displayHours = effectiveHours > 0 ? h.toFixed(1) + "h" : `<span style="color:#bdc3c7; font-size:0.8rem;">(Incl.)</span>`;
                        let styleCell = "";
                        
                        if (isIncluded) styleCell = "background:#f4f6f6; color:#95a5a6; border:1px dashed #bdc3c7;";
                        else if (typeBadge === "Niv" || typeBadge === "Etab") styleCell = "background:#fffcf5; border-bottom:2px solid #f1c40f;";

                        rows.push({
                            isDech: false,
                            isMain: (t.subject === mainSub),
                            isIncluded: isIncluded,
                            html: `<td style="${styleCell}"><b>${label}</b>${labelSub}<br>${displayHours} <small style="color:#999;">(${typeBadge})</small></td>`
                        });
                    }
                });

                // D√©charges
                if(dech > 0) {
                    totalServiceFait += dech;
                    rows.push({ isDech: true, html: `<td style="color:#8e44ad; background:#f4ecf7;"><i>D√©charges</i><br>${dech.toFixed(1)}h</td>` });
                }
            });

            // Tri final pour l'affichage (Inclus √† la fin)
            rows.sort((a, b) => {
                if (a.isDech) return 1; if (b.isDech) return -1;
                if (a.isIncluded && !b.isIncluded) return 1;
                if (!a.isIncluded && b.isIncluded) return -1;
                return 0;
            });

            const solde = totalServiceFait - totalDu;
            const isOk = solde >= -0.1;
            const color = isOk ? '#27ae60' : '#c0392b';
            const bg = isOk ? '#e8f8f5' : '#fdedec';

            container.innerHTML += `
            <div class="card" style="border-left: 5px solid ${color}; margin-bottom: 10px; padding: 15px;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h4 style="margin:0; color:#2c3e50;">
                        ${group.name} 
                        <span style="font-weight:normal; font-size:0.9rem; color:#7f8c8d; margin-left:5px;">
                            ${mainSub} ${group.data.length > 1 ? '(+ Options)' : ''}
                        </span>
                    </h4>
                    <div style="text-align:right;">
                        <span style="font-weight:800; font-size:1.1rem; color:#2c3e50;">
                            ${totalServiceFait.toFixed(2)} <span style="font-size:0.9rem; color:#999; font-weight:normal;">/ ${totalDu.toFixed(1)} h</span>
                        </span>
                        <span style="margin-left:10px; padding:2px 8px; border-radius:4px; background:${bg}; color:${color}; font-weight:bold; font-size:0.9rem;">
                            ${solde > 0 ? '+' : ''}${solde.toFixed(2)}
                        </span>
                    </div>
                </div>
                <div style="margin-top:12px; overflow-x:auto;">
                    <table style="font-size:0.85rem; width:auto;">
                        <tr style="background:#f8f9fa; border-radius:4px;">
                            ${rows.length > 0 ? rows.map(r => r.html).join('') : '<td style="font-style:italic; color:#c0392b; padding:5px; font-weight:bold;">‚ö†Ô∏è Aucun service saisi</td>'}
                        </tr>
                    </table>
                </div>
            </div>`;
        });
}

function renderRepartitionMatieres(container) {
    container.innerHTML = '';
    
    // Correction pr√©ventive des donn√©es
    checkAndFixData();

    // On r√©cup√®re les mati√®res racines (P√¥les)
    const roots = DATA.subjects.filter(s => !DATA.subjectMeta[s]?.parent).sort();

    roots.forEach(root => {
        const subjectsInPole = [root, ...DATA.subjects.filter(s => DATA.subjectMeta[s]?.parent === root)];
        
        // Cr√©ation de la carte du P√¥le
        let poleHTML = `<div class="card" style="overflow-x:auto; margin-bottom:30px; border-top: 4px solid #455a64;">
                        <h3 style="color:#455a64; margin-bottom:20px;">üì¶ P√¥le ${root.toUpperCase()}</h3>`;

        subjectsInPole.forEach(sub => {
            const meta = DATA.subjectMeta[sub];
            if (!meta) return;
            
            // --- 1. D√âTECTION DU TYPE DE MATI√àRE (LABO ?) ---
            const isLabo = (meta.code === 'LAB' && meta.parent);

            // --- 2. R√âCUP√âRATION DES PROFS (Mise √† jour Co-intervention) ---
            let profs = [];
            
            if (isLabo) {
                // CAS LABO : On prend les profs de la mati√®re PARENTE
                profs = DATA.teachers
                    .map((t, i) => ({...t, idx: i}))
                    .filter(t => t.subject === meta.parent);
            } else {
                // CAS STANDARD : Titulaires + Invit√©s (Co-intervention)
                
                // A. Profs titulaires de la mati√®re
                const mainProfs = DATA.teachers
                    .map((t, i) => ({...t, idx: i}))
                    .filter(t => t.subject === sub);
                
                // B. Profs "invit√©s" via les disciplines associ√©es
                let guestProfs = [];
                if (meta.linkedSubjects && meta.linkedSubjects.length > 0) {
                    guestProfs = DATA.teachers
                        .map((t, i) => ({...t, idx: i}))
                        .filter(t => meta.linkedSubjects.includes(t.subject));
                }

                // C. Fusion et Tri
                profs = [...mainProfs, ...guestProfs];
                
                // D. Tri alphab√©tique pour un affichage propre
                profs.sort((a, b) => a.name.localeCompare(b.name));
            }

            // Si aucun prof concern√©, on n'affiche pas le tableau
            if (profs.length === 0 && isLabo) return;

            // --- 3. D√âFINITION DES COLONNES (Classes/Niveaux) ---
            let columns = [];
            if (meta.mode === 'div') {
                DATA.structure.forEach(lvl => {
                    const prefix = getLevelPrefix(lvl.level);
                    for (let i = 0; i < lvl.div; i++) {
                        const cId = `${prefix}${String.fromCharCode(65 + i)}`;
                        // On affiche la colonne si :
                        // 1. Le niveau est coch√© dans les param√®tres
                        // 2. OU s'il y a des heures saisies (override)
                        const isActive = (meta.levels && meta.levels.includes(lvl.level));
                        const hasHours = getHoursForClassSubject(cId, lvl.level, sub) > 0;
                        
                        if (hasHours || isActive) {
                            columns.push({ 
                                id: cId, 
                                name: DATA.classNames[cId] || cId, 
                                lvl: lvl.level, 
                                type: 'class' 
                            });
                        }
                    }
                });
            } else if (meta.mode === 'level') {
                DATA.structure.forEach(lvl => columns.push({ id: lvl.level, name: lvl.level, lvl: lvl.level, type: 'level' }));
            } else if (meta.mode === 'etab') {
                columns.push({ id: 'ETAB', name: 'Forfait Global', lvl: 'Etab', type: 'etab' });
            }

            if (columns.length === 0) return;

            // --- 4. CONSTRUCTION DU HEADER DU TABLEAU ---
            let tableHTML = `<h4 style="color:var(--secondary); margin-bottom:10px; padding-left:5px;">
                                ${sub} <small style="color:#999; font-weight:normal; font-size:0.7rem;">(${isLabo ? 'D√©charge / Heure de Vaisselle' : (meta.mode === 'div' ? 'Par Classe' : 'Forfait')})</small>
                             </h4>
                             <table style="width:100%; font-size:0.8rem; border-collapse:collapse; margin-bottom:25px;">
                             <thead>
                                <tr style="background:#455a64; color:white;">
                                    <th style="text-align:left; border:1px solid #ddd; padding:8px; width:180px;">Enseignant</th>
                                    ${columns.map(col => `<th style="border:1px solid #ddd; padding:8px;">${col.name}</th>`).join('')}
                                    <th style="border:1px solid #bdc3c7; padding:8px; width:65px; background:#d6eaf8; color:#2980b9; font-weight:bold;">Tot. Mat.</th>
                                    <th style="border:1px solid #bdc3c7; padding:8px; width:65px; background:#d5f5e3; color:#27ae60; font-weight:bold;">Tot. Serv.</th>
                                    <th style="border:1px solid #bdc3c7; padding:8px; width:65px; background:#ebdef0; color:#8e44ad; font-weight:bold;">Svc. Du</th>
                                </tr>`;
            
            // Ligne de Besoin (Masqu√©e pour les Labos car c'est du bonus enseignant)
            if (!isLabo) {
                 tableHTML += `<tr style="background:#fffbe6; font-size:0.75rem;">
                                    <td style="text-align:right; font-weight:bold; border:1px solid #ddd; padding:6px;">Besoin (h)</td>
                                    ${columns.map(col => {
                                        let val = 0;
                                        if(col.type === 'class') val = getHoursForClassSubject(col.id, col.lvl, sub);
                                        else if(col.type === 'level') val = (meta.volLevel && meta.volLevel[col.id]) || 0;
                                        else if(col.type === 'etab') val = meta.etab || 0;
                                        return `<td style="border:1px solid #ddd; padding:6px; font-weight:bold;">${val.toFixed(1)}</td>`;
                                    }).join('')}
                                    <td colspan="3" style="border:1px solid #ddd; background:#fff9c4;"></td>
                                </tr>`;
            }
            tableHTML += `</thead><tbody>`;

            // --- 5. LIGNES ENSEIGNANTS ---
            profs.forEach(p => {
                let rowTotal = 0;
                const serviceDu = p.ors - (p.csd || 0);
                const serviceGlobal = getGlobalTeacherService(p.idx);
                let glbColor = serviceGlobal >= serviceDu ? "#27ae60" : "#c0392b";

                // Affichage du nom + Discipline d'origine si diff√©rente
                let displayName = p.name;
                if (p.subject !== sub) {
                    displayName += ` <span style="font-size:0.7rem; color:#e67e22; font-weight:normal;">(${p.subject})</span>`;
                }

                tableHTML += `<tr>
                    <td style="text-align:left; font-weight:bold; border:1px solid #ddd; padding:8px; background:#fafafa;">${displayName}</td>`;
                
                // CELLULES DE SAISIE
                tableHTML += columns.map(col => {
                    let val = 0;
                    let action = "";
                    
                    if (isLabo) {
                        // CAS LABO : On lit/√©crit directement p.decharge
                        val = p.decharge || 0;
                        action = `onchange="updateDechargeFromGrid(${p.idx}, this.value, this)"`;
                    } else {
                        // CAS NORMAL : On lit/√©crit dans assignments
                        const key = `${col.id}_${p.idx}`;
                        const assign = DATA.assignments[key];
                        val = (assign && assign.quota !== undefined) ? assign.quota : 0;
                        action = `onchange="updateCoTeaching('${col.id}', ${p.idx}, this.value, this)" oninput="updateCoTeaching('${col.id}', ${p.idx}, this.value, this)"`;
                    }
                    
                    if (val > 0) rowTotal += parseFloat(val);

                    return `<td style="border:1px solid #ddd; padding:4px; background:${val > 0 ? '#e3f2fd' : 'white'};">
                                <input type="number" step="0.5" value="${val === 0 ? '' : val}" 
                                       placeholder="0"
                                       style="width:50px; text-align:center; border:1px solid ${val > 0 ? '#90caf9' : '#eee'}; font-weight:${val > 0 ? 'bold' : 'normal'};"
                                       ${action}>
                            </td>`;
                }).join('');
                    
                // Cellules Totaux de fin de ligne
                tableHTML += `<td style="border:1px solid #ddd; padding:8px; font-weight:bold; background:#e8f0fe; color:var(--primary); text-align:center;">${rowTotal.toFixed(1)}</td>
                              <td style="border:1px solid #ddd; padding:8px; font-weight:bold; color:${glbColor}; text-align:center;">${serviceGlobal.toFixed(1)}</td>
                              <td style="border:1px solid #ddd; padding:8px; font-weight:bold; background:#f4ecf7; color:#8e44ad; text-align:center;">${serviceDu.toFixed(1)}</td>
                </tr>`;
            });
            
            // --- 6. RELIQUAT (Uniquement si pas Labo) ---
            if (!isLabo) {
                tableHTML += `<tr style="background:#fdedec;">
                    <td style="text-align:right; font-style:italic; border:1px solid #ddd; padding:8px; color:#c0392b; font-weight:bold;">Reliquat</td>
                    ${columns.map(col => {
                        let assignedInCol = 0;
                        // On somme les heures assign√©es pour tous les profs affich√©s
                        profs.forEach(p => {
                             const q = DATA.assignments[`${col.id}_${p.idx}`]?.quota || 0;
                             assignedInCol += parseFloat(q);
                        });
                        
                        let besoin = 0;
                        if(col.type === 'class') besoin = getHoursForClassSubject(col.id, col.lvl, sub);
                        else if(col.type === 'level') besoin = (meta.volLevel && meta.volLevel[col.id]) || 0;
                        else if(col.type === 'etab') besoin = meta.etab || 0;

                        const diff = besoin - assignedInCol;
                        // Vert si 0, Rouge si positif (manque), Orange si n√©gatif (trop)
                        let color = Math.abs(diff) < 0.01 ? "#27ae60" : (diff > 0 ? "#c0392b" : "#e67e22");
                        let text = Math.abs(diff) < 0.01 ? 'OK' : diff.toFixed(1);

                        return `<td style="border:1px solid #ddd; padding:4px; font-weight:bold; color:${color}; text-align:center;">${text}</td>`;
                    }).join('')}
                    <td colspan="3" style="border:1px solid #ddd; background:#fdedec;"></td>
                </tr>`;
            }

            tableHTML += `</tbody></table>`;
            poleHTML += tableHTML;
        });
        
        container.innerHTML += poleHTML + `</div>`;
    });
}

/**
 * FONCTION DE CORRECTION AUTOMATIQUE DE LA STRUCTURE
 * G√®re l'UNSS et les Labos (SVT/PC uniquement)
 */
function checkAndFixData() {
    if (!DATA) return;

    // 1. Lier UNSS √† EPS
    if (DATA.subjects.includes("UNSS")) {
        if (!DATA.subjectMeta["UNSS"]) DATA.subjectMeta["UNSS"] = {};
        DATA.subjectMeta["UNSS"].parent = "EPS";
        DATA.subjectMeta["UNSS"].mode = "etab"; 
    }

    // 2. Cr√©er les mati√®res "Laboratoire" UNIQUEMENT pour SVT et Physique
    // On retire "Techno" de la liste
    const scienceSubjects = ["SVT", "Phys-Chi", "Sciences", "S. V. T.", "PHYSIQUE-CHIMIE"];
    
    scienceSubjects.forEach(sc => {
        // On cherche si la mati√®re existe
        const parentExists = DATA.subjects.find(s => s.toUpperCase() === sc.toUpperCase() && !DATA.subjectMeta[s]?.parent);
        
        if (parentExists) {
            const laboName = `Labo ${parentExists}`; // Ex: "Labo SVT"
            
            // On cr√©e le Labo seulement s'il n'existe pas
            if (!DATA.subjects.includes(laboName)) {
                DATA.subjects.push(laboName);
                DATA.subjectMeta[laboName] = {
                    mode: 'etab',       
                    parent: parentExists,
                    code: 'LAB',
                    etab: 0             
                };
            } else {
                // S'il existe, on force le mode 'etab' et le code 'LAB'
                if(DATA.subjectMeta[laboName]) {
                    DATA.subjectMeta[laboName].parent = parentExists;
                    DATA.subjectMeta[laboName].mode = 'etab';
                    DATA.subjectMeta[laboName].code = 'LAB';
                }
            }
        }
    });
    
    // Nettoyage √©ventuel : Si un "Labo Techno" tra√Æne d'une version pr√©c√©dente, on pourrait le supprimer ici,
    // mais par s√©curit√© on le laisse juste inactif ou on le supprime manuellement via le menu Mati√®res.

    saveData();
}

/**
 * Met √† jour la d√©charge d'un enseignant depuis la grille "Labo"
 */
function updateDechargeFromGrid(tIdx, val, inputElement) {
    const teacher = DATA.teachers[tIdx];
    if (teacher) {
        teacher.decharge = parseFloat(val) || 0;
        saveData();
        
        // Mise √† jour visuelle des totaux de la ligne
        if (inputElement) {
             const row = inputElement.closest('tr');
             // On met √† jour la cellule "Tot. Serv." (avant-derni√®re) et "Tot. Mat."
             // Note : Pour une d√©charge, le "Tot. Mat." est √©gal √† la d√©charge elle-m√™me
             if(row) {
                 const cells = row.cells;
                 const totMatCell = cells[cells.length - 3];
                 const totServCell = cells[cells.length - 2];
                 const svcDuCell = cells[cells.length - 1];
                 
                 // Tot. Mat = La d√©charge
                 totMatCell.innerText = teacher.decharge.toFixed(1);
                 
                 // Tot. Serv = Recalcul global
                 const newGlobal = getGlobalTeacherService(tIdx);
                 totServCell.innerText = newGlobal.toFixed(1);
                 
                 // Couleurs
                 const target = parseFloat(svcDuCell.innerText) || 0;
                 totServCell.style.color = newGlobal >= target ? "#27ae60" : "#c0392b";
             }
        }
    }
}

/**
 * CALCULE LE SERVICE R√âEL (FACE √Ä √âL√àVES) D'UN ENSEIGNANT
 * Prend en compte les heures de co-enseignement saisies manuellement
 */
function getTeacherLiveService(teacherIdx) {
    const teacher = DATA.teachers[teacherIdx];
    if (!teacher) return 0;

    let totalService = 0;
    
    // On parcourt toutes les cl√©s d'affectations (format: "ClasseID_ProfIndex")
    Object.keys(DATA.assignments).forEach(key => {
        const [cId, tIdx] = key.split('_');
        
        if (parseInt(tIdx) === teacherIdx) {
            const assign = DATA.assignments[key];
            
            // Si une r√©partition manuelle (quota) existe, on l'utilise
            if (assign.quota !== undefined && assign.quota !== null) {
                totalService += parseFloat(assign.quota);
            } else {
                // Sinon, on r√©cup√®re la valeur par d√©faut de la grille horaire
                const levelObj = DATA.structure.find(l => cId.startsWith(getLevelPrefix(l.level)));
                if (levelObj) {
                    totalService += getHoursForClassSubject(cId, levelObj.level, teacher.subject);
                }
            }
        }
    });
    return totalService;
}

function updateCoTeaching(cId, tIdx, val, inputElement) {
    const hours = parseFloat(val);
    const key = `${cId}_${tIdx}`;

    // --- 1. SAUVEGARDE (Back-End) ---
    if (isNaN(hours) || hours <= 0) {
        if (DATA.assignments[key]) delete DATA.assignments[key];
        if (inputElement) {
            inputElement.style.borderColor = '#eee';
            inputElement.style.fontWeight = 'normal';
            inputElement.parentElement.style.background = 'white';
        }
    } else {
        if (!DATA.assignments[key]) DATA.assignments[key] = { mode: 'CLASS', quota: hours, isPP: false };
        else DATA.assignments[key].quota = hours;
        
        if (inputElement) {
            inputElement.style.borderColor = '#90caf9';
            inputElement.style.fontWeight = 'bold';
            inputElement.parentElement.style.background = '#e3f2fd';
        }
    }

    // Calcul auto Groupe/Classe
    const teacher = DATA.teachers[tIdx];
    if (teacher) {
        const subject = teacher.subject;
        const assignedPeers = DATA.teachers.map((t, i) => i)
            .filter(idx => {
                const k = `${cId}_${idx}`;
                return DATA.assignments[k] && DATA.teachers[idx].subject === subject;
            });
        const newMode = assignedPeers.length > 1 ? 'GROUP' : 'CLASS';
        assignedPeers.forEach(idx => {
            const k = `${cId}_${idx}`;
            if (DATA.assignments[k]) DATA.assignments[k].mode = newMode;
        });
    }
    
    saveData();

    // --- 2. MISE √Ä JOUR VISUELLE (Front-End) ---
    if (inputElement) {
        const table = inputElement.closest('table');
        const row = inputElement.closest('tr');
        
        // A. MISE √Ä JOUR LIGNE (PROF)
        if (row) {
            const inputs = row.querySelectorAll('input[type="number"]');
            let rowTotal = 0;
            inputs.forEach(inp => rowTotal += parseFloat(inp.value) || 0);
            
            // On cible les 3 derni√®res cellules de la ligne
            const cellTotMat = row.cells[row.cells.length - 3]; // Total Mati√®re
            const cellTotGlb = row.cells[row.cells.length - 2]; // Total Global
            const cellSvcDu = row.cells[row.cells.length - 1];  // Service D√ª
            
            // 1. Mise √† jour Total Mati√®re
            cellTotMat.innerText = rowTotal.toFixed(1);
            if(rowTotal > 0) {
                cellTotMat.style.backgroundColor = '#e8f0fe';
                cellTotMat.style.color = '#2c3e50';
            } else {
                cellTotMat.style.backgroundColor = 'white';
                cellTotMat.style.color = 'black';
            }
            
            // 2. Mise √† jour Total Global
            const newGlobal = getGlobalTeacherService(tIdx); // Recalcul global instantan√©
            cellTotGlb.innerText = newGlobal.toFixed(1);
            
            // Comparaison avec le Service D√ª (qui ne change pas, lui)
            const target = parseFloat(cellSvcDu.innerText) || 0;
            cellTotGlb.style.color = newGlobal >= target ? "#27ae60" : "#c0392b";
            cellTotGlb.style.fontWeight = "bold";
        }

        // B. MISE √Ä JOUR COLONNE (RELIQUAT)
        const cell = inputElement.closest('td');
        const colIdx = cell.cellIndex;
        
        // On r√©cup√®re le besoin (ligne 2 du header, car ligne 1 = titres colonnes)
        const needCell = table.tHead.rows[1].cells[colIdx];
        const needVal = parseFloat(needCell.innerText) || 0;

        let colSum = 0;
        const bodyRows = table.tBodies[0].rows;
        // On boucle sur toutes les lignes sauf la derni√®re (le reliquat)
        for(let i=0; i < bodyRows.length - 1; i++) {
            const cellInRow = bodyRows[i].cells[colIdx];
            if(cellInRow) {
                const inputInRow = cellInRow.querySelector('input');
                if(inputInRow) colSum += parseFloat(inputInRow.value) || 0;
            }
        }

        const diff = needVal - colSum;
        const reliquatRow = table.tBodies[0].lastElementChild;
        const reliquatCell = reliquatRow.cells[colIdx];
        
        if (reliquatCell) {
            if (Math.abs(diff) < 0.01) {
                reliquatCell.innerText = "OK";
                reliquatCell.style.color = "#27ae60";
            } else {
                reliquatCell.innerText = diff.toFixed(1);
                reliquatCell.style.color = diff > 0 ? "#c0392b" : "#e67e22";
            }
        }
    }
}

/**
 * R√âCUP√àRE LE PR√âFIXE DU NIVEAU (ex: "6" pour "6√®me")
 */
function getLevelPrefix(levelName) {
    return levelName.replace(/[^0-9]/g, '') || levelName.charAt(0);
}

// Helper pour r√©cup√©rer l'horaire d'une classe (g√®re les overrides)
function getHoursForClassSubject(cId, levelName, subject) {
    const meta = DATA.subjectMeta[subject];
    if (!meta || meta.mode === 'etab') return 0;
    if (meta.mode === 'level') return (meta.volLevel && meta.volLevel[levelName]) || 0;
    
    const cfg = (DATA.classOverrides && DATA.classOverrides[cId] && DATA.classOverrides[cId][subject]) 
                ? DATA.classOverrides[cId][subject] 
                : (DATA.levelConfig[levelName] ? DATA.levelConfig[levelName][subject] : null);
    
    return cfg ? ((cfg.base || 0) + (cfg.marge || 0)) * (cfg.coef || 1) : 0;
}
/**
 * Calcule la somme de TOUTES les heures assign√©es √† un prof
 * (Toutes mati√®res et toutes classes confondues)
 */
function getGlobalTeacherService(tIdx) {
    let total = 0;
    Object.keys(DATA.assignments).forEach(key => {
        // La cl√© est sous forme "ClasseID_ProfIndex"
        // On v√©rifie si la cl√© termine par "_IndexDuProf"
        if (key.endsWith('_' + tIdx)) {
            total += parseFloat(DATA.assignments[key].quota) || 0;
        }
    });
    return total;
}

let currentSubjectForLinking = ""; // Variable globale temporaire

function openLinkedSubjectsModal(subjectName) {
    currentSubjectForLinking = subjectName;
    const container = document.getElementById('linked-subjects-list');
    const title = document.getElementById('linked-modal-target-name');
    const overlay = document.getElementById('linked-subjects-overlay');
    
    // Titre
    title.innerText = subjectName;
    container.innerHTML = '';
    
    // R√©cup√©ration des donn√©es existantes
    const m = DATA.subjectMeta[subjectName];
    const linkedList = m.linkedSubjects || [];

    // G√©n√©ration des cases √† cocher (Toutes les mati√®res sauf elle-m√™me)
    const sortedSubjects = [...DATA.subjects].sort();
    
    sortedSubjects.forEach(s => {
        if (s !== subjectName) {
            const isChecked = linkedList.includes(s);
            const safeS = s.replace(/'/g, "\\'");
            
            // Cr√©ation de l'√©l√©ment visuel
            const item = document.createElement('label');
            item.style.cssText = `
                display:flex; align-items:center; gap:8px; 
                padding:8px; background:white; border:1px solid #eee; 
                border-radius:4px; cursor:pointer; transition:0.1s;
            `;
            // Effet hover
            item.onmouseover = () => item.style.background = "#ebf5fb";
            item.onmouseout = () => item.style.background = "white";

            item.innerHTML = `
                <input type="checkbox" 
                       ${isChecked ? 'checked' : ''} 
                       onchange="toggleLinkedSubjectInModal('${safeS}')"
                       style="width:16px; height:16px; cursor:pointer;">
                <span style="font-size:0.9rem; color:#2c3e50; font-weight:500;">${s}</span>
            `;
            container.appendChild(item);
        }
    });

    // Affichage
    overlay.style.display = 'flex';
}

function toggleLinkedSubjectInModal(linkedSubject) {
    if (!currentSubjectForLinking) return;
    const m = DATA.subjectMeta[currentSubjectForLinking];
    
    if (!m.linkedSubjects) m.linkedSubjects = [];
    
    const idx = m.linkedSubjects.indexOf(linkedSubject);
    if (idx > -1) {
        m.linkedSubjects.splice(idx, 1);
    } else {
        m.linkedSubjects.push(linkedSubject);
    }
    
    saveData();
    // On ne recharge pas la page ici pour garder la fluidit√© dans la modale
}

function closeLinkedSubjectsModal() {
    document.getElementById('linked-subjects-overlay').style.display = 'none';
    currentSubjectForLinking = "";
    
    // On recharge la liste des mati√®res pour mettre √† jour les compteurs sur les boutons
    renderSubjectsConfig();
}

function sanitizeLegacyData() {
    if (!DATA.eds) return;

    // 1. Dictionnaire des synonymes courants (Minuscule sans accent -> Nom Officiel EDS)
    // Cela permet de faire le lien entre "Maths" (saisi main) et "Math√©matiques" (EDS)
    const aliases = {
        "maths": "Math√©matiques",
        "math": "Math√©matiques",
        "mathematiques": "Math√©matiques",
        "ses": "Sciences √âconomiques et Sociales",
        "eco": "Sciences √âconomiques et Sociales",
        "nsi": "Num√©rique et Sciences Informatiques",
        "si": "Sciences de l'Ing√©nieur",
        "svt": "Sciences de la Vie et de la Terre",
        "bio": "Sciences de la Vie et de la Terre",
        "llce": "LLCE Anglais", // ou autre langue selon votre menu
        "amc": "LLCE Anglais Monde Contempo.",
        "hlp": "Humanit√©s, Litt√©rature et Philosophie",
        "hggsp": "Histoire-G√©o, G√©opolitique & SP",
        "hgg": "Histoire-G√©o, G√©opolitique & SP",
        "geopo": "Histoire-G√©o, G√©opolitique & SP",
        "physique": "Physique-Chimie",
        "pc": "Physique-Chimie"
    };

    // Fonction pour nettoyer une chaine (minuscule, sans accent, sans espace inutile)
    const cleanStr = (str) => str.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();

    console.log("Nettoyage intelligent des doublons EDS...");

    // On parcourt TOUTES les mati√®res existantes du tableau
    DATA.subjects.forEach(subjectName => {
        const cleanName = cleanStr(subjectName);
        
        // On v√©rifie si cette mati√®re correspond √† un EDS actif (via Nom Exact ou Alias)
        ['premiere', 'terminale'].forEach(level => {
            if (DATA.eds[level]) {
                DATA.eds[level].forEach(edsItem => {
                    const cleanEdsName = cleanStr(edsItem.name);
                    
                    // Est-ce que √ßa matche ?
                    // 1. Nom exact nettoy√© (ex: "mathematiques" == "mathematiques")
                    // 2. Via l'alias (ex: "maths" -> "mathematiques" == "mathematiques")
                    const isMatch = (cleanName === cleanEdsName) || 
                                    (aliases[cleanName] === edsItem.name);

                    if (isMatch) {
                        // BINGO ! C'est un doublon. On cache la mati√®re manuelle.
                        if (!DATA.subjectMeta[subjectName]) DATA.subjectMeta[subjectName] = {};
                        
                        // On applique les tags pour la masquer de la grille
                        DATA.subjectMeta[subjectName].isEds = true;
                        DATA.subjectMeta[subjectName].mode = 'level';
                        DATA.subjectMeta[subjectName].parent = "Sp√©cialit√©s";
                        
                        console.log(`Doublon d√©tect√© et corrig√© : "${subjectName}" est li√© √† l'EDS "${edsItem.name}"`);
                    }
                });
            }
        });
    });
}
</script>
</body>
</html>